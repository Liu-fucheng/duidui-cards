<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ•°æ®åº“ç®¡ç†</title>
  <style>
    :root {
      --bg: #F3E9DD;
      --surface: #FAF4EC;
      --text: #5C4033;
      --muted: #D9CBBE;
      --accent: #8B5E3C;
      --success: #4CAF50;
      --warning: #FF9800;
      --danger: #B5534E;
    }

    * { box-sizing: border-box; }
    html, body { 
      background: var(--bg); 
      color: var(--text); 
      font-family: ui-sans-serif, -apple-system, sans-serif; 
      margin: 0;
      padding: 0;
    }
    body { 
      margin: 24px; 
      max-width: 1200px; 
      margin-left: auto; 
      margin-right: auto; 
    }
    h1 { font-size: 28px; margin: 0 0 20px; }
    h2 { font-size: 20px; margin: 20px 0 12px; }
    .card { 
      background: var(--surface); 
      border: 1px solid var(--muted); 
      border-radius: 12px; 
      padding: 20px; 
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
    }
    .btn { 
      display: inline-flex; 
      align-items: center; 
      gap: 6px; 
      padding: 10px 18px; 
      border-radius: 10px; 
      border: 1px solid var(--muted); 
      background: var(--surface); 
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }
    .btn:hover { background: #fff; }
    .btn.primary { background: var(--accent); color: #fff; border-color: var(--accent); }
    .btn.primary:hover { background: #6d4a2e; }
    .btn.danger { background: var(--danger); color: #fff; border-color: var(--danger); }
    .btn.success { background: var(--success); color: #fff; border-color: var(--success); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    input[type="password"], input[type="text"] { 
      padding: 8px 12px; 
      border: 1px solid var(--muted); 
      border-radius: 8px; 
      background: #fff; 
      color: var(--text);
      font-size: 14px;
    }
    
    .flex { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .flex-between { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; }
    
    .status { 
      padding: 12px; 
      border-radius: 8px; 
      margin: 12px 0; 
      font-weight: 500;
    }
    .status.success { background: #e8f5e9; color: #2e7d32; border: 1px solid #4caf50; }
    .status.error { background: #ffebee; color: #c62828; border: 1px solid #f44336; }
    .status.warning { background: #fff3e0; color: #e65100; border: 1px solid #ff9800; }
    .status.info { background: #e3f2fd; color: #1565c0; border: 1px solid #2196f3; }
    
    .hidden { display: none; }
    
    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin: 12px 0;
      background: #fff;
    }
    th, td { 
      padding: 10px; 
      text-align: left; 
      border-bottom: 1px solid #eee; 
    }
    th { 
      font-weight: 600; 
      background: #f9f6f2; 
      color: #7b6558;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin: 2px;
    }
    .badge.success { background: #c8e6c9; color: #2e7d32; }
    .badge.error { background: #ffcdd2; color: #c62828; }
    .badge.warning { background: #ffe0b2; color: #e65100; }
    
    pre {
      background: #f5f5f5;
      padding: 12px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 13px;
      border: 1px solid #ddd;
    }
    
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid var(--muted);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="flex-between">
    <h1>ğŸ—„ï¸ æ•°æ®åº“ç®¡ç†</h1>
    <div class="flex">
      <input type="password" id="adminToken" placeholder="ç®¡ç†å‘˜ Token" style="width:220px;">
      <button class="btn" id="toggleToken">æ˜¾ç¤º</button>
      <button class="btn primary" id="saveToken">ä¿å­˜</button>
    </div>
  </div>

  <div class="card">
    <div class="flex-between">
      <div>
        <h2 style="margin-top: 0;">æ•°æ®åº“çŠ¶æ€</h2>
        <p style="color: #876; margin: 0;">æ£€æŸ¥å½“å‰æ•°æ®åº“è¡¨ç»“æ„å’Œè¿ç§»çŠ¶æ€</p>
      </div>
      <button class="btn primary" id="checkStatus">
        <span>ğŸ”</span>
        <span>æ£€æŸ¥çŠ¶æ€</span>
      </button>
    </div>
    
    <div id="statusResult"></div>
  </div>

  <div class="card">
    <div class="flex-between">
      <div>
        <h2 style="margin-top: 0;">åˆå§‹åŒ–/æ›´æ–°æ•°æ®åº“</h2>
        <p style="color: #876; margin: 0;">åˆ›å»ºç¼ºå¤±çš„è¡¨å’Œåˆ—ï¼Œè¿è¡Œå¿…è¦çš„è¿ç§»</p>
      </div>
      <button class="btn success" id="initDatabase">
        <span>ğŸš€</span>
        <span>åˆå§‹åŒ–æ•°æ®åº“</span>
      </button>
    </div>
    
    <div id="initResult"></div>
  </div>

  <div class="card">
    <h2 style="margin-top: 0;">ğŸ“– è¯´æ˜</h2>
    <ul style="line-height: 1.8; color: #876;">
      <li>é¦–æ¬¡éƒ¨ç½²æ—¶ï¼Œè¯·ç‚¹å‡»"åˆå§‹åŒ–æ•°æ®åº“"åˆ›å»ºæ‰€æœ‰å¿…è¦çš„è¡¨å’Œåˆ—</li>
      <li>å¦‚æœä¸Šä¼ å¤±è´¥æç¤ºç¼ºå°‘åˆ—ï¼Œè¿è¡Œåˆå§‹åŒ–ä¼šè‡ªåŠ¨æ·»åŠ ç¼ºå¤±çš„åˆ—</li>
      <li>æ•°æ®åº“ç»“æ„ä¼šæ ¹æ®ä»£ç è‡ªåŠ¨æ›´æ–°ï¼Œæ— éœ€æ‰‹åŠ¨ç¼–å†™SQL</li>
      <li>æ‰€æœ‰æ“ä½œéƒ½éœ€è¦ç®¡ç†å‘˜Tokenï¼Œè¯·å…ˆä¿å­˜Token</li>
      <li>å»ºè®®åœ¨æ¯æ¬¡æ›´æ–°ä»£ç åæ£€æŸ¥ä¸€æ¬¡æ•°æ®åº“çŠ¶æ€</li>
    </ul>
  </div>

  <script>
    const API_BASE = '/api/init-db';
    
    function getToken() {
      return localStorage.getItem('db_admin_token') || document.getElementById('adminToken').value.trim();
    }
    
    function showStatus(container, message, type = 'info') {
      container.innerHTML = `<div class="status ${type}">${message}</div>`;
    }
    
    function renderStatusResult(status) {
      const container = document.getElementById('statusResult');
      
      let html = '<h3>è¡¨çŠ¶æ€</h3><table>';
      html += '<thead><tr><th>è¡¨å</th><th>çŠ¶æ€</th><th>åˆ—æ•°</th></tr></thead><tbody>';
      
      for (const [tableName, info] of Object.entries(status.tables)) {
        const badge = info.exists 
          ? '<span class="badge success">âœ“ å­˜åœ¨</span>' 
          : '<span class="badge error">âœ— ä¸å­˜åœ¨</span>';
        const columns = info.columns ? info.columns.length : 0;
        html += `<tr><td><code>${tableName}</code></td><td>${badge}</td><td>${columns}</td></tr>`;
      }
      html += '</tbody></table>';
      
      if (status.migrations.length > 0) {
        html += '<h3>éœ€è¦çš„è¿ç§»</h3>';
        html += '<div class="status warning">';
        html += '<strong>âš ï¸ å‘ç°éœ€è¦è¿è¡Œçš„è¿ç§»ï¼š</strong><ul style="margin: 8px 0 0 20px;">';
        status.migrations.forEach(m => {
          html += `<li><code>${m}</code></li>`;
        });
        html += '</ul></div>';
      } else if (status.needsInit) {
        html += '<div class="status warning"><strong>âš ï¸ éœ€è¦åˆå§‹åŒ–æ•°æ®åº“</strong></div>';
      } else {
        html += '<div class="status success"><strong>âœ… æ•°æ®åº“çŠ¶æ€æ­£å¸¸</strong></div>';
      }
      
      container.innerHTML = html;
    }
    
    function renderInitResult(results, newStatus) {
      const container = document.getElementById('initResult');
      
      let html = '<h3>åˆå§‹åŒ–ç»“æœ</h3>';
      
      if (results.tablesCreated.length > 0) {
        html += '<div class="status success">';
        html += '<strong>âœ… åˆ›å»ºçš„è¡¨ï¼š</strong><br>';
        results.tablesCreated.forEach(t => {
          html += `<span class="badge success">${t}</span>`;
        });
        html += '</div>';
      }
      
      if (results.migrationsRun.length > 0) {
        html += '<div class="status success">';
        html += '<strong>âœ… è¿è¡Œçš„è¿ç§»ï¼š</strong><br>';
        results.migrationsRun.forEach(m => {
          html += `<span class="badge success">${m}</span>`;
        });
        html += '</div>';
      }
      
      if (results.errors.length > 0) {
        html += '<div class="status error">';
        html += '<strong>âŒ é”™è¯¯ï¼š</strong><ul style="margin: 8px 0 0 20px;">';
        results.errors.forEach(e => {
          html += `<li>${e.table || e.migration}: ${e.error}</li>`;
        });
        html += '</ul></div>';
      }
      
      if (results.tablesCreated.length === 0 && results.migrationsRun.length === 0 && results.errors.length === 0) {
        html += '<div class="status info"><strong>â„¹ï¸ æ•°æ®åº“å·²æ˜¯æœ€æ–°çŠ¶æ€ï¼Œæ— éœ€æ›´æ”¹</strong></div>';
      }
      
      // æ˜¾ç¤ºæ›´æ–°åçš„çŠ¶æ€
      if (newStatus) {
        html += '<h3>æ›´æ–°åçš„çŠ¶æ€</h3>';
        html += '<table><thead><tr><th>è¡¨å</th><th>çŠ¶æ€</th></tr></thead><tbody>';
        for (const [tableName, info] of Object.entries(newStatus.tables)) {
          const badge = info.exists 
            ? '<span class="badge success">âœ“ å­˜åœ¨</span>' 
            : '<span class="badge error">âœ— ä¸å­˜åœ¨</span>';
          html += `<tr><td><code>${tableName}</code></td><td>${badge}</td></tr>`;
        }
        html += '</tbody></table>';
        
        if (newStatus.migrations.length === 0 && !newStatus.needsInit) {
          html += '<div class="status success"><strong>âœ… æ•°æ®åº“çŠ¶æ€æ­£å¸¸</strong></div>';
        }
      }
      
      container.innerHTML = html;
    }
    
    // æ£€æŸ¥çŠ¶æ€
    document.getElementById('checkStatus').addEventListener('click', async () => {
      const btn = document.getElementById('checkStatus');
      const container = document.getElementById('statusResult');
      
      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span><span>æ£€æŸ¥ä¸­...</span>';
      
      try {
        const res = await fetch(API_BASE);
        const data = await res.json();
        
        if (data.success) {
          renderStatusResult(data.status);
        } else {
          showStatus(container, `âŒ ${data.message}`, 'error');
        }
      } catch (e) {
        showStatus(container, `âŒ æ£€æŸ¥å¤±è´¥: ${e.message}`, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<span>ğŸ”</span><span>æ£€æŸ¥çŠ¶æ€</span>';
      }
    });
    
    // åˆå§‹åŒ–æ•°æ®åº“
    document.getElementById('initDatabase').addEventListener('click', async () => {
      const token = getToken();
      if (!token) {
        alert('è¯·å…ˆè¾“å…¥å¹¶ä¿å­˜ç®¡ç†å‘˜Token');
        return;
      }
      
      if (!confirm('ç¡®å®šè¦åˆå§‹åŒ–/æ›´æ–°æ•°æ®åº“å—ï¼Ÿ\n\nè¿™å°†åˆ›å»ºç¼ºå¤±çš„è¡¨å’Œåˆ—ï¼Œè¿è¡Œå¿…è¦çš„è¿ç§»ã€‚')) {
        return;
      }
      
      const btn = document.getElementById('initDatabase');
      const container = document.getElementById('initResult');
      
      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span><span>åˆå§‹åŒ–ä¸­...</span>';
      showStatus(container, 'â³ æ­£åœ¨åˆå§‹åŒ–æ•°æ®åº“ï¼Œè¯·ç¨å€™...', 'info');
      
      try {
        const res = await fetch(API_BASE, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        const data = await res.json();
        
        if (data.success) {
          renderInitResult(data.results, data.status);
          // è‡ªåŠ¨åˆ·æ–°çŠ¶æ€
          setTimeout(() => {
            document.getElementById('checkStatus').click();
          }, 500);
        } else {
          showStatus(container, `âŒ ${data.message}`, 'error');
        }
      } catch (e) {
        showStatus(container, `âŒ åˆå§‹åŒ–å¤±è´¥: ${e.message}`, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<span>ğŸš€</span><span>åˆå§‹åŒ–æ•°æ®åº“</span>';
      }
    });
    
    // Tokenç®¡ç†
    document.getElementById('toggleToken').addEventListener('click', () => {
      const el = document.getElementById('adminToken');
      el.type = el.type === 'password' ? 'text' : 'password';
    });
    
    document.getElementById('saveToken').addEventListener('click', () => {
      const token = document.getElementById('adminToken').value.trim();
      if (token) {
        localStorage.setItem('db_admin_token', token);
        alert('âœ… Tokenå·²ä¿å­˜');
      } else {
        alert('è¯·è¾“å…¥Token');
      }
    });
    
    // åˆå§‹åŒ–
    (function init() {
      const saved = localStorage.getItem('db_admin_token');
      if (saved) {
        document.getElementById('adminToken').value = saved;
      }
      
      // è‡ªåŠ¨æ£€æŸ¥çŠ¶æ€
      document.getElementById('checkStatus').click();
    })();
  </script>
</body>
</html>

