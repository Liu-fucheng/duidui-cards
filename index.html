<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è§’è‰²å¡ä¸Šä¼ </title>
  
  <!-- Material UI CSS -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  
  <style>
    :root {
      --bg: #F3E9DD;        /* æ·¡ç±³æ£• */
      --surface: #FAF4EC;   /* æµ…é¢æ¿ */
      --text: #5C4033;      /* æ·±å’– */
      --muted: #D9CBBE;     /* æµ…åˆ†å‰² */
      --accent: #8B5E3C;    /* å’–å•¡ä¸»è‰² */
      --accent-2: #6D4C3D;  /* æŒ‰ä¸‹æ›´æ·±è‰² */
      --pill-bg: #EADFD2;   /* Tag æœªé€‰èƒŒæ™¯ */
    }

    html, body {
      background: var(--bg);
      color: var(--text);
      font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, PingFang SC, Hiragino Sans GB, Microsoft YaHei, Helvetica Neue, Arial, Noto Sans, "Noto Sans CJK SC", sans-serif;
    }

    body {
      margin: 24px;
      max-width: 860px;
      margin-left: auto;
      margin-right: auto;
    }

    .hidden { display: none; }

    h1 {
      font-size: 28px;
      margin: 8px 0 20px;
      letter-spacing: 0.5px;
    }

    h2 {
      font-size: 20px;
      margin: 24px 0 12px;
      letter-spacing: 0.2px;
    }

    /* é¡¶éƒ¨å¯¼èˆª/é¡µè„š */
    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #F7EFE6;
      border: 1px solid var(--muted);
      border-radius: 12px;
      padding: 10px 14px;
      margin-bottom: 16px;
    }
    .brand { font-weight: 700; color: var(--accent-2); letter-spacing: 0.5px; }
    .nav-actions { display: flex; gap: 10px; align-items: center; }
    .link { color: var(--accent); text-decoration: none; padding: 6px 8px; border-radius: 8px; }
    .link:hover { background: var(--pill-bg); }

    .app-footer {
      margin-top: 20px;
      padding: 12px 0;
      color: #9A8274;
      font-size: 13px;
      text-align: center;
      border-top: 1px dashed var(--muted);
    }

    /* æ­¥éª¤æŒ‡ç¤ºå™¨ */
    .steps {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      position: relative;
    }
    .steps::before {
      content: "";
      position: absolute;
      top: 16px;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--muted);
      z-index: 0;
    }
    .step {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      position: relative;
      z-index: 1;
      flex: 1;
    }
    .step-circle {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--surface);
      border: 2px solid var(--muted);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: var(--text);
      transition: all 0.2s ease;
    }
    .step.active .step-circle {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
      box-shadow: 0 0 0 4px rgba(139,94,60,0.12);
    }
    .step.completed .step-circle {
      background: var(--accent-2);
      border-color: var(--accent-2);
      color: #fff;
    }
    .step-label {
      font-size: 12px;
      color: #9A8274;
    }
    .step.active .step-label {
      color: var(--accent-2);
      font-weight: 600;
    }

    form {
      background: var(--surface);
      border: 1px solid var(--muted);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .field {
      margin-bottom: 14px;
      padding-bottom: 12px;
      border-bottom: 1px dashed var(--muted);
    }

    .field:last-child {
      border-bottom: none;
      padding-bottom: 0;
      margin-bottom: 0;
    }

    .field > label.group-label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
    }

    /* è¡Œå†…å­—æ®µï¼šæ ‡ç­¾ä¸è¾“å…¥åŒä¸€è¡Œï¼Œå¹¶é™åˆ¶è¾“å…¥å®½åº¦è¾ƒçŸ­ */
    .inline-field { display: flex; align-items: center; gap: 10px; flex-wrap: nowrap; }
    .inline-field .group-label { margin: 0; display: inline-block; white-space: nowrap; }
    .short-input { width: 220px; max-width: 60vw; }


    input[type="text"], textarea, select {
      width: 100%;
      padding: 10px 12px;
      box-sizing: border-box;
      color: var(--text);
      background: #fff;
      border: 1px solid var(--muted);
      border-radius: 8px;
      outline: none;
    }
    #tagsSearch {
      padding: 10px 12px 10px 30px;
    }
    
    input[type="text"]:focus, textarea:focus, select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(139,94,60,0.12);
    }

    textarea {
      min-height: 100px;
      max-height: calc(1.5em * 20 + 24px); /* å¤§çº¦20è¡Œ + å†…è¾¹è· */
      overflow: auto;
      resize: vertical;
    }

    /* è¡Œå†…é€‰é¡¹å¸ƒå±€ - ä½¿ç”¨ç³»ç»Ÿæ§ä»¶ + å’–å•¡è‰² */
    .inline-options {
      display: flex;
      flex-wrap: wrap;
      gap: 8px 12px;
      align-items: center;
    }

    /* ç»Ÿä¸€åŸç”Ÿæ§ä»¶é¢œè‰²ä¸ºå’–å•¡è‰²ï¼Œé¿å…é»˜è®¤è“è‰² */
    .inline-options input[type="checkbox"],
    .inline-options input[type="radio"] {
      accent-color: var(--accent);
      width: 22px;
      height: 22px;
    }
    .inline-options label { display: inline-flex; align-items: center; gap: 6px; white-space: nowrap; }

    /* å…¼å®¹ä»»æ„ UI åº“ç±»åï¼ˆè‹¥å­˜åœ¨ï¼‰ */
    .MuiCheckbox-root, .MuiRadio-root { color: var(--accent) !important; }
    .MuiCheckbox-root.Mui-checked, .MuiRadio-root.Mui-checked { color: var(--accent) !important; }
    .MuiFormControlLabel-root { margin-right: 8px !important; }

    /* Tag èƒ¶å›ŠæŒ‰é’® */
    .pill-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .pill {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      height: 36px;
      padding: 0 14px;
      border-radius: 999px;
      border: 1px solid var(--muted);
      background: var(--pill-bg);
      color: var(--text);
      cursor: pointer;
      transition: background 0.15s ease, box-shadow 0.15s ease, border-color 0.15s ease;
      overflow: hidden;
      user-select: none;
    }
    .pill-lg { height: 42px; padding: 0 18px; font-size: 16px; font-weight: 600; }
    .category-line { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; margin-bottom: 6px; }
    .category-sep { color: #876; margin: 0 4px; }
    .pill:hover { border-color: var(--accent); }
    .pill:active { background: #E4D6C6; }
    input[type="checkbox"].pill-input { position: absolute; opacity: 0; pointer-events: none; }
    input[type="checkbox"].pill-input:checked + label.pill {
      background: #DFCDBB;
      border-color: var(--accent);
      box-shadow: inset 0 0 0 2px rgba(139,94,60,0.18);
    }

    /* æäº¤æŒ‰é’® */
    .btn-primary {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      font-size: 16px;
      color: #fff;
      background: var(--accent);
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.15s ease, box-shadow 0.15s ease;
      overflow: hidden;
    }
    .btn-primary:hover { box-shadow: 0 2px 10px rgba(139,94,60,0.25); }
    .btn-primary:active { background: var(--accent-2); }
    .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; box-shadow: none; }

    #uploadStatus {
      font-weight: 600;
      margin-top: 15px;
      padding: 10px;
      color: var(--accent-2);
    }

    /* åˆ—è¡¨å¡ç‰‡ */
    #cardList {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 14px;
    }
    .card {
      background: var(--surface);
      border: 1px solid var(--muted);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .card h3 { margin: 4px 0 6px; font-size: 18px; }
    .card p { margin: 4px 0; line-height: 1.5; }

    /* ç®€æ˜“ Material é£æ ¼ Ripple */
    .ripple { position: relative; overflow: hidden; }
    .ripple::after {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: radial-gradient(circle, rgba(255,255,255,0.35) 10%, rgba(255,255,255,0) 11%) center/0 0 no-repeat;
      transition: background-size 0.45s ease, opacity 0.6s ease;
      opacity: 0;
    }
    .ripple:active::after {
      background-size: 3000% 3000%;
      opacity: 1;
      transition: 0s;
    }

    /* ä¸¤åˆ—è¡Œå¸ƒå±€ï¼ˆå¡ç‰‡ç±»å‹ + å¡åï¼‰ */
    .row-2 {
      display: grid;
      grid-template-columns: minmax(260px, 1fr) 1.2fr;
      gap: 16px;
      align-items: start;
    }
    @media (max-width: 640px) {
      .row-2 { grid-template-columns: 1fr; }
    }

    /* Discord é£æ ¼çš„é¢„è§ˆå¡ç‰‡ */
    .discord-preview {
      background: #313338;
      border-radius: 12px;
      padding: 20px;
      color: #dbdee1;
      font-family: 'gg sans', 'Noto Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      margin-top: 32px;
    }
    
    .discord-preview h3 {
      color: #f2f3f5;
      font-size: 16px;
      font-weight: 600;
      margin: 0 0 12px 0;
      padding-bottom: 8px;
      border-bottom: 1px solid #3f4147;
    }
    
    .discord-thread {
      background: #2b2d31;
      border-radius: 4px;
      overflow: hidden;
    }
    
    .discord-message {
      padding: 12px 16px;
      position: relative;
    }
    
    .discord-message:hover {
      background: #2e3035;
    }
    
    .discord-author {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }
    
    .discord-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #5865f2, #7289da);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 18px;
      flex-shrink: 0;
      overflow: hidden;
    }
    
    .discord-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .discord-username {
      font-weight: 500;
      color: #f2f3f5;
      font-size: 15px;
    }
    
    .discord-timestamp {
      font-size: 12px;
      color: #949ba4;
      margin-left: 4px;
    }
    
    .discord-content {
      color: #dbdee1;
      font-size: 14px;
      line-height: 1.5;
      margin-left: 52px;
    }
    
    .discord-field {
      margin-bottom: 6px;
    }
    
    .discord-field-label {
      font-weight: 600;
      color: #f2f3f5;
    }
    
    .discord-field-value {
      color: #b5bac1;
    }
    
    .discord-like-count {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-top: 8px;
      padding: 4px 8px;
      background: #404249;
      border-radius: 12px;
      font-size: 13px;
      color: #dbdee1;
    }
    
    .preview-placeholder {
      color: #6d6f78;
      font-style: italic;
      font-size: 13px;
    }
    
    .discord-images {
      margin-top: 12px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 8px;
    }
    
    .discord-image {
      border-radius: 4px;
      overflow: hidden;
      max-width: 100%;
    }
    
    .discord-image img {
      width: 100%;
      height: auto;
      display: block;
      border-radius: 4px;
    }

    /* è§’è‰²åèƒ¶å›Šï¼ˆå¤ç”¨ tag pill æ ·å¼ï¼Œå¯ç¼–è¾‘å¯åˆ é™¤ï¼‰ */
    .chip-list { 
      display: flex; 
      flex-wrap: wrap; 
      gap: 10px; 
    }
    .chip-row { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    .character-chip {
      position: relative;
      display: inline-flex;
      align-items: center;
      height: 36px;
      min-width: 100px;
      border-radius: 999px;
      border: 1px solid var(--muted);
      background: linear-gradient(0deg, var(--pill-bg), var(--pill-bg)) padding-box, transparent border-box; /* å›ºå®šä¸€è‡´èƒŒæ™¯ */
      overflow: hidden;
    }
    .character-chip input {
      border: none;
      background: transparent;
      outline: none;
      color: var(--text);
      padding: 0 12px; /* å·¦å³å¯¹ç§°ï¼Œæ˜¾å‡ºå¼€å¤´æ–‡å­— */
      margin-right: 28px; /* ç»™åˆ é™¤æŒ‰é’®ç•™å‡ºç©ºé—´ */
      height: 100%;
      min-width: 80px; /* é»˜è®¤æ›´çª„çš„æœ€å°å®½ */
      width: 80px; /* åˆå§‹å®½åº¦ï¼Œåç»­ç”¨ JS ç²¾ç¡®è®¾ç½® */
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      box-shadow: none; /* é¿å…å…¨å±€ input:focus é˜´å½±åœ¨èƒ¶å›Šå†…å½¢æˆæµ…æ£•åˆ†å‰² */
    }
    .character-chip input:focus { background: transparent; box-shadow: none !important; }
    /* å»æ‰æµ…æ£•è‰²åˆ†å‰²æ•ˆæœï¼Œæ”¹ä¸ºå¤–åœˆè¾¹æ¡†é«˜äº® */
    .character-chip:focus-within { box-shadow: 0 0 0 0 rgba(0,0,0,0); border-color: var(--accent); }
    .character-chip .delete-btn {
      position: absolute;
      right: 6px;
      top: 50%;
      transform: translateY(-50%);
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: var(--accent);
      color: #fff;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      line-height: 1;
      opacity: 0.8;
      transition: opacity 0.15s ease;
      padding: 0;
    }
    .character-chip .delete-btn:hover { opacity: 1; background: var(--accent-2); }

    .add-chip-btn {
      width: 36px; height: 36px; border-radius: 50%; border: none; cursor: pointer; color: #fff;
      background: var(--accent); display: inline-flex; align-items: center; justify-content: center;
      font-size: 20px; line-height: 1; box-shadow: 0 2px 8px rgba(139,94,60,0.25);
    }
    .add-chip-btn:active { background: var(--accent-2); }

    /* æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ */
    .upload-zone {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: flex-start;
    }
    .upload-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      height: 36px;
      padding: 0 14px;
      border-radius: 18px;
      border: none;
      background: var(--accent);
      color: #fff;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.15s ease;
    }
    .upload-btn:hover { background: var(--accent-2); }
    .upload-thumbnail {
      position: relative;
      width: 140px;
      height: 140px;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid var(--muted);
    }
    .upload-thumbnail img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .upload-thumbnail .remove {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--accent);
      color: #fff;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      opacity: 0.9;
    }
    .upload-thumbnail .remove:hover { opacity: 1; background: var(--accent-2); }
    input[type="file"] { display: none; }

    /* é¢„è§ˆåŒºåŸŸä½¿ç”¨ Gridï¼Œä¼˜å…ˆæ¨ªæ’ï¼Œç©ºé—´ä¸è¶³å†æ¢è¡Œ */
    .preview-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 16px;
      align-items: start;
      width: 100%;
    }

    /* Tags åˆ†ç±»å’Œæœç´¢ */
    .tags-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: nowrap; gap: 12px; }
    .tags-header .group-label { white-space: nowrap; margin: 0; }
    .tags-search-wrapper {
      position: relative;
      width: 160px;
      margin-left: auto;
    }
    .tags-search-icon {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: #9A8274;
      font-size: 18px;
      pointer-events: none;
    }
    .tags-search { 
      width: 100%;
      padding: 8px 12px 8px 40px; 
      border: 1px solid var(--muted); 
      border-radius: 20px; 
      outline: none;
      font-size: 13px;
      background: #fff;
      transition: all 0.2s ease;
    }
    .tags-search:focus { 
      border-color: var(--accent); 
      box-shadow: 0 0 0 3px rgba(139,94,60,0.12); 
    }
    .tag-category { margin-bottom: 14px; }
    .tag-category-title { 
      font-size: 13px; 
      color: #876; 
      margin-bottom: 6px; 
      font-weight: 500;
    }
    .tag-category .pill-group { margin-left: 8px; }
    .tag-category.hidden { display: none; }

    /* é”å®šæ ·å¼ */
    .locked { 
      background: #F0EAE3 !important; 
      cursor: not-allowed !important;
    }

    /* éšè—çš„ authorId å­—æ®µ */
    #authorId { display: none; }
  </style>
</head>
<body>

  <header class="app-header">
    <div class="brand">å †å †demo</div>
    <nav class="nav-actions">
      <a class="link" href="#upload" id="navUpload">è§’è‰²å¡ä¸Šä¼ </a>
    </nav>
  </header>

  <!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
  <div class="steps">
    <div class="step active" data-step="1" id="step1">
      <div class="step-circle">1</div>
      <div class="step-label">åŸºç¡€ä¿¡æ¯</div>
    </div>
    <div class="step" data-step="2" id="step2">
      <div class="step-circle">2</div>
      <div class="step-label">åˆ†ç±»æ ‡ç­¾</div>
    </div>
    <div class="step" data-step="3" id="step3">
      <div class="step-circle">3</div>
      <div class="step-label">æ–‡ä»¶ä¸Šä¼ </div>
    </div>
  </div>

  <h1 id="upload">ä¸Šä¼ ä½ çš„è§’è‰²å¡</h1>
  
  <form id="uploadForm">

    <div id="section-base" class="field">
      <div class="inline-field" style="margin-top:0;">
        <label class="group-label" for="category">åˆ†åŒº:</label>
        <input type="text" id="category" name="category" class="short-input" />
      </div>
      <div class="inline-field" style="margin-top:10px; align-items:center; gap:16px; flex-wrap:nowrap;">
        <label class="group-label">ä½œè€…:</label>
        <div class="inline-options" style="flex-wrap:nowrap;">
          <label><input type="radio" name="authorType" value="real" checked class="mui-radio"> å®å</label>
          <label><input type="radio" name="authorType" value="anonymous" class="mui-radio"> åŒ¿å</label>
        </div>
        <input type="text" id="authorName" name="authorName" class="short-input" />
        <input type="hidden" id="authorId" name="authorId" />
      </div>
      <div class="inline-field" style="margin-top:10px; justify-content:space-between;">
        <div style="display:flex; align-items:center; gap:10px;">
          <label class="group-label">ç±»å‹*:</label>
          <div class="inline-options">
            <label><input type="radio" name="cardType" value="single" checked class="mui-radio"> å•äººå¡</label>
            <label><input type="radio" name="cardType" value="multi" class="mui-radio"> å¤šäººå¡</label>
          </div>
        </div>
        <div id="nameRelationGroup" class="inline-options">
          <span class="group-label" style="margin:0;">è§’è‰²ä¸å¡</span>
          <label><input type="radio" name="nameRelation" value="same" checked class="mui-radio"> åŒå</label>
          <label><input type="radio" name="nameRelation" value="different" class="mui-radio"> ä¸åŒå</label>
        </div>
      </div>
      <div class="inline-field" style="margin-top:10px;">
        <label class="group-label" for="cardName">å¡å:</label>
        <input type="text" id="cardName" name="cardName" class="short-input" required />
      </div>
    </div>

    <div id="singleCharacterContainer" class="field hidden">
      <div class="inline-field" style="margin-top:0;">
        <label class="group-label" for="singleCharacterName">è§’è‰²å:</label>
        <input type="text" id="singleCharacterName" name="characters" class="short-input" placeholder="è§’è‰²å" />
      </div>
    </div>
    
    <div id="multiCharactersContainer" class="field hidden">
      <label class="group-label">è§’è‰²å:</label>
      <div class="chip-row" style="margin-top:6px;">
        <div id="characterList" class="chip-list"><!-- åŠ¨æ€ç”Ÿæˆèƒ¶å›Šè¾“å…¥ --></div>
        <button type="button" id="addCharacterBtn" class="add-chip-btn" title="å¢åŠ è§’è‰²">+</button>
      </div>
    </div>
    
    <!-- ä½œè€…ç±»å‹å·²åˆå¹¶åˆ°ä½œè€…è¡Œ -->

    <div id="section-tags">
      <div id="customSectionsHost">
        <!-- è‡ªå®šä¹‰æ¿å—å°†é€šè¿‡ JavaScript åŠ¨æ€æ·»åŠ  -->
      </div>
    </div>

    <div class="field">
      <div class="tags-header">
        <label class="group-label">Tags</label>
        <div class="tags-search-wrapper">
          <span class="tags-search-icon material-icons">search</span>
          <input type="text" class="tags-search" id="tagsSearch" placeholder="æœç´¢...">
        </div>
      </div>
      <div id="tagsOptions">
        <!-- åŠ¨æ€ä»é…ç½®åŠ è½½åˆ†ç±» -->
    </div>
    </div>
    

    <div class="field">
      <label class="group-label" for="warnings">æ’é›·:</label>
      <textarea id="warnings" name="warnings"></textarea>
    </div>

    <div class="field">
      <label class="group-label" for="description">ç®€ä»‹:</label>
      <textarea id="description" name="description"></textarea>
    </div>

    <div class="field">
      <label class="group-label" for="otherInfo">å…¶å¥¹:</label>
      <textarea id="otherInfo" name="otherInfo" placeholder="å¯åœ¨æ­¤å¤„å¡«å†™è‡´è°¢æˆ–å…¶å¥¹ä½ æƒ³è¦æ˜¾ç¤ºåœ¨ä¸»æ¥¼çš„æ–‡å­—"></textarea>
    </div>

    <div class="field">
      <label class="group-label">ä¸‹è½½å‰äºŒæ¬¡æ’é›·:</label>
      <div class="inline-options">
        <label><input type="radio" name="secondaryWarningToggle" value="no" checked class="mui-radio"> å¦</label>
        <label><input type="radio" name="secondaryWarningToggle" value="yes" class="mui-radio"> æ˜¯</label>
      </div>
    </div>
    <div id="secondaryWarningContainer" class="field hidden">
      <label class="group-label" for="secondaryWarning">äºŒæ¬¡æ’é›·å†…å®¹:</label>
      <textarea id="secondaryWarning" name="secondaryWarning"></textarea>
    </div>

    <div id="section-files" class="field">
      <label class="group-label">å¤´åƒ (é€‰å¡«ï¼Œä¸å¡«åˆ™ä½¿ç”¨è§’è‰²å¡PNGæˆ–é»˜è®¤å›¾æ ‡):</label>
      <input type="file" id="avatarImage" name="avatarImage" accept="image/*" />
      <div class="upload-zone">
        <button type="button" class="upload-btn" onclick="document.getElementById('avatarImage').click()">+ é€‰æ‹©å¤´åƒ</button>
        <div id="avatarPreviews" class="preview-grid"></div>
      </div>
    </div>

    <div class="field">
      <label class="group-label">ä¸»æ¥¼å›¾ç‰‡ (å¯å¤šå›¾):</label>
      <input type="file" id="galleryImages" name="galleryImages" multiple accept="image/*" />
      <div class="upload-zone">
        <button type="button" class="upload-btn" onclick="document.getElementById('galleryImages').click()">+ æ·»åŠ å›¾ç‰‡</button>
        <div id="galleryPreviews" class="preview-grid"></div>
      </div>
    </div>

    <div class="field">
      <label class="group-label">è§’è‰²å¡ PNG (.pngï¼ŒäºŒé€‰ä¸€):</label>
      <input type="file" id="cardPngFile" name="cardPngFile" accept=".png" />
      <div class="upload-zone">
        <button type="button" class="upload-btn" onclick="document.getElementById('cardPngFile').click()">+ é€‰æ‹©PNGæ–‡ä»¶</button>
        <div id="cardPngPreviews" class="preview-grid"></div>
      </div>
    </div>

    <div class="field">
      <label class="group-label">è§’è‰²å¡ JSON (.jsonï¼ŒäºŒé€‰ä¸€):</label>
      <input type="file" id="cardJsonFile" name="cardJsonFile" accept=".json" />
      <div class="upload-zone">
        <button type="button" class="upload-btn" onclick="document.getElementById('cardJsonFile').click()">+ é€‰æ‹©JSONæ–‡ä»¶</button>
        <div id="cardJsonPreviews" class="preview-grid"></div>
      </div>
    </div>

    <div class="field">
      <label class="group-label">å…¶å®ƒé™„ä»¶ (å¯å¤šå›¾):</label>
      <input type="file" id="attachments" name="attachments" multiple />
      <div class="upload-zone">
        <button type="button" class="upload-btn" onclick="document.getElementById('attachments').click()">+ æ·»åŠ é™„ä»¶</button>
        <div id="attachmentPreviews" class="preview-grid"></div>
      </div>
    </div>

    <button type="submit" id="submitButton" class="btn-primary ripple">ä¸Šä¼ </button>
  </form>

  <div id="uploadStatus"></div>

  <!-- Discord é¢„è§ˆ -->
  <div class="discord-preview">
    <h3>ğŸ“± Discord é¢„è§ˆ</h3>
    <div class="discord-thread">
      <div class="discord-message">
        <div class="discord-author">
          <div class="discord-avatar" id="previewAvatar">
            <img src="https://discord.com/assets/18e336a74a159cfd.png" alt="é»˜è®¤å¤´åƒ">
          </div>
          <div>
            <span class="discord-username" id="previewUsername">åŒ¿å</span>
            <span class="discord-timestamp">ä»Šå¤©</span>
          </div>
        </div>
        <div class="discord-content">
          <div class="discord-field" id="previewLikeSection" style="display: none;">
            <span class="discord-like-count">
              <span>â¤ï¸</span>
              <span>èµæ•°ï¼š<span id="previewLikes">0</span></span>
            </span>
          </div>
          
          <!-- å¡åï¼ˆä¸æ˜¾ç¤ºå‰ç¼€ï¼‰ -->
          <div class="discord-field" id="previewCardNameField">
            <span class="discord-field-value" id="previewCardName">
              <span class="preview-placeholder">æœªå¡«å†™å¡å</span>
            </span>
          </div>
          
          <!-- ä½œè€… -->
          <div class="discord-field">
            <span class="discord-field-label">ä½œè€…ï¼š</span>
            <span class="discord-field-value" id="previewVest">åŒ¿å</span>
          </div>
          
          <!-- æ€§å‘ -->
          <div class="discord-field" id="previewOrientationField" style="display: none;">
            <span class="discord-field-label">æ€§å‘ï¼š</span>
            <span class="discord-field-value" id="previewOrientation">
              <span class="preview-placeholder">æœªé€‰æ‹©</span>
            </span>
          </div>
          
          <!-- Tags -->
          <div class="discord-field" id="previewTagsField" style="display: none;">
            <span class="discord-field-label">Tagsï¼š</span>
            <span class="discord-field-value" id="previewTags">
              <span class="preview-placeholder">æœªé€‰æ‹©</span>
            </span>
          </div>
          
          <!-- æ’é›· -->
          <div class="discord-field">
            <span class="discord-field-label">æ’é›·ï¼š</span>
            <span class="discord-field-value" id="previewWarnings">
              <span class="preview-placeholder">æœªå¡«å†™</span>
            </span>
          </div>
          
          <!-- å…¶å¥¹ -->
          <div class="discord-field" id="previewOtherInfoField" style="display: none;">
            <span class="discord-field-value" id="previewOtherInfo"></span>
          </div>
          
          <!-- ä¸»æ¥¼å›¾ç‰‡ -->
          <div id="previewImagesContainer" style="display: none;">
            <div class="discord-images" id="previewImages"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer class="app-footer">
    Â© 2025 å †å †Demo
  </footer>

<!-- Material UI JS (ä½¿ç”¨ CDN) -->
<script src="https://unpkg.com/@mui/material@5.15.0/umd/material-ui.production.min.js"></script>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

<script>
  // --- å…¨å±€é…ç½®ï¼ˆä»æœåŠ¡ç«¯åŠ è½½ï¼‰ ---
  let CONFIG = {};
  let TOKEN_DATA = null; // å­˜å‚¨TokenéªŒè¯åçš„ç”¨æˆ·æ•°æ®

  // éªŒè¯Tokenå¹¶è·å–ç”¨æˆ·ä¿¡æ¯
  async function verifyToken(token) {
    try {
      const response = await fetch(`/api/token?token=${token}`);
      const data = await response.json();
      
      if (data.success) {
        TOKEN_DATA = data.data;
        console.log('TokenéªŒè¯æˆåŠŸ:', TOKEN_DATA);
        return true;
      } else {
        console.error('TokenéªŒè¯å¤±è´¥:', data.message);
        alert(`TokenéªŒè¯å¤±è´¥: ${data.message}\nè¯·è”ç³»ç®¡ç†å‘˜è·å–æ–°çš„å‘å¡é“¾æ¥ã€‚`);
        return false;
      }
    } catch (error) {
      console.error('TokenéªŒè¯é”™è¯¯:', error);
      alert('TokenéªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–è”ç³»ç®¡ç†å‘˜ã€‚');
      return false;
    }
  }

  // æ ‡è®°Tokenä¸ºå·²ä½¿ç”¨
  async function markTokenAsUsed(token) {
    try {
      await fetch('/api/token', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token })
      });
    } catch (error) {
      console.error('æ ‡è®°Tokenå¤±è´¥:', error);
    }
  }

  // å°è¯•ä»æœåŠ¡ç«¯åŠ è½½é…ç½®
  async function loadConfig() {
    try {
      const response = await fetch('/api/config');
      const data = await response.json();
      if (data.success) {
        CONFIG = data.config;
      }
    } catch (error) {
      console.error('é…ç½®åŠ è½½å¤±è´¥', error);
    }
    renderOptions();
  }

  // æ¸²æŸ“é€‰é¡¹ï¼ˆä½¿ç”¨ç®€å•çš„ checkboxï¼ŒMaterial UI æ ·å¼ä¼šè‡ªåŠ¨åº”ç”¨ï¼‰
  function renderOptions() {
    // å…œåº•ï¼šç¡®ä¿ CONFIG æœ‰å¿…è¦çš„æ•°ç»„
    if (!CONFIG.tagCategories) CONFIG.tagCategories = [];
    
    // è‡ªå®šä¹‰æ¿å—ï¼ˆæŒ‰ sections é¡ºåºæ¸²æŸ“ï¼‰
    const secHost = document.getElementById('customSectionsHost');
    if (secHost) {
      const sections = Array.isArray(CONFIG.customSections) ? CONFIG.customSections : [];
      const order = Array.isArray(CONFIG.sections) ? CONFIG.sections : [];
      const htmls = [];
      order.forEach(key => {
        if (key === 'partition') return; // partition ä¸åœ¨è¿™é‡Œæ˜¾ç¤º
        if (key.startsWith('custom:')) {
          const title = key.slice(7);
          const sec = sections.find(s => s && s.title === title);
          if (!sec) return;
          const inputType = sec.multiple === false ? 'radio' : 'checkbox';
          const items = (sec.items || []).map((it, i) => {
            const name = sec.multiple === false ? `custom_${title}` : `custom_${title}[]`;
            const showIf = it.enableIf ? `data-showif="${it.enableIf}"` : '';
            const mutex = it.mutexWith && it.mutexWith.length ? `data-mutex="${it.mutexWith.join(',')}"` : '';
            return `<label class="option-item" ${showIf}><input type="${inputType}" name="${name}" value="${it.value}" ${mutex}> ${it.label}</label>`;
          }).join('');
          const fieldId = `section_${title.replace(/\s/g,'_')}`;
          const showIf = sec.showIf ? `data-showif="${sec.showIf}"` : '';
          htmls.push(`<div class="field" id="${fieldId}" ${showIf}><label class="group-label">${sec.title}:</label><div class="inline-options">${items}</div></div>`);
        }
      });
      secHost.innerHTML = htmls.join('');
      
      // ç»‘å®šä¾èµ–ä¸äº’æ–¥é€»è¾‘
      bindConditionalLogic();
    }

    // Tags åˆæ¬¡æ¸²æŸ“
    renderTagsByPartition();

    // ç›‘å¬åˆ†åŒºå˜åŒ–ï¼Œå®æ—¶åˆ‡æ¢æ ‡ç­¾é›†åˆ
    const categoryInput = document.getElementById('category');
    if (categoryInput) {
      categoryInput.addEventListener('input', () => {
        // é˜²æŠ–ï¼šé¿å…ç¬¬ä¸‰æ–¹è„šæœ¬è§¦å‘é¢‘ç¹æ¸²æŸ“å¯¼è‡´å¡é¡¿
        clearTimeout(window.__renderTagsDebounce);
        window.__renderTagsDebounce = setTimeout(() => {
          renderTagsByPartition();
        }, 120);
      }, { passive: true });
    }
  }

  function renderTagsByPartition() {
    const tagsOptions = document.getElementById('tagsOptions');
    if (!tagsOptions) return;
    let tagIndex = 0;

    const categories = getEffectiveCategories();
    console.log('å‡†å¤‡æ¸²æŸ“ tags åˆ†ç±»æ•°é‡:', categories.length, categories);
    tagsOptions.innerHTML = categories.map((cat) => {
      const catShowIf = cat.showIf ? `data-showif="${cat.showIf}"` : '';
      const catMutex = cat.mutexWith && cat.mutexWith.length ? `data-mutex="${cat.mutexWith.join(',')}"` : '';
      
      // å­æ ‡ç­¾
      const subPills = (cat.tags || []).map(opt => {
        const id = `tag${tagIndex++}`;
        const val = (opt.value || opt.label);
        const showIf = opt.showIf ? `data-showif="${opt.showIf}"` : '';
        const mutex = opt.mutexWith && opt.mutexWith.length ? `data-mutex="${opt.mutexWith.join(',')}"` : '';
        return `<input class="pill-input" type="checkbox" id="${id}" name="tags" value="${val}" ${mutex}>
        <label class="pill ripple option-item" for="${id}" ${showIf}>${opt.label}</label>`;
      });

      let headerHtml;
      if (cat.asPill && cat.category) {
        // ç±»å¯é€‰ï¼šæ ‡é¢˜æ¸²æŸ“ä¸ºæ›´å¤§çš„èƒ¶å›Šï¼Œå¹¶åœ¨åŒä¸€è¡ŒåŠ ä¸€ä¸ªè¿å­—ç¬¦ï¼Œå†æ¥å°ç±»
        const id = `tag${tagIndex++}`;
        const label = cat.pillLabel || cat.category;
        const value = cat.pillValue || cat.category;
        const catPill = `<input class="pill-input" type="checkbox" id="${id}" name="tags" value="${value}" ${catMutex}>
          <label class="pill pill-lg ripple option-item" for="${id}" ${catShowIf}>${label}</label>`;
        headerHtml = `<div class="category-line">${catPill}<span class="category-sep">-</span>${subPills.join('')}</div>`;
      } else {
        // æ™®é€šï¼šæ˜¾ç¤ºæ–‡å­—æ ‡é¢˜ï¼Œä¸‹é¢ä¸€è¡Œæ˜¾ç¤ºå°ç±»
        headerHtml = `<div class="tag-category-title">${cat.category}</div><div class="pill-group">${subPills.join('')}</div>`;
      }

      return `<div class="tag-category" data-category="${cat.category}" ${catShowIf}>${headerHtml}</div>`;
    }).join('');

    // Tags æœç´¢åŠŸèƒ½ï¼ˆä»…ç»‘å®šä¸€æ¬¡ï¼‰
    const tagsSearch = document.getElementById('tagsSearch');
    if (tagsSearch && !tagsSearch.dataset.bound) {
      tagsSearch.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase().trim();
        
        // è·å–å½“å‰é€‰ä¸­çš„å€¼ï¼Œç”¨äºæ¡ä»¶æ£€æŸ¥
        const formData = new FormData(document.getElementById('uploadForm'));
        const selected = {};
        for (const [k, v] of formData.entries()) {
          if (!selected[k]) selected[k] = [];
          selected[k].push(v);
        }
        
        document.querySelectorAll('.tag-category').forEach(cat => {
          const pills = cat.querySelectorAll('.pill');
          let hasVisible = false;
          pills.forEach(pill => {
            const label = pill.querySelector('.option-item');
            if (!label) return;
            
            // æ£€æŸ¥å¯ç”¨æ¡ä»¶
            const showIf = label.getAttribute('data-showif');
            const conditionMet = !showIf || checkCondition(showIf, selected);
            
            // æ£€æŸ¥æœç´¢åŒ¹é…
            const textMatch = pill.textContent.toLowerCase().includes(query);
            
            // åŒæ—¶æ»¡è¶³æ¡ä»¶å’Œæœç´¢æ‰æ˜¾ç¤º
            const shouldShow = conditionMet && (textMatch || !query);
            pill.style.display = shouldShow ? '' : 'none';
            if (shouldShow) hasVisible = true;
          });
          cat.classList.toggle('hidden', !hasVisible);
        });
      });
      tagsSearch.dataset.bound = '1';
    }
    
    // ç»‘å®š tags çš„æ¡ä»¶é€»è¾‘
    bindConditionalLogic();
  }

  function getEffectiveCategories() {
    const partitions = (CONFIG.tagPartitions || {});
    const cateInput = document.getElementById('category');
    const raw = (cateInput && cateInput.value || '').trim();
    const map = { 'éè¾¹é™': 'feibianxian', 'è¾¹é™': 'bianxian', 'æ·±æ¸Š': 'shenyuan' };
    const key = map[raw] || null;
    
    // å…¬å…±åˆ†ç±»æ¥è‡ª tagPartitions.common
    const common = Array.isArray(partitions.common) ? partitions.common : [];
    const extra = key && Array.isArray(partitions[key]) ? partitions[key] : [];
    
    console.log('å…¬å…±åˆ†ç±»:', common.length, 'ä¸“å±åˆ†ç±»:', extra.length);
    return mergeCategoriesByName(common, extra);
  }

  function mergeCategoriesByName(base, extra) {
    const byName = new Map();
    const add = (arr) => {
      (arr || []).forEach(cat => {
        if (!cat || !cat.category) return;
        if (!byName.has(cat.category)) {
          byName.set(cat.category, {
            category: cat.category,
            asPill: !!cat.asPill,
            pillLabel: cat.pillLabel,
            pillValue: cat.pillValue,
            showIf: cat.showIf,            // ä¿ç•™åˆ†ç±»æ˜¾ç¤ºæ¡ä»¶
            mutexWith: cat.mutexWith,      // ä¿ç•™åˆ†ç±»äº’æ–¥
            tags: []
          });
        }
        const entry = byName.get(cat.category);
        // åˆå¹¶åˆ†ç±»çº§å±æ€§ï¼ˆåè€…è¦†ç›–ï¼‰
        if (cat.asPill) entry.asPill = true;
        if (cat.pillLabel) entry.pillLabel = cat.pillLabel;
        if (cat.pillValue) entry.pillValue = cat.pillValue;
        if (cat.showIf) entry.showIf = cat.showIf;
        if (Array.isArray(cat.mutexWith) && cat.mutexWith.length) entry.mutexWith = cat.mutexWith;

        // åˆå¹¶å¹¶å»é‡å­æ ‡ç­¾ï¼ˆæŒ‰ value ä¼˜å…ˆï¼Œå…¶æ¬¡ labelï¼‰
        const seen = new Set(entry.tags.map(t => t.value || t.label));
        (cat.tags || []).forEach(t => {
          const val = (t && (t.value || t.label));
          if (!val || seen.has(val)) return;
          entry.tags.push({
            value: t.value || t.label,
            label: t.label || t.value,
            showIf: t.showIf,
            mutexWith: Array.isArray(t.mutexWith) ? t.mutexWith : undefined
          });
          seen.add(val);
        });
      });
    };
    add(base);
    add(extra);
    return Array.from(byName.values());
  }

  function bindConditionalLogic() {
    // ç›‘å¬æ‰€æœ‰ checkbox/radio å˜åŒ–ï¼ŒåŠ¨æ€æ˜¾ç¤º/ç¦ç”¨æ¿å—å’Œé€‰é¡¹
    document.querySelectorAll('input[type="checkbox"], input[type="radio"]').forEach(input => {
      input.addEventListener('change', updateConditionalUI);
    });
    updateConditionalUI();
  }

  function updateConditionalUI() {
    const formData = new FormData(document.getElementById('uploadForm'));
    const selected = {};
    for (const [k, v] of formData.entries()) {
      if (!selected[k]) selected[k] = [];
      selected[k].push(v);
    }

    // æ¿å—æ˜¾ç¤ºæ¡ä»¶ï¼ˆåªå¤„ç†æœ‰ data-showif çš„ï¼‰
    document.querySelectorAll('.field[data-showif], .tag-category[data-showif]').forEach(field => {
      const cond = field.getAttribute('data-showif');
      if (!cond) return; // æ— æ¡ä»¶çš„ä¸å¤„ç†
      field.style.display = checkCondition(cond, selected) ? '' : 'none';
    });

    // é€‰é¡¹æ˜¾ç¤ºæ¡ä»¶ï¼ˆéšè—æ•´ä¸ª labelï¼Œè€Œä¸æ˜¯ disabledï¼‰
    document.querySelectorAll('.option-item[data-showif]').forEach(label => {
      const cond = label.getAttribute('data-showif');
      label.style.display = checkCondition(cond, selected) ? '' : 'none';
    });

    // äº’æ–¥é€»è¾‘ï¼ˆtags ç”¨ name="tags"ï¼Œè‡ªå®šä¹‰æ¿å—ç”¨å„è‡ª nameï¼‰
    document.querySelectorAll('input[data-mutex]').forEach(input => {
      if (!input.checked) return;
      const mutexValues = (input.getAttribute('data-mutex') || '').split(',').map(x => x.trim()).filter(Boolean);
      const name = input.name;
      document.querySelectorAll(`input[name="${name}"]`).forEach(other => {
        if (other === input) return;
        if (mutexValues.includes(other.value)) {
          other.checked = false;
        }
      });
    });
  }

  function checkCondition(cond, selected) {
    if (!cond) return true;
    
    // æ”¯æŒ | åˆ†éš”çš„æˆ–å…³ç³»
    const conditions = cond.split('|').map(c => c.trim()).filter(Boolean);
    
    // ä»»ä¸€æ¡ä»¶æ»¡è¶³å³è¿”å› true
    return conditions.some(singleCond => {
      // æ£€æŸ¥æ˜¯å¦ä¸º"é"æ¡ä»¶ï¼ˆä»¥ ! å¼€å¤´ï¼‰
      const isNegated = singleCond.startsWith('!');
      const actualCond = isNegated ? singleCond.slice(1).trim() : singleCond;
      
      const parts = actualCond.split(':');
      if (parts.length !== 2) return true;
      const [field, value] = parts.map(x => x.trim());
      
      // æ™ºèƒ½åŒ¹é…ï¼šå°è¯•å¤šç§å­—æ®µåå˜ä½“
      const variants = [
        field,                    // åŸæ · å¦‚ æ€§å‘
        `custom_${field}`,        // å•é€‰ å¦‚ custom_æ€§å‘
        `custom_${field}[]`       // å¤šé€‰ å¦‚ custom_æ€§å‘[]
      ];
      
      let matched = false;
      for (const v of variants) {
        const vals = selected[v] || [];
        if (vals.includes(value)) {
          matched = true;
          break;
        }
      }
      
      // å¦‚æœæ˜¯"é"æ¡ä»¶ï¼Œè¿”å›ç›¸åçš„ç»“æœ
      return isNegated ? !matched : matched;
    });
  }


  // --- è§’è‰²åèƒ¶å›Šç®¡ç† ---
  const characterList = document.getElementById('characterList');

  function createCharacterChip(placeholder) {
    const chip = document.createElement('div');
    chip.className = 'character-chip';
    
    const input = document.createElement('input');
    input.type = 'text';
    input.name = 'characters';
    input.placeholder = placeholder;
    
    const deleteBtn = document.createElement('button');
    deleteBtn.type = 'button';
    deleteBtn.className = 'delete-btn';
    deleteBtn.textContent = 'Ã—';
    deleteBtn.title = 'åˆ é™¤';
    
    chip.appendChild(input);
    chip.appendChild(deleteBtn);
    
    // è‡ªé€‚åº”å®½åº¦ï¼ˆåƒç´ æµ‹é‡ï¼Œé¿å…ä¸­æ–‡ç­‰å®½ä¸å‡†ï¼‰
    const measure = document.createElement('span');
    measure.style.position = 'absolute';
    measure.style.visibility = 'hidden';
    measure.style.whiteSpace = 'pre';
    measure.style.fontSize = getComputedStyle(input).fontSize;
    measure.style.fontFamily = getComputedStyle(input).fontFamily;
    chip.appendChild(measure);

    const autoSize = () => {
      const text = input.value || input.placeholder || '';
      measure.textContent = text;
      const textWidth = measure.getBoundingClientRect().width;
      const minWidth = 80; // ä¸ CSS å¯¹é½çš„æœ€å°å®½
      const maxWidth = 280; // ä¸Šé™ï¼Œé¿å…è¿‡é•¿
      const styles = getComputedStyle(input);
      const padLeft = parseFloat(styles.paddingLeft) || 0;
      const padRight = parseFloat(styles.paddingRight) || 0;
      const currentWidth = parseFloat(styles.width) || minWidth;
      const currentContentCap = currentWidth - padLeft - padRight;
      // åªæœ‰å½“æ–‡æœ¬çœŸæ­£å¡«æ»¡å½“å‰å®½åº¦æ—¶æ‰å¢é•¿
      if (textWidth <= currentContentCap - 1) return;
      const target = Math.max(minWidth, Math.min(textWidth + padLeft + padRight, maxWidth));
      input.style.width = target + 'px';
    };
    autoSize();
    input.addEventListener('input', autoSize);
    
    // åˆ é™¤æŒ‰é’®
    deleteBtn.addEventListener('click', () => {
      const allChips = characterList.querySelectorAll('.character-chip');
      if (allChips.length > 1) {
        chip.remove();
      } else {
        input.value = '';
        autoSize();
      }
    });
    
    return chip;
  }

  function initCharacterList(count = 1) {
    characterList.innerHTML = '';
    const n = Math.max(1, count|0);
    for (let i = 1; i <= n; i++) {
      characterList.appendChild(createCharacterChip(`è§’è‰²${i}`));
    }
  }

  document.getElementById('addCharacterBtn').addEventListener('click', () => {
    const count = characterList.querySelectorAll('.character-chip').length + 1;
    characterList.appendChild(createCharacterChip(`è§’è‰²${count}`));
  });

  // --- åŠ¨æ€è¡¨å•é€»è¾‘ ---

  // 1. å•äºº/å¤šäººå¡é€»è¾‘ï¼ˆå•äºº=æ–‡æœ¬æ¡†ï¼Œå¤šäºº=èƒ¶å›Š+åŠ å·ï¼‰
  const nameRelationGroup = document.getElementById('nameRelationGroup');
  const singleCharacterContainer = document.getElementById('singleCharacterContainer');
  const multiCharactersContainer = document.getElementById('multiCharactersContainer');

  function updateCharacterUI() {
    const type = (document.querySelector('input[name="cardType"]:checked') || {}).value;
    const relation = (document.querySelector('input[name="nameRelation"]:checked') || {}).value || 'same';
    
    if (type === 'multi') {
      // å¤šäººå¡ï¼šéšè—åŒå/ä¸åŒåï¼Œæ˜¾ç¤ºèƒ¶å›Š+åŠ å·ï¼Œéšè—å•äººæ–‡æœ¬æ¡†
      nameRelationGroup.classList.add('hidden');
      nameRelationGroup.style.display = 'none';
      singleCharacterContainer.classList.add('hidden');
      multiCharactersContainer.classList.remove('hidden');
      initCharacterList(2);
    } else {
      // å•äººå¡ï¼šæ˜¾ç¤ºåŒå/ä¸åŒåé€‰é¡¹
      nameRelationGroup.classList.remove('hidden');
      nameRelationGroup.style.display = '';
      multiCharactersContainer.classList.add('hidden');
      
      if (relation === 'different') {
        // å•äººä¸åŒåï¼šæ˜¾ç¤ºæ–‡æœ¬æ¡†
        singleCharacterContainer.classList.remove('hidden');
      } else {
        // å•äººåŒåï¼šéšè—æ–‡æœ¬æ¡†
        singleCharacterContainer.classList.add('hidden');
      }
    }
  }

  document.querySelectorAll('input[name="cardType"]').forEach(radio => {
    radio.addEventListener('change', updateCharacterUI);
  });
  document.querySelectorAll('input[name="nameRelation"]').forEach(radio => {
    radio.addEventListener('change', updateCharacterUI);
  });
  updateCharacterUI();

  // 2. ä½œè€… é€»è¾‘
  const authorNameInput = document.getElementById('authorName');
  document.querySelectorAll('input[name="authorType"]').forEach(radio => {
    radio.addEventListener('change', (e) => {
      if (e.target.value === 'anonymous') {
        authorNameInput.placeholder = 'é©¬ç”² (ä¸å¡«é»˜è®¤åŒ¿å)';
      } else {
        authorNameInput.placeholder = 'å®å';
      }
    });
  });

  // 3. äºŒæ¬¡æ’é›· é€»è¾‘
  const secondaryWarningContainer = document.getElementById('secondaryWarningContainer');
  document.querySelectorAll('input[name="secondaryWarningToggle"]').forEach(radio => {
    radio.addEventListener('change', (e) => {
      if (e.target.value === 'yes') {
        secondaryWarningContainer.classList.remove('hidden');
      } else {
        secondaryWarningContainer.classList.add('hidden');
        document.getElementById('secondaryWarning').value = '';
      }
    });
  });

  // --- è¡¨å•æäº¤é€»è¾‘ ---
  const uploadForm = document.getElementById("uploadForm");
  const submitButton = document.getElementById("submitButton");
  const uploadStatus = document.getElementById("uploadStatus");

  uploadForm.addEventListener("submit", async function (event) {
    event.preventDefault();
    
    const cardPngFile = document.getElementById('cardPngFile').files[0];
    const cardJsonFile = document.getElementById('cardJsonFile').files[0];
    if (!cardPngFile && !cardJsonFile) {
        uploadStatus.textContent = "è¯·è‡³å°‘ä¸Šä¼ è§’è‰²å¡PNGæˆ–JSONæ–‡ä»¶å…¶ä¸­ä¸€ä¸ª";
        return;
    }

    submitButton.disabled = true;
    submitButton.textContent = "ä¸Šä¼ ä¸­...";
    uploadStatus.textContent = "æ­£åœ¨ä¸Šä¼ ï¼Œè¯·ç¨å€™... (å¤§æ–‡ä»¶å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´)";

    try {
      const formData = new FormData(uploadForm);

      if (formData.get('cardType') === 'single') {
        const relation = formData.get('nameRelation') || 'same';
        if (relation === 'same') {
          formData.delete('characters');
        }
      }
      
      if (formData.get('secondaryWarningToggle') === 'no') {
        formData.delete('secondaryWarning');
      }
      formData.delete('secondaryWarningToggle');

      const response = await fetch("/api/upload", {
        method: "POST",
        body: formData,
      });

      const result = await response.json();

      if (result.success) {
        uploadStatus.textContent = result.message;
        
        // å¦‚æœä½¿ç”¨äº†tokenï¼Œæ ‡è®°ä¸ºå·²ä½¿ç”¨
        const params = new URLSearchParams(location.search);
        const token = params.get('token');
        if (token) {
          await markTokenAsUsed(token);
          // æ˜¾ç¤ºæˆåŠŸå¹¶æç¤ºå…³é—­é¡µé¢
          uploadStatus.innerHTML = `
            <div style="padding: 12px; background: #E8F5E9; border: 1px solid #4CAF50; border-radius: 8px; margin-top: 16px;">
              <strong>âœ… ${result.message}</strong><br>
              <small style="color: #666;">æ­¤Tokenå·²ä½¿ç”¨ï¼Œé“¾æ¥å·²å¤±æ•ˆã€‚æ‚¨å¯ä»¥å…³é—­æ­¤é¡µé¢ã€‚</small>
            </div>
          `;
          // ç¦ç”¨è¡¨å•é˜²æ­¢é‡å¤æäº¤
          submitButton.disabled = true;
          submitButton.textContent = "å·²æäº¤";
          return;
        }
        
        uploadForm.reset();
        // æ‰‹åŠ¨é‡ç½®æ‰€æœ‰åŠ¨æ€è¡¨å•
        document.querySelector('input[name="cardType"][value="single"]').dispatchEvent(new Event('change'));
        document.querySelector('input[name="authorType"][value="real"]').dispatchEvent(new Event('change'));
        document.querySelector('input[name="secondaryWarningToggle"][value="no"]').dispatchEvent(new Event('change'));
        document.querySelector('input[name="nameRelation"][value="same"]').checked = true;
        updateCharacterUI();
        initCharacterList();
        
        // æ¸…ç©ºæ–‡ä»¶å­˜å‚¨å’Œé¢„è§ˆ
        fileStorage['avatarImage'] = [];
        fileStorage['galleryImages'] = [];
        fileStorage['cardPngFile'] = [];
        fileStorage['cardJsonFile'] = [];
        fileStorage['attachments'] = [];
        document.getElementById('avatarPreviews').innerHTML = '';
        document.getElementById('galleryPreviews').innerHTML = '';
        document.getElementById('cardPngPreviews').innerHTML = '';
        document.getElementById('cardJsonPreviews').innerHTML = '';
        document.getElementById('attachmentPreviews').innerHTML = '';
        
        // ä¸Šä¼ æˆåŠŸ 
      } else {
        uploadStatus.textContent = "å¤±è´¥: " + result.message;
      }
    } catch (error) {
      console.error("æäº¤å‡ºé”™:", error);
      uploadStatus.textContent = "ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–æ§åˆ¶å°æŠ¥é”™ã€‚";
    } finally {
      submitButton.disabled = false;
      submitButton.textContent = "ä¸Šä¼ ";
    }
  });

  // --- Discordé¢„è§ˆæ›´æ–°å‡½æ•°ï¼ˆå…¨å±€ï¼‰ ---
  window.updateDiscordPreview = function() {
    // æ›´æ–°é©¬ç”²å
    const authorType = document.querySelector('input[name="authorType"]:checked')?.value;
    const authorName = document.getElementById('authorName')?.value.trim();
    let vestName = 'åŒ¿å';
    
    if (authorType === 'real' && authorName) {
      vestName = authorName;
    } else if (authorType === 'anonymous' && authorName) {
      vestName = authorName;
    }
    
    const usernameEl = document.getElementById('previewUsername');
    const vestEl = document.getElementById('previewVest');
    if (usernameEl) usernameEl.textContent = vestName;
    if (vestEl) vestEl.textContent = vestName;
    
    // æ›´æ–°å¤´åƒï¼ˆä¼˜å…ˆçº§ï¼šä¸Šä¼ çš„å¤´åƒ > PNGè§’è‰²å¡ > Discordé»˜è®¤å›¾æ ‡ï¼‰
    const avatarElement = document.getElementById('previewAvatar');
    if (!avatarElement) return;
    
    const avatarFiles = fileStorage['avatarImage'] || [];
    const cardPngFiles = fileStorage['cardPngFile'] || [];
    
    if (avatarFiles.length > 0 && avatarFiles[0].type.startsWith('image/')) {
      // ä½¿ç”¨ä¸Šä¼ çš„å¤´åƒ
      const reader = new FileReader();
      reader.onload = (e) => {
        avatarElement.innerHTML = `<img src="${e.target.result}" alt="å¤´åƒ">`;
      };
      reader.readAsDataURL(avatarFiles[0]);
    } else if (cardPngFiles.length > 0 && cardPngFiles[0].type === 'image/png') {
      // ä½¿ç”¨PNGè§’è‰²å¡ä½œä¸ºå¤´åƒ
      const reader = new FileReader();
      reader.onload = (e) => {
        avatarElement.innerHTML = `<img src="${e.target.result}" alt="è§’è‰²å¡">`;
      };
      reader.readAsDataURL(cardPngFiles[0]);
    } else {
      // ä½¿ç”¨Discordé»˜è®¤å›¾æ ‡
      avatarElement.innerHTML = `<img src="https://discord.com/assets/18e336a74a159cfd.png" alt="é»˜è®¤å¤´åƒ">`;
    }
    
    // æ›´æ–°å¡åï¼ˆä¸æ˜¾ç¤ºå‰ç¼€ï¼‰
    const cardName = document.getElementById('cardName')?.value.trim();
    const previewCardName = document.getElementById('previewCardName');
    if (previewCardName) {
      if (cardName) {
        previewCardName.innerHTML = cardName;
      } else {
        previewCardName.innerHTML = '<span class="preview-placeholder">æœªå¡«å†™å¡å</span>';
      }
    }
    
    // æ›´æ–°æ€§å‘ï¼ˆä»è‡ªå®šä¹‰æ¿å—è·å–ï¼‰
    const orientations = [];
    document.querySelectorAll('input[name="custom_æ€§å‘"]:checked').forEach(cb => {
      orientations.push(cb.value);
    });
    
    const previewOrientationField = document.getElementById('previewOrientationField');
    const previewOrientation = document.getElementById('previewOrientation');
    if (previewOrientationField && previewOrientation) {
      if (orientations.length > 0) {
        previewOrientationField.style.display = '';
        previewOrientation.textContent = orientations.join(' / ');
      } else {
        previewOrientationField.style.display = 'none';
      }
    }
    
    // æ›´æ–° Tagsï¼ˆæ–‡å­—æ ¼å¼ï¼šxx/xx/xxï¼‰
    const selectedTags = [];
    document.querySelectorAll('input[type="checkbox"].pill-input:checked').forEach(cb => {
      const label = document.querySelector(`label[for="${cb.id}"]`);
      if (label && cb.name === 'tags') {
        selectedTags.push(label.textContent.trim());
      }
    });
    
    // æ·»åŠ è‡ªå®šä¹‰æ¿å—çš„é€‰ä¸­é¡¹ï¼ˆé™¤äº†æ€§å‘ï¼‰
    document.querySelectorAll('[id^="section_"] input:checked').forEach(input => {
      if (input.name !== 'custom_æ€§å‘' && input.type === 'checkbox') {
        selectedTags.push(input.value);
      }
    });
    
    const previewTagsField = document.getElementById('previewTagsField');
    const previewTags = document.getElementById('previewTags');
    if (previewTagsField && previewTags) {
      if (selectedTags.length > 0) {
        previewTagsField.style.display = '';
        previewTags.textContent = selectedTags.join(' / ');
      } else {
        previewTagsField.style.display = 'none';
      }
    }
    
    // æ›´æ–°æ’é›·
    const warnings = document.getElementById('warnings')?.value.trim();
    const previewWarnings = document.getElementById('previewWarnings');
    if (previewWarnings) {
      if (warnings) {
        previewWarnings.textContent = warnings;
      } else {
        previewWarnings.innerHTML = '<span class="preview-placeholder">æœªå¡«å†™</span>';
      }
    }
    
    // æ›´æ–°å…¶å¥¹
    const otherInfo = document.getElementById('otherInfo')?.value.trim();
    const previewOtherInfoField = document.getElementById('previewOtherInfoField');
    const previewOtherInfo = document.getElementById('previewOtherInfo');
    if (previewOtherInfoField && previewOtherInfo) {
      if (otherInfo) {
        previewOtherInfoField.style.display = '';
        previewOtherInfo.textContent = otherInfo;
      } else {
        previewOtherInfoField.style.display = 'none';
      }
    }
    
    // æ£€æŸ¥æ˜¯å¦ä¸ºæ·±æ¸Šåˆ†åŒºï¼ˆæ˜¾ç¤ºèµæ•°ï¼‰
    const category = document.getElementById('category')?.value.trim();
    const isAbyss = category === 'æ·±æ¸Š';
    const previewLikeSection = document.getElementById('previewLikeSection');
    if (previewLikeSection) {
      previewLikeSection.style.display = isAbyss ? '' : 'none';
    }
    
    // æ›´æ–°ä¸»æ¥¼å›¾ç‰‡
    const galleryFiles = fileStorage['galleryImages'] || [];
    const previewImagesContainer = document.getElementById('previewImagesContainer');
    const previewImages = document.getElementById('previewImages');
    
    if (previewImagesContainer && previewImages) {
      if (galleryFiles.length > 0) {
        previewImagesContainer.style.display = '';
        previewImages.innerHTML = '';
        
        galleryFiles.forEach((file, index) => {
          if (index < 4) { // æœ€å¤šæ˜¾ç¤º4å¼ å›¾ç‰‡
            const reader = new FileReader();
            reader.onload = (e) => {
              const imgDiv = document.createElement('div');
              imgDiv.className = 'discord-image';
              imgDiv.innerHTML = `<img src="${e.target.result}" alt="ä¸»æ¥¼å›¾ç‰‡${index + 1}">`;
              previewImages.appendChild(imgDiv);
            };
            reader.readAsDataURL(file);
          }
        });
        
        if (galleryFiles.length > 4) {
          const moreDiv = document.createElement('div');
          moreDiv.className = 'discord-image';
          moreDiv.style.display = 'flex';
          moreDiv.style.alignItems = 'center';
          moreDiv.style.justifyContent = 'center';
          moreDiv.style.background = '#2b2d31';
          moreDiv.style.borderRadius = '4px';
          moreDiv.style.padding = '20px';
          moreDiv.style.color = '#b5bac1';
          moreDiv.innerHTML = `+${galleryFiles.length - 4} å¼ å›¾ç‰‡`;
          previewImages.appendChild(moreDiv);
        }
      } else {
        previewImagesContainer.style.display = 'none';
      }
    }
  };

  // --- æ–‡ä»¶ä¸Šä¼ é¢„è§ˆåŠŸèƒ½ ---
  const fileStorage = {}; // å­˜å‚¨æ¯ä¸ªinputçš„æ–‡ä»¶åˆ—è¡¨

  function setupFilePreview(inputId, previewId, isImage = false, multiple = false) {
    const input = document.getElementById(inputId);
    const preview = document.getElementById(previewId);
    
    // åˆå§‹åŒ–å­˜å‚¨
    if (!fileStorage[inputId]) {
      fileStorage[inputId] = [];
    }
    
    input.addEventListener('change', (e) => {
      const newFiles = Array.from(e.target.files || []);
      
      if (multiple) {
        // å¤šæ–‡ä»¶æ¨¡å¼ï¼šç´¯ç§¯æ–‡ä»¶
        fileStorage[inputId] = [...fileStorage[inputId], ...newFiles];
      } else {
        // å•æ–‡ä»¶æ¨¡å¼ï¼šæ›¿æ¢
        fileStorage[inputId] = newFiles;
      }
      
      // æ›´æ–° input.files
      const dt = new DataTransfer();
      fileStorage[inputId].forEach(f => dt.items.add(f));
      input.files = dt.files;
      
      // é‡æ–°æ¸²æŸ“é¢„è§ˆ
      renderPreviews(inputId, previewId, isImage);
      
      // å¦‚æœæ˜¯å¤´åƒã€ä¸»æ¥¼å›¾ç‰‡æˆ–PNGè§’è‰²å¡ï¼Œå»¶è¿Ÿæ›´æ–°Discordé¢„è§ˆï¼ˆç¡®ä¿æ–‡ä»¶è¯»å–å®Œæˆï¼‰
      if (inputId === 'avatarImage' || inputId === 'galleryImages' || inputId === 'cardPngFile') {
        setTimeout(() => {
          if (window.updateDiscordPreview) {
            window.updateDiscordPreview();
          }
        }, 100);
      }
    });
  }

  function renderPreviews(inputId, previewId, isImage) {
    const preview = document.getElementById(previewId);
    preview.innerHTML = '';
    const files = fileStorage[inputId] || [];
    
    files.forEach((file, idx) => {
      if ((isImage && file.type.startsWith('image/')) || (inputId === 'cardPngFile' && file.type === 'image/png')) {
        const reader = new FileReader();
        reader.onload = (ev) => {
          const div = document.createElement('div');
          div.className = 'upload-thumbnail';
          div.innerHTML = `
            <img src="${ev.target.result}" alt="${file.name}">
            <button class="remove" type="button" onclick="removeFile('${inputId}', ${idx})">Ã—</button>
          `;
          preview.appendChild(div);
        };
        reader.readAsDataURL(file);
      } else {
        const div = document.createElement('div');
        div.className = 'upload-thumbnail';
        div.innerHTML = `
          <div style="display:flex;align-items:center;justify-content:center;height:100%;background:#f5f5f5;font-size:12px;text-align:center;padding:4px;">${file.name}</div>
          <button class="remove" type="button" onclick="removeFile('${inputId}', ${idx})">Ã—</button>
        `;
        preview.appendChild(div);
      }
    });
  }

  window.removeFile = function(inputId, index) {
    // ä»å­˜å‚¨ä¸­åˆ é™¤
    fileStorage[inputId].splice(index, 1);
    
    // æ›´æ–° input.files
    const input = document.getElementById(inputId);
    const dt = new DataTransfer();
    fileStorage[inputId].forEach(f => dt.items.add(f));
    input.files = dt.files;
    
    // ç¡®å®šé¢„è§ˆå®¹å™¨å’Œæ˜¯å¦ä¸ºå›¾ç‰‡
    const previewMapping = {
      'avatarImage': { previewId: 'avatarPreviews', isImage: true },
      'galleryImages': { previewId: 'galleryPreviews', isImage: true },
      'cardPngFile': { previewId: 'cardPngPreviews', isImage: true },
      'cardJsonFile': { previewId: 'cardJsonPreviews', isImage: false },
      'attachments': { previewId: 'attachmentPreviews', isImage: false }
    };
    
    const mapping = previewMapping[inputId] || { previewId: inputId + 'Previews', isImage: false };
    renderPreviews(inputId, mapping.previewId, mapping.isImage);
    
    // å¦‚æœåˆ é™¤çš„æ˜¯å¤´åƒã€ä¸»æ¥¼å›¾ç‰‡æˆ–PNGè§’è‰²å¡ï¼Œå»¶è¿Ÿæ›´æ–°Discordé¢„è§ˆ
    if (inputId === 'avatarImage' || inputId === 'galleryImages' || inputId === 'cardPngFile') {
      setTimeout(() => {
        if (window.updateDiscordPreview) {
          window.updateDiscordPreview();
        }
      }, 100);
    }
  };

  // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
  document.addEventListener('DOMContentLoaded', async () => {
    // URL å‚æ•°å¤„ç†
    const params = new URLSearchParams(location.search);
    const token = params.get('token');
    
    // å¦‚æœæœ‰tokenï¼Œå…ˆéªŒè¯
    if (token) {
      const verified = await verifyToken(token);
      if (!verified) {
        // TokenéªŒè¯å¤±è´¥ï¼Œç¦ç”¨è¡¨å•
        document.getElementById('uploadForm').style.display = 'none';
        document.getElementById('uploadStatus').textContent = 'âš ï¸ TokenéªŒè¯å¤±è´¥ï¼Œæ— æ³•ä½¿ç”¨æ­¤é“¾æ¥ä¸Šä¼ å¡ç‰‡ã€‚è¯·è”ç³»ç®¡ç†å‘˜è·å–æ–°çš„å‘å¡é“¾æ¥ã€‚';
        document.getElementById('uploadStatus').style.color = '#B5534E';
        return;
      }
      
      // TokenéªŒè¯æˆåŠŸï¼Œé¢„å¡«ä¿¡æ¯
      if (TOKEN_DATA) {
        // é¢„å¡«åˆ†åŒº
        const categoryInput = document.getElementById('category');
        categoryInput.value = TOKEN_DATA.category;
        categoryInput.readOnly = true;
        categoryInput.classList.add('locked');
        
        // é¢„å¡«ä½œè€…åï¼ˆä½¿ç”¨display_nameæˆ–usernameï¼‰
        const authorNameInput = document.getElementById('authorName');
        authorNameInput.value = TOKEN_DATA.display_name || TOKEN_DATA.username;
        // æ³¨æ„ï¼šé»˜è®¤é€‰æ‹©å®åå¹¶é”å®šï¼Œå¦‚æœåˆ‡æ¢åˆ°åŒ¿ååˆ™è§£é”
        authorNameInput.readOnly = true;
        authorNameInput.classList.add('locked');
        authorNameInput.dataset.tokenLocked = 'true'; // æ ‡è®°è¿™æ˜¯tokené”å®šçš„
        
        // é¢„å¡«authorIdï¼ˆéšè—å­—æ®µï¼‰
        const authorIdInput = document.getElementById('authorId');
        authorIdInput.value = TOKEN_DATA.user_id;
        
        // é»˜è®¤é€‰æ‹©å®å
        document.querySelector('input[name="authorType"][value="real"]').checked = true;
        
        // ç›‘å¬ä½œè€…ç±»å‹åˆ‡æ¢
        document.querySelectorAll('input[name="authorType"]').forEach(radio => {
          radio.addEventListener('change', (e) => {
            if (authorNameInput.dataset.tokenLocked === 'true') {
              if (e.target.value === 'anonymous') {
                // åˆ‡æ¢åˆ°åŒ¿åï¼šè§£é”ï¼Œå…è®¸ä¿®æ”¹ä¸ºé©¬ç”²å
                authorNameInput.readOnly = false;
                authorNameInput.classList.remove('locked');
                authorNameInput.placeholder = 'é©¬ç”² (ä¸å¡«é»˜è®¤åŒ¿å)';
                authorNameInput.value = ''; // æ¸…ç©ºï¼Œè®©ç”¨æˆ·å¡«å†™é©¬ç”²
              } else {
                // åˆ‡æ¢åˆ°å®åï¼šé”å®šï¼Œæ¢å¤Discordåå­—
                authorNameInput.readOnly = true;
                authorNameInput.classList.add('locked');
                authorNameInput.placeholder = 'å®å';
                authorNameInput.value = TOKEN_DATA.display_name || TOKEN_DATA.username;
              }
            }
          });
        });
        
        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        const statusDiv = document.getElementById('uploadStatus');
        statusDiv.innerHTML = `
          <div style="padding: 12px; background: #E8F5E9; border: 1px solid #4CAF50; border-radius: 8px; margin-bottom: 16px;">
            <strong>âœ… å·²é€šè¿‡DiscordéªŒè¯</strong><br>
            ç”¨æˆ·: ${TOKEN_DATA.display_name || TOKEN_DATA.username}<br>
            åˆ†åŒº: ${TOKEN_DATA.category}<br>
            <small style="color: #666;">æ‚¨çš„ä¿¡æ¯å·²è‡ªåŠ¨å¡«å†™å¹¶é”å®šï¼Œè¯·ç»§ç»­å¡«å†™å…¶ä»–ä¿¡æ¯ã€‚</small>
          </div>
        `;
      }
    }
    
    await loadConfig();
    initCharacterList();

    // æ–‡ä»¶é¢„è§ˆï¼ˆç¬¬4ä¸ªå‚æ•°è¡¨ç¤ºæ˜¯å¦æ”¯æŒå¤šæ–‡ä»¶ç´¯ç§¯ï¼‰
    setupFilePreview('avatarImage', 'avatarPreviews', true, false);     // å¤´åƒï¼Œå•æ–‡ä»¶
    setupFilePreview('galleryImages', 'galleryPreviews', true, true);   // å›¾ç‰‡ï¼Œå¤šé€‰ç´¯ç§¯
    setupFilePreview('cardPngFile', 'cardPngPreviews', true, false);    // PNGå¡ï¼Œå•æ–‡ä»¶
    setupFilePreview('cardJsonFile', 'cardJsonPreviews', false, false); // JSONå¡ï¼Œå•æ–‡ä»¶
    setupFilePreview('attachments', 'attachmentPreviews', false, true); // é™„ä»¶ï¼Œå¤šé€‰ç´¯ç§¯

    // æ–‡æœ¬åŸŸè‡ªåŠ¨é«˜åº¦
    document.querySelectorAll('textarea').forEach(t => {
      const resize = () => { 
        t.style.height = 'auto'; 
        t.style.height = (t.scrollHeight) + 'px'; 
      };
      t.addEventListener('input', resize);
      resize();
    });

    // å…¼å®¹æ—§çš„URLå‚æ•°é¢„å¡«ä¸é”å®šï¼ˆå¦‚æœæ²¡æœ‰tokençš„è¯ï¼‰
    if (!token) {
      const category = params.get('category');
      if (category) { 
        const cat = document.getElementById('category'); 
        cat.value = decodeURIComponent(category); 
      }
      
      const authorName = params.get('authorName');
      if (authorName) { 
        const au = document.getElementById('authorName'); 
        au.value = decodeURIComponent(authorName); 
      }
      
      const authorId = params.get('authorId');
      if (authorId) { 
        const aid = document.getElementById('authorId'); 
        aid.value = decodeURIComponent(authorId); 
      }
      
      if (params.get('lockCategory') === '1') { 
        const cat = document.getElementById('category'); 
        cat.readOnly = true; 
        cat.classList.add('locked'); 
      }
      
      if (params.get('lockAuthor') === '1') { 
        const au = document.getElementById('authorName'); 
        au.readOnly = true; 
        au.classList.add('locked'); 
      }
    }

    // é¡¶éƒ¨å¯¼èˆªçš„å¹³æ»‘æ»šåŠ¨
    const navUpload = document.getElementById('navUpload');
    if (navUpload) navUpload.addEventListener('click', (e) => {
      e.preventDefault();
      document.getElementById('upload').scrollIntoView({ behavior: 'smooth', block: 'start' });
    });

    // æ­¥éª¤ç‚¹å‡»è·³è½¬
    const stepMap = {
      step1: document.getElementById('section-base'),
      step2: document.getElementById('section-tags'),
      step3: document.getElementById('section-files')
    };
    Object.keys(stepMap).forEach(id => {
      const el = document.getElementById(id);
      el.style.cursor = 'pointer';
      el.addEventListener('click', () => {
        stepMap[id].scrollIntoView({ behavior: 'smooth', block: 'start' });
      });
    });

    // æ ¹æ®å¡«å†™è¿›åº¦æ›´æ–°æ­¥éª¤çŠ¶æ€
    const steps = [
      { id: 'step1', check: () => {
          const nameFilled = (document.getElementById('cardName').value || '').trim().length > 0;
          return nameFilled;
        }
      },
      { id: 'step2', check: () => {
          return true; // tags å˜ä¸ºå¯é€‰
        }
      },
      { id: 'step3', check: () => {
          const hasPng = document.getElementById('cardPngFile').files.length > 0;
          const hasJson = document.getElementById('cardJsonFile').files.length > 0;
          return hasPng || hasJson;
        }
      }
    ];

    const updateSteps = () => {
      let reachedIncomplete = false;
      steps.forEach((s, idx) => {
        const el = document.getElementById(s.id);
        const ok = s.check();
        el.classList.toggle('completed', ok);
        el.classList.toggle('active', !reachedIncomplete);
        if (!ok) reachedIncomplete = true; else if (idx < steps.length - 1) el.classList.remove('active');
      });
    };

    document.getElementById('cardName').addEventListener('input', updateSteps);
    document.getElementById('cardPngFile').addEventListener('change', updateSteps);
    document.getElementById('cardJsonFile').addEventListener('change', updateSteps);
    updateSteps();

    // === ç»‘å®šDiscordé¢„è§ˆç›‘å¬å™¨ ===
    // ç›‘å¬æ‰€æœ‰ç›¸å…³å­—æ®µçš„å˜åŒ–
    const fieldsToWatch = [
      'authorName',
      'cardName',
      'category',
      'warnings',
      'description',
      'otherInfo'
    ];
    
    fieldsToWatch.forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener('input', window.updateDiscordPreview);
      }
    });
    
    // ç›‘å¬ä½œè€…ç±»å‹å˜åŒ–
    document.querySelectorAll('input[name="authorType"]').forEach(radio => {
      radio.addEventListener('change', window.updateDiscordPreview);
    });
    
    // ç›‘å¬ Tags å˜åŒ–ï¼ˆéœ€è¦é€šè¿‡ MutationObserver æˆ–å§”æ‰˜äº‹ä»¶ï¼‰
    document.addEventListener('change', (e) => {
      if (e.target.classList.contains('pill-input') || 
          e.target.name?.startsWith('custom_') ||
          e.target.type === 'checkbox') {
        window.updateDiscordPreview();
      }
    });
    
    // åˆå§‹åŒ–é¢„è§ˆ
    window.updateDiscordPreview();
  });
</script>

</body>
</html>
