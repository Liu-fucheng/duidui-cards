<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç™»å½•ä¸­...</title>
</head>
<body>
  <div style="text-align: center; padding: 50px; font-family: sans-serif;">
    <h1>ç™»å½•ä¸­...</h1>
    <p>æ­£åœ¨è®¾ç½®ç™»å½•çŠ¶æ€ï¼Œè¯·ç¨å€™...</p>
  </div>
  <script>
    (function() {
      console.log('ğŸ” [auth-callback] é¡µé¢åŠ è½½ï¼ŒURL:', window.location.href);
    
    // ä» URL å‚æ•°è·å– Token
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    const error = urlParams.get('error');
    
    console.log('ğŸ” [auth-callback] Tokenå‚æ•°:', token ? 'å­˜åœ¨ï¼Œé•¿åº¦: ' + token.length : 'ä¸å­˜åœ¨');
    console.log('ğŸ” [auth-callback] Errorå‚æ•°:', error || 'æ— ');
    
    if (error) {
      // æœ‰é”™è¯¯ï¼Œé‡å®šå‘åˆ°æœç´¢é¡µé¢æ˜¾ç¤ºé”™è¯¯
      console.log('âŒ [auth-callback] æœ‰é”™è¯¯ï¼Œé‡å®šå‘åˆ°æœç´¢é¡µé¢');
      window.location.href = `/search.html?error=${encodeURIComponent(error)}`;
    } else if (token) {
      console.log('ğŸ” [auth-callback] æ”¶åˆ°Tokenï¼Œé•¿åº¦:', token.length);
      console.log('ğŸ” [auth-callback] Tokenå‰50ä¸ªå­—ç¬¦:', token.substring(0, 50));
      console.log('ğŸ” [auth-callback] Tokenå50ä¸ªå­—ç¬¦:', token.substring(Math.max(0, token.length - 50)));
      
      // æ£€æŸ¥Tokenæ ¼å¼ï¼ˆJWTåº”è¯¥æœ‰3éƒ¨åˆ†ï¼Œç”¨.åˆ†éš”ï¼‰
      const tokenParts = token.split('.');
      if (tokenParts.length !== 3) {
        console.error('âŒ [auth-callback] Tokenæ ¼å¼é”™è¯¯ï¼Œåº”è¯¥æœ‰3éƒ¨åˆ†ï¼Œå®é™…:', tokenParts.length);
        console.error('ğŸ” [auth-callback] Tokenå†…å®¹:', token);
        window.location.href = '/search.html?error=' + encodeURIComponent('Tokenæ ¼å¼é”™è¯¯ï¼Œå¯èƒ½è¢«æˆªæ–­');
        return;
      }
      
      // æ£€æŸ¥Tokené•¿åº¦ï¼ˆCookieé€šå¸¸é™åˆ¶4KBï¼Œä½†ä¸ºäº†å®‰å…¨æˆ‘ä»¬é™åˆ¶æ›´å°ï¼‰
      if (token.length > 3000) {
        console.error('âŒ [auth-callback] Tokenå¤ªé•¿ï¼Œæ— æ³•è®¾ç½®Cookie:', token.length);
        window.location.href = '/search.html?error=' + encodeURIComponent('Tokenè¿‡é•¿ï¼Œæ— æ³•è®¾ç½®Cookie');
        return;
      }
      
      // åŒæ—¶ä½¿ç”¨ Cookie å’Œ localStorage å­˜å‚¨ï¼ˆåŒé‡ä¿éšœï¼‰
      try {
        // 1. è®¾ç½® localStorageï¼ˆä½œä¸ºå¤‡é€‰ï¼‰
        localStorage.setItem('auth_token', token);
        console.log('âœ… [auth-callback] localStorageå·²è®¾ç½®');
        
        // 2. è®¾ç½® Cookie
        const maxAge = 7 * 24 * 60 * 60; // 7å¤©
        const isSecure = window.location.protocol === 'https:';
        
        // ç›´æ¥è®¾ç½®Cookieï¼Œå¯¹Tokenè¿›è¡ŒURLç¼–ç 
        let cookieValue = 'auth_token=' + encodeURIComponent(token);
        cookieValue += '; Path=/';
        cookieValue += '; Max-Age=' + maxAge;
        cookieValue += '; SameSite=Lax';
        if (isSecure) {
          cookieValue += '; Secure';
        }
        
        document.cookie = cookieValue;
        console.log('âœ… [auth-callback] Cookieå·²è®¾ç½®ï¼Œé•¿åº¦:', cookieValue.length);
        
        // ç«‹å³æ£€æŸ¥Cookie
        const allCookies = document.cookie;
        console.log('ğŸ” [auth-callback] å½“å‰æ‰€æœ‰Cookieé•¿åº¦:', allCookies.length);
        
        // è§£æCookie
        const cookies = {};
        if (allCookies) {
          allCookies.split(';').forEach(cookie => {
            const trimmed = cookie.trim();
            const equalIndex = trimmed.indexOf('=');
            if (equalIndex > 0) {
              const key = trimmed.substring(0, equalIndex).trim();
              const value = trimmed.substring(equalIndex + 1).trim();
              try {
                cookies[key] = decodeURIComponent(value);
              } catch (e) {
                cookies[key] = value; // å¦‚æœè§£ç å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹å€¼
              }
            }
          });
        }
        
        console.log('ğŸ” [auth-callback] è§£æåçš„Cookieé”®:', Object.keys(cookies));
        
        // æ£€æŸ¥æ˜¯å¦è®¾ç½®æˆåŠŸï¼ˆCookieæˆ–localStorageä»»ä¸€æˆåŠŸå³å¯ï¼‰
        const hasCookie = cookies['auth_token'] && cookies['auth_token'].length > 0;
        const hasLocalStorage = localStorage.getItem('auth_token') === token;
        
        if (hasCookie || hasLocalStorage) {
          if (hasCookie) {
            console.log('âœ… [auth-callback] CookieéªŒè¯æˆåŠŸï¼ŒTokené•¿åº¦:', cookies['auth_token'].length);
          }
          if (hasLocalStorage) {
            console.log('âœ… [auth-callback] localStorageéªŒè¯æˆåŠŸ');
          }
          // ç­‰å¾…ä¸€ä¸‹ç¡®ä¿å®Œå…¨è®¾ç½®
          setTimeout(() => {
            window.location.href = '/search.html';
          }, 300);
        } else {
          console.error('âŒ [auth-callback] Cookieå’ŒlocalStorageéƒ½è®¾ç½®å¤±è´¥');
          console.error('ğŸ” [auth-callback] æ‰€æœ‰Cookieé”®:', Object.keys(cookies));
          // å³ä½¿è®¾ç½®å¤±è´¥ï¼Œä¹Ÿå°è¯•è·³è½¬ï¼ˆå¯èƒ½localStorageå·²ç»è®¾ç½®äº†ï¼‰
          setTimeout(() => {
            window.location.href = '/search.html?error=' + encodeURIComponent('Cookieè®¾ç½®å¤±è´¥ï¼Œä½†å·²ä½¿ç”¨localStorage');
          }, 1000);
        }
      } catch (e) {
        console.error('âŒ [auth-callback] è®¾ç½®å­˜å‚¨å¤±è´¥:', e);
        console.error('âŒ [auth-callback] é”™è¯¯è¯¦æƒ…:', e.stack);
        // å³ä½¿å‡ºé”™ï¼Œä¹Ÿå°è¯•è·³è½¬
        setTimeout(() => {
          window.location.href = '/search.html?error=' + encodeURIComponent('å­˜å‚¨è®¾ç½®å¤±è´¥: ' + e.message);
        }, 1000);
      }
    } else {
      // æ²¡æœ‰ Tokenï¼Œé‡å®šå‘åˆ°æœç´¢é¡µé¢
      console.error('âŒ [auth-callback] æ²¡æœ‰Tokenå‚æ•°');
      console.error('ğŸ” [auth-callback] URLå‚æ•°:', window.location.search);
      window.location.href = '/search.html?error=' + encodeURIComponent('ç™»å½•å¤±è´¥ï¼šç¼ºå°‘Token');
    }
    })();
  </script>
</body>
</html>

