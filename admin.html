<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>标签管理后台</title>
  <style>
    :root {
      --bg: #F3E9DD;
      --surface: #FAF4EC;
      --text: #5C4033;
      --muted: #D9CBBE;
      --accent: #8B5E3C;
      --accent-2: #6D4C3D;
      --pill-bg: #EADFD2;
    }

    html, body { background: var(--bg); color: var(--text); font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, PingFang SC, Hiragino Sans GB, Microsoft YaHei, Helvetica Neue, Arial, Noto Sans, "Noto Sans CJK SC", sans-serif; }
    body { margin: 24px; max-width: 980px; margin-left: auto; margin-right: auto; }
    h1 { font-size: 24px; margin: 0 0 16px; }
    .card { background: var(--surface); border: 1px solid var(--muted); border-radius: 12px; padding: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 14px; border-radius: 10px; border: 1px solid var(--muted); background: var(--surface); cursor: pointer; }
    .btn.primary { background: var(--accent); color: #fff; border-color: var(--accent); }
    .btn.danger { background: #B5534E; color: #fff; border-color: #B5534E; }
    .btn.small { padding: 6px 10px; border-radius: 8px; }
    .muted { color: #9A8274; font-size: 13px; }
    input[type="text"], textarea { padding: 8px 10px; border: 1px solid var(--muted); border-radius: 8px; background: #fff; color: var(--text); }
    input[type="text"] { height: 34px; }
    .input-sm { height: 30px; padding: 6px 8px; }
    .space { height: 16px; }
    .grid { display: grid; gap: 12px; }
    .category { border: 1px dashed var(--muted); border-radius: 10px; padding: 12px; background: #fff; }
    .category-head { display: flex; align-items: center; gap: 10px; justify-content: space-between; }
    .tags-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .tags-table th, .tags-table td { border-bottom: 1px solid #eee; padding: 8px; text-align: left; }
    .tags-table th { font-weight: 600; color: #7b6558; background: #f9f6f2; }
    .right { text-align: right; }
    .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
    .token-box { display: flex; align-items: center; gap: 8px; }
    .status { margin-top: 10px; font-weight: 600; color: var(--accent-2); }
    .hidden { display: none; }
    .drag-handle { cursor: grab; user-select: none; color: #9A8274; display: inline-flex; align-items: center; justify-content: center; width: 24px; }
    .drag-handle::before { content: "≡"; font-size: 18px; line-height: 1; }
    .dragging { opacity: 0.6; }
    .drag-over { outline: 2px dashed var(--accent); outline-offset: 2px; }
    .col-handle { width: 36px; }
    .big-check { width: 18px; height: 18px; accent-color: var(--accent); }
    .tags-table th, .tags-table td { vertical-align: middle; }
    .tags-table.fixed { width: 100%; table-layout: fixed; }
    .tags-table.fixed th.col-handle, .tags-table.fixed td.col-handle { width: 36px; }
    .tags-table.fixed th.col-name, .tags-table.fixed td.col-name { width: 80%; }
    .tags-table.fixed th.col-op, .tags-table.fixed td.col-op { width: 20%; text-align: center; }
  </style>
</head>
<body>
  <div class="header">
    <h1>标签管理后台</h1>
    <div class="token-box">
      <input type="password" id="adminToken" placeholder="管理员 Token" class="input-sm" style="width:220px;">
      <button class="btn small" id="toggleToken">显示</button>
      <button class="btn primary small" id="saveToken">保存Token</button>
      <button class="btn small" id="clearToken">清除</button>
    </div>
  </div>

  <div class="card" id="guardCard">
    <div class="row">
      <div>
        <div style="font-weight:600; margin-bottom:6px;">需要管理员 Token</div>
        <div class="muted">将通过 Authorization: Bearer 头发送，保存在本地浏览器，不会上传。</div>
      </div>
      <div style="flex:1"></div>
      <button class="btn primary" id="enterAdmin">进入管理</button>
    </div>
  </div>

  <div class="space"></div>

  <div id="editor" class="hidden">
    <div class="card">
      <div class="row" style="justify-content: space-between;">
        <div>
          <div style="font-weight:700;">Tag 分类</div>
          <div class="muted">编辑分类、标签的显示名和提交值，保存后前台自动读取最新配置。</div>
        </div>
        <div class="row">
          <button class="btn" id="reloadConfig">重新加载</button>
          <button class="btn primary" id="saveConfig">保存更改</button>
        </div>
      </div>
      <div class="space"></div>
      <div id="simpleSections" class="grid"></div>
      <div class="space"></div>
      <div id="categories" class="grid"></div>
      <div class="space"></div>
      <div class="card" style="padding:0;border:none;box-shadow:none;background:transparent;">
        <div class="category">
          <div class="category-head">
            <div class="row"><div style="font-weight:700;">分区专属 Tags</div></div>
            <div class="muted">每个分区 = 公共 + 专属；支持分类设为“整类可单选胶囊”。</div>
          </div>
          <div class="space"></div>
          <div id="partitions"></div>
        </div>
      </div>
      <div class="space"></div>
      <button class="btn" id="addCategory">+ 新增分类</button>
      <div id="status" class="status"></div>
    </div>
  </div>

  <script>
    const state = {
      config: null
    };

    function getToken() {
      return localStorage.getItem('admin_token') || (document.getElementById('adminToken').value || '').trim();
    }

    function setStatus(text, isError) {
      const el = document.getElementById('status');
      el.textContent = text || '';
      el.style.color = isError ? '#B5534E' : 'var(--accent-2)';
    }

    function h(tag, attrs = {}, children = []) {
      const el = document.createElement(tag);
      Object.entries(attrs).forEach(([k, v]) => {
        if (k === 'class') el.className = v;
        else if (k === 'text') el.textContent = v;
        else if (k.startsWith('on') && typeof v === 'function') el.addEventListener(k.slice(2), v);
        else el.setAttribute(k, v);
      });
      children.forEach(c => el.appendChild(typeof c === 'string' ? document.createTextNode(c) : c));
      return el;
    }

    async function loadConfig() {
      setStatus('');
      const res = await fetch('/api/config');
      const data = await res.json();
      if (!data.success) throw new Error(data.message || '加载失败');
      state.config = data.config || {};
      renderSimpleSections();
      renderCategories();
    }

  function renderCategories() {
      const container = document.getElementById('categories');
      container.innerHTML = '';
      const categories = Array.isArray(state.config.tagCategories) ? state.config.tagCategories : [];
    categories.forEach((cat, idx) => container.appendChild(renderCategory(cat, idx, { scope: 'root' })));
    }

  function renderSimpleSections() {
    const container = document.getElementById('simpleSections');
    container.innerHTML = '';
    container.appendChild(createSimpleSection('orientations', '性向'));
    container.appendChild(createSimpleSection('backgrounds', '背景'));
    container.appendChild(createSimpleSection('limits', '限制'));
      renderPartitions();
  }

  function createSimpleSection(key, title) {
    if (!Array.isArray(state.config[key])) state.config[key] = [];
    const wrap = h('div', { class: 'category' });
    const head = h('div', { class: 'category-head' }, [
      h('div', { class: 'row' }, [ h('div', { text: title, style: 'font-weight:600;' }) ]),
      h('div', {}, [ h('button', { class: 'btn small', onclick: () => addSimple(key) }, ['+ 添加']) ])
    ]);

      const table = h('table', { class: 'tags-table fixed' });
    const thead = h('thead', {}, [
      h('tr', {}, [
          h('th', { class: 'col-handle', text: ' ' }),
          h('th', { class: 'col-name', text: '名称' }),
          h('th', { class: 'col-op', text: '操作' })
      ])
    ]);
    const tbody = h('tbody');
    state.config[key].forEach((item, idx) => {
      const tr = h('tr', { class: 'simple-row', draggable: 'true', 'data-key': key }, [
        h('td', { class: 'col-handle' }, [ h('span', { class: 'drag-handle', title: '拖动排序', onmousedown: () => { dragState.allowed = true; dragState.simpleKey = key; } }) ]),
        h('td', { class: 'col-name' }, [ h('input', { type: 'text', value: item.label || '', placeholder: '名称', style: 'width:80%;', oninput: (e) => { item.label = e.target.value; item.value = e.target.value; } }) ]),
        h('td', { class: 'col-op' }, [ h('button', { class: 'btn danger small', onclick: () => removeSimple(key, idx) }, ['删除']) ])
      ]);
      tbody.appendChild(tr);
    });
    table.appendChild(thead);
    table.appendChild(tbody);

    wrap.appendChild(head);
    wrap.appendChild(table);
    return wrap;
  }

  function addSimple(key) {
    if (!Array.isArray(state.config[key])) state.config[key] = [];
    state.config[key].push({ label: '', value: '' });
    renderSimpleSections();
  }

  function removeSimple(key, idx) {
    state.config[key].splice(idx, 1);
    renderSimpleSections();
  }

  function renderPartitions() {
    const host = document.getElementById('partitions');
    host.innerHTML = '';
    const keys = [
      { k: 'common', name: '公共' },
      { k: 'feibianxian', name: '非边限' },
      { k: 'bianxian', name: '边限' },
      { k: 'shenyuan', name: '深渊' }
    ];
    if (!state.config.tagPartitions) state.config.tagPartitions = {};
    keys.forEach(({ k, name }) => {
      const section = h('div', { class: 'category', style: 'margin-top:12px;' });
      const head = h('div', { class: 'category-head' }, [
        h('div', { class: 'row' }, [ h('div', { text: name, style: 'font-weight:600;' }) ]),
        h('div', {}, [ h('button', { class: 'btn small', onclick: () => addPartitionCategory(k) }, ['+ 添加分类']) ])
      ]);
      const list = h('div', { class: 'grid' });
      const arr = Array.isArray(state.config.tagPartitions[k]) ? state.config.tagPartitions[k] : (state.config.tagPartitions[k] = []);
      arr.forEach((cat, idx) => list.appendChild(renderCategory(cat, idx, { scope: 'partition', key: k })));
      section.appendChild(head);
      section.appendChild(list);
      host.appendChild(section);
    });
  }

  function addPartitionCategory(key) {
    if (!state.config.tagPartitions) state.config.tagPartitions = {};
    const arr = Array.isArray(state.config.tagPartitions[key]) ? state.config.tagPartitions[key] : (state.config.tagPartitions[key] = []);
    arr.push({ category: '新分类', asPill: false, tags: [] });
    renderPartitions();
  }

    function renderCategory(cat, index, ctx) {
      const box = h('div', { class: 'category', draggable: 'true' });
      const head = h('div', { class: 'category-head' }, [
        h('div', { class: 'row' }, [
          h('span', { class: 'drag-handle', title: '拖动排序', 'data-role': 'cat-handle', onmousedown: () => { dragState.allowed = true; } }),
          h('input', { type: 'text', value: cat.category || '', placeholder: '分类名称', style: 'width:240px;', oninput: (e) => { cat.category = e.target.value; } })
        ]),
        h('div', {}, [
          h('button', { class: 'btn small', onclick: () => { if (!Array.isArray(cat.tags)) cat.tags = []; cat.tags.push({ label: '', value: '' }); (ctx && ctx.scope === 'partition') ? renderPartitions() : renderCategories(); } }, ['+ 添加标签']),
          h('span', { text: ' ' }),
          h('button', { class: 'btn danger small', onclick: () => { if (ctx && ctx.scope === 'partition') { const arr = (state.config.tagPartitions && state.config.tagPartitions[ctx.key]) || []; arr.splice(index, 1); renderPartitions(); } else { state.config.tagCategories.splice(index, 1); renderCategories(); } } }, ['删除分类'])
        ])
      ]);

      const table = h('table', { class: 'tags-table fixed' });
      const thead = h('thead', {}, [
        h('tr', {}, [
          h('th', { class: 'col-handle', text: ' ' }),
          h('th', { class: 'col-name', text: '显示名' }),
          h('th', { class: 'col-op', text: '操作' })
        ])
      ]);
      const tbody = h('tbody');
      (Array.isArray(cat.tags) ? cat.tags : []).forEach((tag, tIdx) => {
        const tr = h('tr', { class: 'tag-row', draggable: 'true' }, [
          h('td', { class: 'col-handle' }, [ h('span', { class: 'drag-handle', title: '拖动排序', onmousedown: () => { dragState.allowed = true; dragState.tagCatIndex = index; } }) ]),
          h('td', { class: 'col-name' }, [h('input', { type: 'text', value: tag.label || '', placeholder: '如 校园', style: 'width:80%;', oninput: (e) => { tag.label = e.target.value; tag.value = e.target.value; } })]),
          h('td', { class: 'col-op' }, [h('button', { class: 'btn danger small', onclick: () => { cat.tags.splice(tIdx, 1); (ctx && ctx.scope === 'partition') ? renderPartitions() : renderCategories(); } }, ['删除'])])
        ]);
        tbody.appendChild(tr);
      });
      table.appendChild(thead);
      table.appendChild(tbody);

      // 分类设置：是否作为整类可单独点选（胶囊）
      const pillRow = h('div', { class: 'row', style: 'margin-top:8px; align-items:center; gap:10px;' }, [
        h('label', {}, [
          h('input', { class: 'big-check', type: 'checkbox', checked: !!cat.asPill, onchange: (e) => { cat.asPill = e.target.checked; } }),
          document.createTextNode(' 整类可点选（胶囊）')
        ])
      ]);

      box.appendChild(head);
      box.appendChild(pillRow);
      box.appendChild(table);

      // --- 拖拽（分类） ---
      box.addEventListener('dragstart', (e) => {
        if (!dragState.allowed) { e.preventDefault(); return; }
        dragState.mode = 'category';
        dragState.srcCat = index;
        e.dataTransfer && (e.dataTransfer.effectAllowed = 'move');
        box.classList.add('dragging');
        // 还原 handle 授权标记
        setTimeout(() => { dragState.allowed = false; }, 0);
      });
      box.addEventListener('dragend', () => {
        box.classList.remove('dragging');
        document.querySelectorAll('.category.drag-over').forEach(el => el.classList.remove('drag-over'));
      });
      box.addEventListener('dragover', (e) => {
        if (dragState.mode === 'category') { e.preventDefault(); box.classList.add('drag-over'); }
      });
      box.addEventListener('dragleave', () => { box.classList.remove('drag-over'); });
      box.addEventListener('drop', (e) => {
        e.preventDefault();
        box.classList.remove('drag-over');
        if (dragState.mode !== 'category') return;
        const from = dragState.srcCat;
        const to = index;
        if (from === undefined || to === undefined || from === to) return;
        const arr = (ctx && ctx.scope === 'partition') ? ((state.config.tagPartitions && state.config.tagPartitions[ctx.key]) || []) : (state.config.tagCategories || []);
        const [m] = arr.splice(from, 1);
        arr.splice(to, 0, m);
        setStatus('已调整分类顺序（未保存）');
        (ctx && ctx.scope === 'partition') ? renderPartitions() : renderCategories();
      });
      return box;
    }

  function addCategory() {
      if (!Array.isArray(state.config.tagCategories)) state.config.tagCategories = [];
      state.config.tagCategories.push({ category: '新分类', tags: [] });
      renderCategories();
    }
  

    // --- 拖拽（标签行） ---
    document.addEventListener('dragstart', (e) => {
      const tr = e.target && e.target.closest && e.target.closest('tr.tag-row');
      if (!tr) return;
      if (!dragState.allowed) { e.preventDefault(); return; }
      const tbody = tr.parentElement;
      const catBox = tr.closest('.category');
      const allCategories = Array.from(document.querySelectorAll('#categories .category'));
      const catIndex = allCategories.indexOf(catBox);
      const rows = Array.from(tbody.querySelectorAll('tr.tag-row'));
      const rowIndex = rows.indexOf(tr);
      dragState.mode = 'tag';
      dragState.srcCat = catIndex;
      dragState.srcTag = rowIndex;
      e.dataTransfer && (e.dataTransfer.effectAllowed = 'move');
      tr.classList.add('dragging');
      setTimeout(() => { dragState.allowed = false; }, 0);
    });
    document.addEventListener('dragend', (e) => {
      const tr = e.target && e.target.closest && e.target.closest('tr.tag-row');
      if (tr) tr.classList.remove('dragging');
      document.querySelectorAll('tr.tag-row.drag-over').forEach(el => el.classList.remove('drag-over'));
    });
    document.addEventListener('dragover', (e) => {
      const tr = e.target && e.target.closest && e.target.closest('tr.tag-row');
      if (!tr) return;
      if (dragState.mode === 'tag') { e.preventDefault(); tr.classList.add('drag-over'); }
    });
    document.addEventListener('dragleave', (e) => {
      const tr = e.target && e.target.closest && e.target.closest('tr.tag-row');
      if (tr) tr.classList.remove('drag-over');
    });
    document.addEventListener('drop', (e) => {
      const tr = e.target && e.target.closest && e.target.closest('tr.tag-row');
      if (!tr) return;
      e.preventDefault();
      tr.classList.remove('drag-over');
      if (dragState.mode !== 'tag') return;
      // 仅限同分类内排序
      const allCategories = Array.from(document.querySelectorAll('#categories .category'));
      const targetCatBox = tr.closest('.category');
      const targetCatIndex = allCategories.indexOf(targetCatBox);
      if (targetCatIndex !== dragState.srcCat) return;
      const rows = Array.from(tr.parentElement.querySelectorAll('tr.tag-row'));
      const to = rows.indexOf(tr);
      const from = dragState.srcTag;
      if (from === undefined || to === undefined || from === to) return;
      const cat = (state.config.tagCategories || [])[targetCatIndex];
      if (!cat || !Array.isArray(cat.tags)) return;
      const [m] = cat.tags.splice(from, 1);
      cat.tags.splice(to, 0, m);
      setStatus('已调整标签顺序（未保存）');
      renderCategories();
    });

    // --- 拖拽（简单数组：性向/背景/限制） ---
    document.addEventListener('dragstart', (e) => {
      const tr = e.target && e.target.closest && e.target.closest('tr.simple-row');
      if (!tr) return;
      if (!dragState.allowed) { e.preventDefault(); return; }
      const key = tr.getAttribute('data-key');
      const rows = Array.from(tr.parentElement.querySelectorAll('tr.simple-row'));
      dragState.mode = 'simple';
      dragState.simpleKey = key;
      dragState.srcIndex = rows.indexOf(tr);
      e.dataTransfer && (e.dataTransfer.effectAllowed = 'move');
      tr.classList.add('dragging');
      setTimeout(() => { dragState.allowed = false; }, 0);
    });
    document.addEventListener('dragend', (e) => {
      const tr = e.target && e.target.closest && e.target.closest('tr.simple-row');
      if (tr) tr.classList.remove('dragging');
      document.querySelectorAll('tr.simple-row.drag-over').forEach(el => el.classList.remove('drag-over'));
    });
    document.addEventListener('dragover', (e) => {
      const tr = e.target && e.target.closest && e.target.closest('tr.simple-row');
      if (!tr) return;
      if (dragState.mode === 'simple') { e.preventDefault(); tr.classList.add('drag-over'); }
    });
    document.addEventListener('dragleave', (e) => {
      const tr = e.target && e.target.closest && e.target.closest('tr.simple-row');
      if (tr) tr.classList.remove('drag-over');
    });
    document.addEventListener('drop', (e) => {
      const tr = e.target && e.target.closest && e.target.closest('tr.simple-row');
      if (!tr) return;
      e.preventDefault();
      tr.classList.remove('drag-over');
      if (dragState.mode !== 'simple') return;
      const key = tr.getAttribute('data-key');
      if (key !== dragState.simpleKey) return;
      const rows = Array.from(tr.parentElement.querySelectorAll('tr.simple-row'));
      const to = rows.indexOf(tr);
      const from = dragState.srcIndex;
      if (from === undefined || to === undefined || from === to) return;
      const arr = state.config[key];
      const [m] = arr.splice(from, 1);
      arr.splice(to, 0, m);
      setStatus('已调整顺序（未保存）');
      renderSimpleSections();
    });

    async function saveConfig() {
      setStatus('保存中...');
      const token = getToken();
      if (!token) { setStatus('请先输入并保存管理员 Token', true); return; }
      const body = {
        tagCategories: state.config.tagCategories,
        orientations: state.config.orientations,
        backgrounds: state.config.backgrounds,
        limits: state.config.limits,
        tagPartitions: state.config.tagPartitions
      };
      try {
        const res = await fetch('/api/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
          body: JSON.stringify(body)
        });
        const data = await res.json();
        if (!res.ok || !data.success) throw new Error(data.message || '保存失败');
        state.config = data.config;
        renderSimpleSections();
        renderCategories();
        setStatus('已保存');
      } catch (e) {
        setStatus('保存失败：' + e.message, true);
      }
    }

    // 拖拽状态
    const dragState = { mode: null, srcCat: null, srcTag: null, allowed: false, tagCatIndex: null, simpleKey: null, srcIndex: null };

    // UI wiring
    document.getElementById('addCategory').addEventListener('click', addCategory);
    document.getElementById('saveConfig').addEventListener('click', saveConfig);
    document.getElementById('reloadConfig').addEventListener('click', () => loadConfig().then(() => setStatus('已重新加载')).catch(e => setStatus('加载失败：' + e.message, true)));

    document.getElementById('toggleToken').addEventListener('click', () => {
      const el = document.getElementById('adminToken');
      el.type = el.type === 'password' ? 'text' : 'password';
    });
    document.getElementById('saveToken').addEventListener('click', () => {
      const v = (document.getElementById('adminToken').value || '').trim();
      if (v) localStorage.setItem('admin_token', v);
      setStatus('Token 已保存在本地');
    });
    document.getElementById('clearToken').addEventListener('click', () => {
      localStorage.removeItem('admin_token');
      document.getElementById('adminToken').value = '';
      setStatus('Token 已清除');
    });
    document.getElementById('enterAdmin').addEventListener('click', () => {
      const token = getToken();
      if (!token) { setStatus('请输入 Token', true); return; }
      localStorage.setItem('admin_token', token);
      document.getElementById('guardCard').classList.add('hidden');
      document.getElementById('editor').classList.remove('hidden');
      loadConfig().catch(e => setStatus('加载失败：' + e.message, true));
    });

    // Init
    (function init() {
      const saved = localStorage.getItem('admin_token');
      if (saved) {
        document.getElementById('adminToken').value = saved;
        document.getElementById('guardCard').classList.add('hidden');
        document.getElementById('editor').classList.remove('hidden');
        loadConfig().catch(e => setStatus('加载失败：' + e.message, true));
      }
    })();
  </script>
</body>
</html>


