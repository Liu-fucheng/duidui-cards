<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>角色卡上传</title>
  
  <!-- Material UI CSS -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  
  <style>
    :root {
      --bg: #F3E9DD;        /* 淡米棕 */
      --surface: #FAF4EC;   /* 浅面板 */
      --text: #5C4033;      /* 深咖 */
      --muted: #D9CBBE;     /* 浅分割 */
      --accent: #8B5E3C;    /* 咖啡主色 */
      --accent-2: #6D4C3D;  /* 按下更深色 */
      --pill-bg: #EADFD2;   /* Tag 未选背景 */
    }

    html, body {
      background: var(--bg);
      color: var(--text);
      font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, PingFang SC, Hiragino Sans GB, Microsoft YaHei, Helvetica Neue, Arial, Noto Sans, "Noto Sans CJK SC", sans-serif;
    }

    body {
      margin: 24px;
      max-width: 860px;
      margin-left: auto;
      margin-right: auto;
    }

    .hidden { display: none; }

    h1 {
      font-size: 28px;
      margin: 8px 0 20px;
      letter-spacing: 0.5px;
    }

    h2 {
      font-size: 20px;
      margin: 24px 0 12px;
      letter-spacing: 0.2px;
    }

    /* 顶部导航/页脚 */
    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #F7EFE6;
      border: 1px solid var(--muted);
      border-radius: 12px;
      padding: 10px 14px;
      margin-bottom: 16px;
    }
    .brand { font-weight: 700; color: var(--accent-2); letter-spacing: 0.5px; }
    .nav-actions { display: flex; gap: 10px; align-items: center; }
    .link { color: var(--accent); text-decoration: none; padding: 6px 8px; border-radius: 8px; }
    .link:hover { background: var(--pill-bg); }

    .app-footer {
      margin-top: 20px;
      padding: 12px 0;
      color: #9A8274;
      font-size: 13px;
      text-align: center;
      border-top: 1px dashed var(--muted);
    }

    /* 步骤指示器 */
    .steps {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      position: relative;
    }
    .steps::before {
      content: "";
      position: absolute;
      top: 16px;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--muted);
      z-index: 0;
    }
    .step {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      position: relative;
      z-index: 1;
      flex: 1;
    }
    .step-circle {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--surface);
      border: 2px solid var(--muted);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: var(--text);
      transition: all 0.2s ease;
    }
    .step.active .step-circle {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
      box-shadow: 0 0 0 4px rgba(139,94,60,0.12);
    }
    .step.completed .step-circle {
      background: var(--accent-2);
      border-color: var(--accent-2);
      color: #fff;
    }
    .step-label {
      font-size: 12px;
      color: #9A8274;
    }
    .step.active .step-label {
      color: var(--accent-2);
      font-weight: 600;
    }

    form {
      background: var(--surface);
      border: 1px solid var(--muted);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .field {
      margin-bottom: 14px;
      padding-bottom: 12px;
      border-bottom: 1px dashed var(--muted);
    }

    .field:last-child {
      border-bottom: none;
      padding-bottom: 0;
      margin-bottom: 0;
    }

    .field > label.group-label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
    }

    /* 行内字段：标签与输入同一行，并限制输入宽度较短 */
    .inline-field { display: flex; align-items: center; gap: 10px; flex-wrap: nowrap; }
    .inline-field .group-label { margin: 0; display: inline-block; white-space: nowrap; }
    .short-input { width: 220px; max-width: 60vw; }


    input[type="text"], textarea, select {
      width: 100%;
      padding: 10px 12px;
      box-sizing: border-box;
      color: var(--text);
      background: #fff;
      border: 1px solid var(--muted);
      border-radius: 8px;
      outline: none;
    }
    #tagsSearch {
      padding: 10px 12px 10px 30px;
    }
    
    input[type="text"]:focus, textarea:focus, select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(139,94,60,0.12);
    }

    textarea {
      min-height: 100px;
      max-height: calc(1.5em * 20 + 24px); /* 大约20行 + 内边距 */
      overflow: auto;
      resize: vertical;
    }

    /* 行内选项布局 - 使用系统控件 + 咖啡色 */
    .inline-options {
      display: flex;
      flex-wrap: wrap;
      gap: 8px 12px;
      align-items: center;
    }

    /* 统一原生控件颜色为咖啡色，避免默认蓝色 */
    .inline-options input[type="checkbox"],
    .inline-options input[type="radio"] {
      accent-color: var(--accent);
      width: 22px;
      height: 22px;
    }
    .inline-options label { display: inline-flex; align-items: center; gap: 6px; white-space: nowrap; }

    /* 兼容任意 UI 库类名（若存在） */
    .MuiCheckbox-root, .MuiRadio-root { color: var(--accent) !important; }
    .MuiCheckbox-root.Mui-checked, .MuiRadio-root.Mui-checked { color: var(--accent) !important; }
    .MuiFormControlLabel-root { margin-right: 8px !important; }

    /* Tag 胶囊按钮 */
    .pill-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .pill {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      height: 36px;
      padding: 0 14px;
      border-radius: 999px;
      border: 1px solid var(--muted);
      background: var(--pill-bg);
      color: var(--text);
      cursor: pointer;
      transition: background 0.15s ease, box-shadow 0.15s ease, border-color 0.15s ease;
      overflow: hidden;
      user-select: none;
    }
    .pill-lg { height: 42px; padding: 0 18px; font-size: 16px; font-weight: 600; }
    .category-line { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; margin-bottom: 6px; }
    .category-sep { color: #876; margin: 0 4px; }
    .pill:hover { border-color: var(--accent); }
    .pill:active { background: #E4D6C6; }
    input[type="checkbox"].pill-input { position: absolute; opacity: 0; pointer-events: none; }
    input[type="checkbox"].pill-input:checked + label.pill {
      background: #DFCDBB;
      border-color: var(--accent);
      box-shadow: inset 0 0 0 2px rgba(139,94,60,0.18);
    }

    /* 提交按钮 */
    .btn-primary {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      font-size: 16px;
      color: #fff;
      background: var(--accent);
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.15s ease, box-shadow 0.15s ease;
      overflow: hidden;
    }
    .btn-primary:hover { box-shadow: 0 2px 10px rgba(139,94,60,0.25); }
    .btn-primary:active { background: var(--accent-2); }
    .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; box-shadow: none; }

    #uploadStatus {
      font-weight: 600;
      margin-top: 15px;
      padding: 10px;
      color: var(--accent-2);
    }

    /* 列表卡片 */
    #cardList {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 14px;
    }
    .card {
      background: var(--surface);
      border: 1px solid var(--muted);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .card h3 { margin: 4px 0 6px; font-size: 18px; }
    .card p { margin: 4px 0; line-height: 1.5; }

    /* 简易 Material 风格 Ripple */
    .ripple { position: relative; overflow: hidden; }
    .ripple::after {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: radial-gradient(circle, rgba(255,255,255,0.35) 10%, rgba(255,255,255,0) 11%) center/0 0 no-repeat;
      transition: background-size 0.45s ease, opacity 0.6s ease;
      opacity: 0;
    }
    .ripple:active::after {
      background-size: 3000% 3000%;
      opacity: 1;
      transition: 0s;
    }

    /* 两列行布局（卡片类型 + 卡名） */
    .row-2 {
      display: grid;
      grid-template-columns: minmax(260px, 1fr) 1.2fr;
      gap: 16px;
      align-items: start;
    }
    @media (max-width: 640px) {
      .row-2 { grid-template-columns: 1fr; }
    }

    /* 角色名胶囊（复用 tag pill 样式，可编辑可删除） */
    .chip-list { 
      display: flex; 
      flex-wrap: wrap; 
      gap: 10px; 
    }
    .chip-row { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    .character-chip {
      position: relative;
      display: inline-flex;
      align-items: center;
      height: 36px;
      min-width: 100px;
      border-radius: 999px;
      border: 1px solid var(--muted);
      background: linear-gradient(0deg, var(--pill-bg), var(--pill-bg)) padding-box, transparent border-box; /* 固定一致背景 */
      overflow: hidden;
    }
    .character-chip input {
      border: none;
      background: transparent;
      outline: none;
      color: var(--text);
      padding: 0 12px; /* 左右对称，显出开头文字 */
      margin-right: 28px; /* 给删除按钮留出空间 */
      height: 100%;
      min-width: 80px; /* 默认更窄的最小宽 */
      width: 80px; /* 初始宽度，后续用 JS 精确设置 */
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      box-shadow: none; /* 避免全局 input:focus 阴影在胶囊内形成浅棕分割 */
    }
    .character-chip input:focus { background: transparent; box-shadow: none !important; }
    /* 去掉浅棕色分割效果，改为外圈边框高亮 */
    .character-chip:focus-within { box-shadow: 0 0 0 0 rgba(0,0,0,0); border-color: var(--accent); }
    .character-chip .delete-btn {
      position: absolute;
      right: 6px;
      top: 50%;
      transform: translateY(-50%);
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: var(--accent);
      color: #fff;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      line-height: 1;
      opacity: 0.8;
      transition: opacity 0.15s ease;
      padding: 0;
    }
    .character-chip .delete-btn:hover { opacity: 1; background: var(--accent-2); }

    .add-chip-btn {
      width: 36px; height: 36px; border-radius: 50%; border: none; cursor: pointer; color: #fff;
      background: var(--accent); display: inline-flex; align-items: center; justify-content: center;
      font-size: 20px; line-height: 1; box-shadow: 0 2px 8px rgba(139,94,60,0.25);
    }
    .add-chip-btn:active { background: var(--accent-2); }

    /* 文件上传区域 */
    .upload-zone {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: flex-start;
    }
    .upload-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      height: 36px;
      padding: 0 14px;
      border-radius: 18px;
      border: none;
      background: var(--accent);
      color: #fff;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.15s ease;
    }
    .upload-btn:hover { background: var(--accent-2); }
    .upload-thumbnail {
      position: relative;
      width: 140px;
      height: 140px;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid var(--muted);
    }
    .upload-thumbnail img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .upload-thumbnail .remove {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--accent);
      color: #fff;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      opacity: 0.9;
    }
    .upload-thumbnail .remove:hover { opacity: 1; background: var(--accent-2); }
    input[type="file"] { display: none; }

    /* 预览区域使用 Grid，优先横排，空间不足再换行 */
    .preview-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 16px;
      align-items: start;
      width: 100%;
    }

    /* Tags 分类和搜索 */
    .tags-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: nowrap; gap: 12px; }
    .tags-header .group-label { white-space: nowrap; margin: 0; }
    .tags-search-wrapper {
      position: relative;
      width: 160px;
      margin-left: auto;
    }
    .tags-search-icon {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: #9A8274;
      font-size: 18px;
      pointer-events: none;
    }
    .tags-search { 
      width: 100%;
      padding: 8px 12px 8px 40px; 
      border: 1px solid var(--muted); 
      border-radius: 20px; 
      outline: none;
      font-size: 13px;
      background: #fff;
      transition: all 0.2s ease;
    }
    .tags-search:focus { 
      border-color: var(--accent); 
      box-shadow: 0 0 0 3px rgba(139,94,60,0.12); 
    }
    .tag-category { margin-bottom: 14px; }
    .tag-category-title { 
      font-size: 13px; 
      color: #876; 
      margin-bottom: 6px; 
      font-weight: 500;
    }
    .tag-category .pill-group { margin-left: 8px; }
    .tag-category.hidden { display: none; }

    /* 锁定样式 */
    .locked { 
      background: #F0EAE3 !important; 
      cursor: not-allowed !important;
    }

    /* 隐藏的 authorId 字段 */
    #authorId { display: none; }
  </style>
</head>
<body>

  <header class="app-header">
    <div class="brand">堆堆demo</div>
    <nav class="nav-actions">
      <a class="link" href="#upload" id="navUpload">上传</a>
      <a class="link" href="#list" id="navList">列表</a>
    </nav>
  </header>

  <!-- 步骤指示器 -->
  <div class="steps">
    <div class="step active" data-step="1" id="step1">
      <div class="step-circle">1</div>
      <div class="step-label">基础信息</div>
    </div>
    <div class="step" data-step="2" id="step2">
      <div class="step-circle">2</div>
      <div class="step-label">分类标签</div>
    </div>
    <div class="step" data-step="3" id="step3">
      <div class="step-circle">3</div>
      <div class="step-label">文件上传</div>
    </div>
  </div>

  <h1 id="upload">上传你的角色卡</h1>
  <form id="uploadForm">

    <div id="section-base" class="field">
      <div class="inline-field" style="margin-top:0;">
        <label class="group-label" for="category">分区:</label>
        <input type="text" id="category" name="category" class="short-input" />
      </div>
      <div class="inline-field" style="margin-top:10px; align-items:center; gap:16px; flex-wrap:nowrap;">
        <label class="group-label">作者:</label>
        <div class="inline-options" style="flex-wrap:nowrap;">
          <label><input type="radio" name="authorType" value="real" checked class="mui-radio"> 实名</label>
          <label><input type="radio" name="authorType" value="anonymous" class="mui-radio"> 匿名</label>
        </div>
        <input type="text" id="authorName" name="authorName" class="short-input" />
        <input type="hidden" id="authorId" name="authorId" />
      </div>
      <div class="inline-field" style="margin-top:10px; justify-content:space-between;">
        <div style="display:flex; align-items:center; gap:10px;">
          <label class="group-label">类型*:</label>
          <div class="inline-options">
            <label><input type="radio" name="cardType" value="single" checked class="mui-radio"> 单人卡</label>
            <label><input type="radio" name="cardType" value="multi" class="mui-radio"> 多人卡</label>
          </div>
        </div>
        <div id="nameRelationGroup" class="inline-options">
          <span class="group-label" style="margin:0;">角色与卡</span>
          <label><input type="radio" name="nameRelation" value="same" checked class="mui-radio"> 同名</label>
          <label><input type="radio" name="nameRelation" value="different" class="mui-radio"> 不同名</label>
        </div>
      </div>
      <div class="inline-field" style="margin-top:10px;">
        <label class="group-label" for="cardName">卡名:</label>
        <input type="text" id="cardName" name="cardName" class="short-input" required />
      </div>
    </div>

    <div id="singleCharacterContainer" class="field hidden">
      <div class="inline-field" style="margin-top:0;">
        <label class="group-label" for="singleCharacterName">角色名:</label>
        <input type="text" id="singleCharacterName" name="characters" class="short-input" placeholder="角色名" />
      </div>
    </div>
    
    <div id="multiCharactersContainer" class="field hidden">
      <label class="group-label">角色名:</label>
      <div class="chip-row" style="margin-top:6px;">
        <div id="characterList" class="chip-list"><!-- 动态生成胶囊输入 --></div>
        <button type="button" id="addCharacterBtn" class="add-chip-btn" title="增加角色">+</button>
      </div>
    </div>
    
    <!-- 作者类型已合并到作者行 -->

    <div id="section-tags">
      <div id="customSectionsHost">
        <!-- 自定义板块将通过 JavaScript 动态添加 -->
      </div>
    </div>

    <div class="field">
      <div class="tags-header">
        <label class="group-label">Tags</label>
        <div class="tags-search-wrapper">
          <span class="tags-search-icon material-icons">search</span>
          <input type="text" class="tags-search" id="tagsSearch" placeholder="搜索...">
        </div>
      </div>
      <div id="tagsOptions">
        <!-- 动态从配置加载分类 -->
    </div>
    </div>
    

    <div class="field">
      <label class="group-label" for="warnings">排雷:</label>
      <textarea id="warnings" name="warnings"></textarea>
    </div>

    <div class="field">
      <label class="group-label" for="description">简介:</label>
      <textarea id="description" name="description"></textarea>
    </div>

    <div class="field">
      <label class="group-label">下载前二次排雷:</label>
      <div class="inline-options">
        <label><input type="radio" name="secondaryWarningToggle" value="no" checked class="mui-radio"> 否</label>
        <label><input type="radio" name="secondaryWarningToggle" value="yes" class="mui-radio"> 是</label>
      </div>
    </div>
    <div id="secondaryWarningContainer" class="field hidden">
      <label class="group-label" for="secondaryWarning">二次排雷内容:</label>
      <textarea id="secondaryWarning" name="secondaryWarning"></textarea>
    </div>

    <div id="section-files" class="field">
      <label class="group-label">主楼图片 (可多图):</label>
      <input type="file" id="galleryImages" name="galleryImages" multiple accept="image/*" />
      <div class="upload-zone">
        <button type="button" class="upload-btn" onclick="document.getElementById('galleryImages').click()">+ 添加图片</button>
        <div id="galleryPreviews" class="preview-grid"></div>
      </div>
    </div>

    <div class="field">
      <label class="group-label">角色卡* (.png / .json):</label>
      <input type="file" id="cardFile" name="cardFile" required accept=".png,.json" />
      <div class="upload-zone">
        <button type="button" class="upload-btn" onclick="document.getElementById('cardFile').click()">+ 选择文件</button>
        <div id="cardFilePreviews" class="preview-grid"></div>
      </div>
    </div>

    <div class="field">
      <label class="group-label">其它附件 (可多图):</label>
      <input type="file" id="attachments" name="attachments" multiple />
      <div class="upload-zone">
        <button type="button" class="upload-btn" onclick="document.getElementById('attachments').click()">+ 添加附件</button>
        <div id="attachmentPreviews" class="preview-grid"></div>
      </div>
    </div>

    <button type="submit" id="submitButton" class="btn-primary ripple">上传</button>
  </form>

  <div id="uploadStatus"></div>

  <hr style="margin: 32px 0; border: none; border-top: 1px dashed var(--muted);">
  <h2 id="list">已上传的卡片</h2>
  <div id="cardList">正在加载...</div>

  <footer class="app-footer">
    © 2025 堆堆Demo
  </footer>

<!-- Material UI JS (使用 CDN) -->
<script src="https://unpkg.com/@mui/material@5.15.0/umd/material-ui.production.min.js"></script>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

<script>
  // --- 全局配置（从服务端加载） ---
  let CONFIG = {};

  // 尝试从服务端加载配置
  async function loadConfig() {
    try {
      const response = await fetch('/api/config');
      const data = await response.json();
      if (data.success) {
        CONFIG = data.config;
      }
    } catch (error) {
      console.error('配置加载失败', error);
    }
    renderOptions();
  }

  // 渲染选项（使用简单的 checkbox，Material UI 样式会自动应用）
  function renderOptions() {
    // 兜底：确保 CONFIG 有必要的数组
    if (!CONFIG.tagCategories) CONFIG.tagCategories = [];
    
    // 自定义板块（按 sections 顺序渲染）
    const secHost = document.getElementById('customSectionsHost');
    if (secHost) {
      const sections = Array.isArray(CONFIG.customSections) ? CONFIG.customSections : [];
      const order = Array.isArray(CONFIG.sections) ? CONFIG.sections : [];
      const htmls = [];
      order.forEach(key => {
        if (key === 'partition') return; // partition 不在这里显示
        if (key.startsWith('custom:')) {
          const title = key.slice(7);
          const sec = sections.find(s => s && s.title === title);
          if (!sec) return;
          const inputType = sec.multiple === false ? 'radio' : 'checkbox';
          const items = (sec.items || []).map((it, i) => {
            const name = sec.multiple === false ? `custom_${title}` : `custom_${title}[]`;
            const showIf = it.enableIf ? `data-showif="${it.enableIf}"` : '';
            const mutex = it.mutexWith && it.mutexWith.length ? `data-mutex="${it.mutexWith.join(',')}"` : '';
            return `<label class="option-item" ${showIf}><input type="${inputType}" name="${name}" value="${it.value}" ${mutex}> ${it.label}</label>`;
          }).join('');
          const fieldId = `section_${title.replace(/\s/g,'_')}`;
          const showIf = sec.showIf ? `data-showif="${sec.showIf}"` : '';
          htmls.push(`<div class="field" id="${fieldId}" ${showIf}><label class="group-label">${sec.title}:</label><div class="inline-options">${items}</div></div>`);
        }
      });
      secHost.innerHTML = htmls.join('');
      
      // 绑定依赖与互斥逻辑
      bindConditionalLogic();
    }

    // Tags 初次渲染
    renderTagsByPartition();

    // 监听分区变化，实时切换标签集合
    const categoryInput = document.getElementById('category');
    if (categoryInput) {
      categoryInput.addEventListener('input', () => {
        // 防抖：避免第三方脚本触发频繁渲染导致卡顿
        clearTimeout(window.__renderTagsDebounce);
        window.__renderTagsDebounce = setTimeout(() => {
          renderTagsByPartition();
        }, 120);
      }, { passive: true });
    }
  }

  function renderTagsByPartition() {
    const tagsOptions = document.getElementById('tagsOptions');
    if (!tagsOptions) return;
    let tagIndex = 0;

    const categories = getEffectiveCategories();
    tagsOptions.innerHTML = categories.map((cat) => {
      // 子标签
      const subPills = (cat.tags || []).map(opt => {
        const id = `tag${tagIndex++}`;
        const val = (opt.value || opt.label);
        return `<input class="pill-input" type="checkbox" id="${id}" name="tags" value="${val}">
        <label class="pill ripple" for="${id}">${opt.label}</label>`;
      });

      let headerHtml;
      if (cat.asPill && cat.category) {
        // 类可选：标题渲染为更大的胶囊，并在同一行加一个连字符，再接小类
        const id = `tag${tagIndex++}`;
        const label = cat.pillLabel || cat.category;
        const value = cat.category;
        const catPill = `<input class="pill-input" type="checkbox" id="${id}" name="tags" value="${value}">
          <label class="pill pill-lg ripple" for="${id}">${label}</label>`;
        headerHtml = `<div class="category-line">${catPill}<span class="category-sep">-</span>${subPills.join('')}</div>`;
      } else {
        // 普通：显示文字标题，下面一行显示小类
        headerHtml = `<div class="tag-category-title">${cat.category}</div><div class="pill-group">${subPills.join('')}</div>`;
      }

      return `<div class="tag-category" data-category="${cat.category}">${headerHtml}</div>`;
    }).join('');

    // Tags 搜索功能（仅绑定一次）
    const tagsSearch = document.getElementById('tagsSearch');
    if (tagsSearch && !tagsSearch.dataset.bound) {
      tagsSearch.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase().trim();
        document.querySelectorAll('.tag-category').forEach(cat => {
          const pills = cat.querySelectorAll('.pill');
          let hasVisible = false;
          pills.forEach(pill => {
            const match = pill.textContent.toLowerCase().includes(query);
            pill.style.display = match || !query ? '' : 'none';
            if (match || !query) hasVisible = true;
          });
          cat.classList.toggle('hidden', !hasVisible);
        });
      });
      tagsSearch.dataset.bound = '1';
    }
  }

  function getEffectiveCategories() {
    const common = Array.isArray(CONFIG.tagCategories) ? CONFIG.tagCategories : [];
    const partitions = (CONFIG.tagPartitions || {});
    const cateInput = document.getElementById('category');
    const raw = (cateInput && cateInput.value || '').trim();
    const map = { '非边限': 'feibianxian', '边限': 'bianxian', '深渊': 'shenyuan' };
    const key = map[raw] || null;
    const extra = key && Array.isArray(partitions[key]) ? partitions[key] : [];
    return mergeCategoriesByName(common, extra);
  }

  function mergeCategoriesByName(base, extra) {
    const byName = new Map();
    const add = (arr) => {
      (arr || []).forEach(cat => {
        if (!cat || !cat.category) return;
        if (!byName.has(cat.category)) {
          byName.set(cat.category, { category: cat.category, asPill: !!cat.asPill, pillLabel: cat.pillLabel, pillValue: cat.pillValue, tags: [] });
        }
        const entry = byName.get(cat.category);
        // 合并 asPill 等设置（后者优先）
        if (cat.asPill) entry.asPill = true;
        if (cat.pillLabel) entry.pillLabel = cat.pillLabel;
        if (cat.pillValue) entry.pillValue = cat.pillValue;
        // 合并并去重标签
        const seen = new Set(entry.tags.map(t => t.value));
        (cat.tags || []).forEach(t => {
          if (t && typeof t.value === 'string' && !seen.has(t.value)) {
            entry.tags.push({ value: t.value, label: t.label });
            seen.add(t.value);
          }
        });
      });
    };
    add(base);
    add(extra);
    return Array.from(byName.values());
  }

  function bindConditionalLogic() {
    // 监听所有 checkbox/radio 变化，动态显示/禁用板块和选项
    document.querySelectorAll('input[type="checkbox"], input[type="radio"]').forEach(input => {
      input.addEventListener('change', updateConditionalUI);
    });
    updateConditionalUI();
  }

  function updateConditionalUI() {
    const formData = new FormData(document.getElementById('uploadForm'));
    const selected = {};
    for (const [k, v] of formData.entries()) {
      if (!selected[k]) selected[k] = [];
      selected[k].push(v);
    }

    // 板块显示条件
    document.querySelectorAll('.field[data-showif]').forEach(field => {
      const cond = field.getAttribute('data-showif');
      field.style.display = checkCondition(cond, selected) ? '' : 'none';
    });

    // 选项显示条件（隐藏整个 label，而不是 disabled）
    document.querySelectorAll('.option-item[data-showif]').forEach(label => {
      const cond = label.getAttribute('data-showif');
      label.style.display = checkCondition(cond, selected) ? '' : 'none';
    });

    // 互斥逻辑
    document.querySelectorAll('input[data-mutex]').forEach(input => {
      if (!input.checked) return;
      const mutexValues = (input.getAttribute('data-mutex') || '').split(',').map(x => x.trim()).filter(Boolean);
      const name = input.name;
      document.querySelectorAll(`input[name="${name}"]`).forEach(other => {
        if (other === input) return;
        if (mutexValues.includes(other.value)) {
          other.checked = false;
        }
      });
    });
  }

  function checkCondition(cond, selected) {
    if (!cond) return true;
    const parts = cond.split(':');
    if (parts.length !== 2) return true;
    const [field, value] = parts.map(x => x.trim());
    const vals = selected[field] || selected[field+'[]'] || [];
    return vals.includes(value);
  }


  // --- 角色名胶囊管理 ---
  const characterList = document.getElementById('characterList');

  function createCharacterChip(placeholder) {
    const chip = document.createElement('div');
    chip.className = 'character-chip';
    
    const input = document.createElement('input');
    input.type = 'text';
    input.name = 'characters';
    input.placeholder = placeholder;
    
    const deleteBtn = document.createElement('button');
    deleteBtn.type = 'button';
    deleteBtn.className = 'delete-btn';
    deleteBtn.textContent = '×';
    deleteBtn.title = '删除';
    
    chip.appendChild(input);
    chip.appendChild(deleteBtn);
    
    // 自适应宽度（像素测量，避免中文等宽不准）
    const measure = document.createElement('span');
    measure.style.position = 'absolute';
    measure.style.visibility = 'hidden';
    measure.style.whiteSpace = 'pre';
    measure.style.fontSize = getComputedStyle(input).fontSize;
    measure.style.fontFamily = getComputedStyle(input).fontFamily;
    chip.appendChild(measure);

    const autoSize = () => {
      const text = input.value || input.placeholder || '';
      measure.textContent = text;
      const textWidth = measure.getBoundingClientRect().width;
      const minWidth = 80; // 与 CSS 对齐的最小宽
      const maxWidth = 280; // 上限，避免过长
      const styles = getComputedStyle(input);
      const padLeft = parseFloat(styles.paddingLeft) || 0;
      const padRight = parseFloat(styles.paddingRight) || 0;
      const currentWidth = parseFloat(styles.width) || minWidth;
      const currentContentCap = currentWidth - padLeft - padRight;
      // 只有当文本真正填满当前宽度时才增长
      if (textWidth <= currentContentCap - 1) return;
      const target = Math.max(minWidth, Math.min(textWidth + padLeft + padRight, maxWidth));
      input.style.width = target + 'px';
    };
    autoSize();
    input.addEventListener('input', autoSize);
    
    // 删除按钮
    deleteBtn.addEventListener('click', () => {
      const allChips = characterList.querySelectorAll('.character-chip');
      if (allChips.length > 1) {
        chip.remove();
      } else {
        input.value = '';
        autoSize();
      }
    });
    
    return chip;
  }

  function initCharacterList(count = 1) {
    characterList.innerHTML = '';
    const n = Math.max(1, count|0);
    for (let i = 1; i <= n; i++) {
      characterList.appendChild(createCharacterChip(`角色${i}`));
    }
  }

  document.getElementById('addCharacterBtn').addEventListener('click', () => {
    const count = characterList.querySelectorAll('.character-chip').length + 1;
    characterList.appendChild(createCharacterChip(`角色${count}`));
  });

  // --- 动态表单逻辑 ---

  // 1. 单人/多人卡逻辑（单人=文本框，多人=胶囊+加号）
  const nameRelationGroup = document.getElementById('nameRelationGroup');
  const singleCharacterContainer = document.getElementById('singleCharacterContainer');
  const multiCharactersContainer = document.getElementById('multiCharactersContainer');

  function updateCharacterUI() {
    const type = (document.querySelector('input[name="cardType"]:checked') || {}).value;
    const relation = (document.querySelector('input[name="nameRelation"]:checked') || {}).value || 'same';
    
    if (type === 'multi') {
      // 多人卡：隐藏同名/不同名，显示胶囊+加号，隐藏单人文本框
      nameRelationGroup.classList.add('hidden');
      nameRelationGroup.style.display = 'none';
      singleCharacterContainer.classList.add('hidden');
      multiCharactersContainer.classList.remove('hidden');
      initCharacterList(2);
    } else {
      // 单人卡：显示同名/不同名选项
      nameRelationGroup.classList.remove('hidden');
      nameRelationGroup.style.display = '';
      multiCharactersContainer.classList.add('hidden');
      
      if (relation === 'different') {
        // 单人不同名：显示文本框
        singleCharacterContainer.classList.remove('hidden');
      } else {
        // 单人同名：隐藏文本框
        singleCharacterContainer.classList.add('hidden');
      }
    }
  }

  document.querySelectorAll('input[name="cardType"]').forEach(radio => {
    radio.addEventListener('change', updateCharacterUI);
  });
  document.querySelectorAll('input[name="nameRelation"]').forEach(radio => {
    radio.addEventListener('change', updateCharacterUI);
  });
  updateCharacterUI();

  // 2. 作者 逻辑
  const authorNameInput = document.getElementById('authorName');
  document.querySelectorAll('input[name="authorType"]').forEach(radio => {
    radio.addEventListener('change', (e) => {
      if (e.target.value === 'anonymous') {
        authorNameInput.placeholder = '马甲 (不填默认匿名)';
      } else {
        authorNameInput.placeholder = '实名';
      }
    });
  });

  // 3. 二次排雷 逻辑
  const secondaryWarningContainer = document.getElementById('secondaryWarningContainer');
  document.querySelectorAll('input[name="secondaryWarningToggle"]').forEach(radio => {
    radio.addEventListener('change', (e) => {
      if (e.target.value === 'yes') {
        secondaryWarningContainer.classList.remove('hidden');
      } else {
        secondaryWarningContainer.classList.add('hidden');
        document.getElementById('secondaryWarning').value = '';
      }
    });
  });

  // --- 表单提交逻辑 ---
  const uploadForm = document.getElementById("uploadForm");
  const submitButton = document.getElementById("submitButton");
  const uploadStatus = document.getElementById("uploadStatus");

  uploadForm.addEventListener("submit", async function (event) {
    event.preventDefault();
    
    const cardFile = document.getElementById('cardFile').files[0];
    if (!cardFile) {
        uploadStatus.textContent = "请必须上传角色卡文件";
        return;
    }

    submitButton.disabled = true;
    submitButton.textContent = "上传中...";
    uploadStatus.textContent = "正在上传，请稍候... (大文件可能需要一些时间)";

    try {
      const formData = new FormData(uploadForm);

      if (formData.get('cardType') === 'single') {
        const relation = formData.get('nameRelation') || 'same';
        if (relation === 'same') {
          formData.delete('characters');
        }
      }
      
      if (formData.get('secondaryWarningToggle') === 'no') {
        formData.delete('secondaryWarning');
      }
      formData.delete('secondaryWarningToggle');

      const response = await fetch("/api/upload", {
        method: "POST",
        body: formData,
      });

      const result = await response.json();

      if (result.success) {
        uploadStatus.textContent = result.message;
        uploadForm.reset();
        // 手动重置所有动态表单
        document.querySelector('input[name="cardType"][value="single"]').dispatchEvent(new Event('change'));
        document.querySelector('input[name="authorType"][value="real"]').dispatchEvent(new Event('change'));
        document.querySelector('input[name="secondaryWarningToggle"][value="no"]').dispatchEvent(new Event('change'));
        document.querySelector('input[name="nameRelation"][value="same"]').checked = true;
        updateCharacterUI();
        initCharacterList();
        
        // 清空文件存储和预览
        fileStorage['galleryImages'] = [];
        fileStorage['cardFile'] = [];
        fileStorage['attachments'] = [];
        document.getElementById('galleryPreviews').innerHTML = '';
        document.getElementById('cardFilePreviews').innerHTML = '';
        document.getElementById('attachmentPreviews').innerHTML = '';
        
        // 上传成功后，重新加载列表
        loadCards(); 
      } else {
        uploadStatus.textContent = "失败: " + result.message;
      }
    } catch (error) {
      console.error("提交出错:", error);
      uploadStatus.textContent = "上传失败，请检查网络连接或控制台报错。";
    } finally {
      submitButton.disabled = false;
      submitButton.textContent = "上传";
    }
  });

  // --- 加载卡片列表逻辑 ---
  const cardListContainer = document.getElementById("cardList");

  async function loadCards() {
    try {
      const response = await fetch("/api/cards");
      const data = await response.json();

      if (data.success && data.cards.length > 0) {
        cardListContainer.innerHTML = "";
        data.cards.forEach(card => {
          const cardElement = document.createElement("div");
          cardElement.className = "card";
          let tags = [];
          try { tags = JSON.parse(card.tags || '[]'); } catch (_) {}
          cardElement.innerHTML = `
            <h3>${card.cardName}</h3>
            <p><strong>作者:</strong> ${card.authorName}</p>
            <p><strong>简介:</strong> ${card.description || '无'}</p>
            <p><strong>Tags:</strong> ${tags.length ? tags.join(', ') : '无'}</p>
          `;
          cardListContainer.appendChild(cardElement);
        });
      } else {
        cardListContainer.textContent = "还没有人上传卡片。";
      }
    } catch (error) {
      cardListContainer.textContent = "加载卡片列表失败。";
    }
  }
  
  // --- 文件上传预览功能 ---
  const fileStorage = {}; // 存储每个input的文件列表

  function setupFilePreview(inputId, previewId, isImage = false, multiple = false) {
    const input = document.getElementById(inputId);
    const preview = document.getElementById(previewId);
    
    // 初始化存储
    if (!fileStorage[inputId]) {
      fileStorage[inputId] = [];
    }
    
    input.addEventListener('change', (e) => {
      const newFiles = Array.from(e.target.files || []);
      
      if (multiple) {
        // 多文件模式：累积文件
        fileStorage[inputId] = [...fileStorage[inputId], ...newFiles];
      } else {
        // 单文件模式：替换
        fileStorage[inputId] = newFiles;
      }
      
      // 更新 input.files
      const dt = new DataTransfer();
      fileStorage[inputId].forEach(f => dt.items.add(f));
      input.files = dt.files;
      
      // 重新渲染预览
      renderPreviews(inputId, previewId, isImage);
    });
  }

  function renderPreviews(inputId, previewId, isImage) {
    const preview = document.getElementById(previewId);
    preview.innerHTML = '';
    const files = fileStorage[inputId] || [];
    
    files.forEach((file, idx) => {
      if ((isImage && file.type.startsWith('image/')) || (inputId === 'cardFile' && file.type === 'image/png')) {
        const reader = new FileReader();
        reader.onload = (ev) => {
          const div = document.createElement('div');
          div.className = 'upload-thumbnail';
          div.innerHTML = `
            <img src="${ev.target.result}" alt="${file.name}">
            <button class="remove" type="button" onclick="removeFile('${inputId}', ${idx})">×</button>
          `;
          preview.appendChild(div);
        };
        reader.readAsDataURL(file);
      } else {
        const div = document.createElement('div');
        div.className = 'upload-thumbnail';
        div.innerHTML = `
          <div style="display:flex;align-items:center;justify-content:center;height:100%;background:#f5f5f5;font-size:12px;text-align:center;padding:4px;">${file.name}</div>
          <button class="remove" type="button" onclick="removeFile('${inputId}', ${idx})">×</button>
        `;
        preview.appendChild(div);
      }
    });
  }

  window.removeFile = function(inputId, index) {
    // 从存储中删除
    fileStorage[inputId].splice(index, 1);
    
    // 更新 input.files
    const input = document.getElementById(inputId);
    const dt = new DataTransfer();
    fileStorage[inputId].forEach(f => dt.items.add(f));
    input.files = dt.files;
    
    // 重新渲染
    const previewId = inputId === 'galleryImages' ? 'galleryPreviews' : 
                      inputId === 'cardFile' ? 'cardFilePreviews' : 'attachmentPreviews';
    const isImage = inputId === 'galleryImages';
    renderPreviews(inputId, previewId, isImage);
  };

  // 页面加载时初始化
  document.addEventListener('DOMContentLoaded', async () => {
    await loadConfig();
    loadCards();
    initCharacterList();

    // 文件预览（第4个参数表示是否支持多文件累积）
    setupFilePreview('galleryImages', 'galleryPreviews', true, true);  // 图片，多选累积
    setupFilePreview('cardFile', 'cardFilePreviews', false, false);    // 单文件，替换
    setupFilePreview('attachments', 'attachmentPreviews', false, true); // 附件，多选累积

    // 文本域自动高度
    document.querySelectorAll('textarea').forEach(t => {
      const resize = () => { 
        t.style.height = 'auto'; 
        t.style.height = (t.scrollHeight) + 'px'; 
      };
      t.addEventListener('input', resize);
      resize();
    });

    // URL 参数预填与锁定
    // 支持参数：category, authorName, authorId, lockCategory, lockAuthor
    const params = new URLSearchParams(location.search);
    
    const category = params.get('category');
    if (category) { 
      const cat = document.getElementById('category'); 
      cat.value = decodeURIComponent(category); 
    }
    
    const authorName = params.get('authorName');
    if (authorName) { 
      const au = document.getElementById('authorName'); 
      au.value = decodeURIComponent(authorName); 
    }
    
    const authorId = params.get('authorId');
    if (authorId) { 
      const aid = document.getElementById('authorId'); 
      aid.value = decodeURIComponent(authorId); 
    }
    
    if (params.get('lockCategory') === '1') { 
      const cat = document.getElementById('category'); 
      cat.readOnly = true; 
      cat.classList.add('locked'); 
    }
    
    if (params.get('lockAuthor') === '1') { 
      const au = document.getElementById('authorName'); 
      au.readOnly = true; 
      au.classList.add('locked'); 
    }

    // 顶部导航的平滑滚动
    const navUpload = document.getElementById('navUpload');
    const navList = document.getElementById('navList');
    if (navUpload) navUpload.addEventListener('click', (e) => {
      e.preventDefault();
      document.getElementById('upload').scrollIntoView({ behavior: 'smooth', block: 'start' });
    });
    if (navList) navList.addEventListener('click', (e) => {
      e.preventDefault();
      document.getElementById('list').scrollIntoView({ behavior: 'smooth', block: 'start' });
    });

    // 步骤点击跳转
    const stepMap = {
      step1: document.getElementById('section-base'),
      step2: document.getElementById('section-tags'),
      step3: document.getElementById('section-files')
    };
    Object.keys(stepMap).forEach(id => {
      const el = document.getElementById(id);
      el.style.cursor = 'pointer';
      el.addEventListener('click', () => {
        stepMap[id].scrollIntoView({ behavior: 'smooth', block: 'start' });
      });
    });

    // 根据填写进度更新步骤状态
    const steps = [
      { id: 'step1', check: () => {
          const nameFilled = (document.getElementById('cardName').value || '').trim().length > 0;
          return nameFilled;
        }
      },
      { id: 'step2', check: () => {
          return true; // tags 变为可选
        }
      },
      { id: 'step3', check: () => {
          return document.getElementById('cardFile').files.length > 0;
        }
      }
    ];

    const updateSteps = () => {
      let reachedIncomplete = false;
      steps.forEach((s, idx) => {
        const el = document.getElementById(s.id);
        const ok = s.check();
        el.classList.toggle('completed', ok);
        el.classList.toggle('active', !reachedIncomplete);
        if (!ok) reachedIncomplete = true; else if (idx < steps.length - 1) el.classList.remove('active');
      });
    };

    document.getElementById('cardName').addEventListener('input', updateSteps);
    document.getElementById('cardFile').addEventListener('change', updateSteps);
    updateSteps();
  });
</script>

</body>
</html>
