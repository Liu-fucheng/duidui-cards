<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>角色卡投递</title>
  
  <!-- Material UI CSS -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  
  <style>
    :root {
      --bg: #F3E9DD;        /* 淡米棕 */
      --surface: #FAF4EC;   /* 浅面板 */
      --text: #5C4033;      /* 深咖 */
      --muted: #D9CBBE;     /* 浅分割 */
      --accent: #8B5E3C;    /* 咖啡主色 */
      --accent-2: #6D4C3D;  /* 按下更深色 */
      --pill-bg: #EADFD2;   /* Tag 未选背景 */
    }

    html, body {
      background: var(--bg);
      color: var(--text);
      font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, PingFang SC, Hiragino Sans GB, Microsoft YaHei, Helvetica Neue, Arial, Noto Sans, "Noto Sans CJK SC", sans-serif;
    }

    body {
      margin: 24px;
      max-width: 860px;
      margin-left: auto;
      margin-right: auto;
    }

    .hidden { display: none; }

    h1 {
      font-size: 28px;
      margin: 8px 0 20px;
      letter-spacing: 0.5px;
    }

    h2 {
      font-size: 20px;
      margin: 24px 0 12px;
      letter-spacing: 0.2px;
    }

    /* 顶部导航/页脚 */
    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #F7EFE6;
      border: 1px solid var(--muted);
      border-radius: 12px;
      padding: 10px 14px;
      margin-bottom: 16px;
    }
    .brand { font-weight: 700; color: var(--accent-2); letter-spacing: 0.5px; }
    .nav-actions { display: flex; gap: 10px; align-items: center; }
    .link { color: var(--accent); text-decoration: none; padding: 6px 8px; border-radius: 8px; }
    .link:hover { background: var(--pill-bg); }

    .app-footer {
      margin-top: 20px;
      padding: 12px 0;
      color: #9A8274;
      font-size: 13px;
      text-align: center;
      border-top: 1px dashed var(--muted);
    }

    /* 步骤指示器 */
    .steps {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      position: relative;
    }
    .steps::before {
      content: "";
      position: absolute;
      top: 16px;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--muted);
      z-index: 0;
    }
    .step {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      position: relative;
      z-index: 1;
      flex: 1;
    }
    .step-circle {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--surface);
      border: 2px solid var(--muted);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: var(--text);
      transition: all 0.2s ease;
    }
    .step.active .step-circle {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
      box-shadow: 0 0 0 4px rgba(139,94,60,0.12);
    }
    .step.completed .step-circle {
      background: var(--accent-2);
      border-color: var(--accent-2);
      color: #fff;
    }
    .step-label {
      font-size: 12px;
      color: #9A8274;
    }
    .step.active .step-label {
      color: var(--accent-2);
      font-weight: 600;
    }

    form {
      background: var(--surface);
      border: 1px solid var(--muted);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .field {
      margin-bottom: 14px;
      padding-bottom: 12px;
      border-bottom: 1px dashed var(--muted);
    }

    .field:last-child {
      border-bottom: none;
      padding-bottom: 0;
      margin-bottom: 0;
    }

    .field > label.group-label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
    }

    /* 行内字段：标签与输入同一行，并限制输入宽度较短 */
    .inline-field { display: flex; align-items: center; gap: 10px; flex-wrap: nowrap; }
    .inline-field .group-label { margin: 0; display: inline-block; white-space: nowrap; }
    .short-input { width: 220px; max-width: 60vw; }


    input[type="text"], textarea, select {
      width: 100%;
      padding: 10px 12px;
      box-sizing: border-box;
      color: var(--text);
      background: #fff;
      border: 1px solid var(--muted);
      border-radius: 8px;
      outline: none;
    }
    #tagsSearch {
      padding: 10px 12px 10px 30px;
    }
    
    input[type="text"]:focus, textarea:focus, select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(139,94,60,0.12);
    }

    textarea {
      min-height: 100px;
      max-height: calc(1.5em * 20 + 24px); /* 大约20行 + 内边距 */
      overflow: auto;
      resize: vertical;
    }

    /* 行内选项布局 - 使用系统控件 + 咖啡色 */
    .inline-options {
      display: flex;
      flex-wrap: wrap;
      gap: 8px 12px;
      align-items: center;
    }

    /* 统一原生控件颜色为咖啡色，避免默认蓝色 */
    .inline-options input[type="checkbox"],
    .inline-options input[type="radio"] {
      accent-color: var(--accent);
      width: 22px;
      height: 22px;
    }
    .inline-options label { display: inline-flex; align-items: center; gap: 6px; white-space: nowrap; }

    /* 兼容任意 UI 库类名（若存在） */
    .MuiCheckbox-root, .MuiRadio-root { color: var(--accent) !important; }
    .MuiCheckbox-root.Mui-checked, .MuiRadio-root.Mui-checked { color: var(--accent) !important; }
    .MuiFormControlLabel-root { margin-right: 8px !important; }

    /* Tag 胶囊按钮 */
    .pill-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .pill {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      height: 36px;
      padding: 0 14px;
      border-radius: 999px;
      border: 1px solid var(--muted);
      background: var(--pill-bg);
      color: var(--text);
      cursor: pointer;
      transition: background 0.15s ease, box-shadow 0.15s ease, border-color 0.15s ease;
      overflow: hidden;
      user-select: none;
    }
    .pill-lg { height: 42px; padding: 0 18px; font-size: 16px; font-weight: 600; }
    .category-line { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; margin-bottom: 6px; }
    .category-sep { color: #876; margin: 0 4px; }
    .pill:hover { border-color: var(--accent); }
    .pill:active { background: #E4D6C6; }
    input[type="checkbox"].pill-input { position: absolute; opacity: 0; pointer-events: none; }
    input[type="checkbox"].pill-input:checked + label.pill {
      background: #DFCDBB;
      border-color: var(--accent);
      box-shadow: inset 0 0 0 2px rgba(139,94,60,0.18);
    }

    /* 提交按钮 */
    .btn-primary {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      font-size: 16px;
      color: #fff;
      background: var(--accent);
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.15s ease, box-shadow 0.15s ease;
      overflow: hidden;
    }
    .btn-primary:hover { box-shadow: 0 2px 10px rgba(139,94,60,0.25); }
    .btn-primary:active { background: var(--accent-2); }
    .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; box-shadow: none; }

    .btn-secondary {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      font-size: 16px;
      font-weight: 500;
      border: 2px solid var(--accent);
      border-radius: 8px;
      background: white;
      color: var(--accent);
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-secondary:hover { 
      background: var(--accent); 
      color: white;
      box-shadow: 0 2px 10px rgba(139,94,60,0.25); 
    }
    .btn-secondary:active { background: var(--accent-2); color: white; }
    .btn-secondary:disabled { opacity: 0.6; cursor: not-allowed; box-shadow: none; }

    #uploadStatus {
      font-weight: 600;
      margin-top: 15px;
      padding: 10px;
      color: var(--accent-2);
    }

    /* 列表卡片 */
    #cardList {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 14px;
    }
    .card {
      background: var(--surface);
      border: 1px solid var(--muted);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .card h3 { margin: 4px 0 6px; font-size: 18px; }
    .card p { margin: 4px 0; line-height: 1.5; }

    /* 简易 Material 风格 Ripple */
    .ripple { position: relative; overflow: hidden; }
    .ripple::after {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: radial-gradient(circle, rgba(255,255,255,0.35) 10%, rgba(255,255,255,0) 11%) center/0 0 no-repeat;
      transition: background-size 0.45s ease, opacity 0.6s ease;
      opacity: 0;
    }
    .ripple:active::after {
      background-size: 3000% 3000%;
      opacity: 1;
      transition: 0s;
    }

    /* 两列行布局（卡片类型 + 卡名） */
    .row-2 {
      display: grid;
      grid-template-columns: minmax(260px, 1fr) 1.2fr;
      gap: 16px;
      align-items: start;
    }
    @media (max-width: 640px) {
      .row-2 { grid-template-columns: 1fr; }
    }

    /* Discord 风格的预览卡片 */
    .discord-preview {
      background: #313338;
      border-radius: 12px;
      padding: 20px;
      color: #dbdee1;
      font-family: 'gg sans', 'Noto Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      margin-top: 32px;
    }
    
    .discord-preview h3 {
      color: #f2f3f5;
      font-size: 16px;
      font-weight: 600;
      margin: 0 0 12px 0;
      padding-bottom: 8px;
      border-bottom: 1px solid #3f4147;
    }
    
    .discord-thread {
      background: #2b2d31;
      border-radius: 4px;
      overflow: hidden;
    }
    
    .discord-thread-title {
      padding: 12px 16px;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      font-weight: 600;
      color: #f2f3f5;
      border-bottom: 1px solid #1e1f22;
      background: #2b2d31;
    }
    
    .discord-message {
      padding: 12px 16px;
      position: relative;
    }
    
    .discord-message:hover {
      background: #2e3035;
    }
    
    .discord-author {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }
    
    .discord-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 18px;
      flex-shrink: 0;
      overflow: hidden;
    }
    
    .discord-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .discord-username {
      font-weight: 500;
      color: #f2f3f5;
      font-size: 15px;
    }
    
    .discord-timestamp {
      font-size: 12px;
      color: #949ba4;
      margin-left: 4px;
    }
    
    .discord-content {
      color: #dbdee1;
      font-size: 14px;
      line-height: 1.5;
      margin-left: 52px;
      position: relative;
    }
    
    /* 复制按钮样式 */
    .copy-button {
      background: transparent;
      border: none;
      color: #b5bac1;
      cursor: pointer;
      padding: 6px;
      border-radius: 4px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      flex-shrink: 0;
    }
    
    .copy-button:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #ffffff;
    }
    
    .copy-button:active {
      transform: scale(0.95);
    }
    
    .copy-button.copied {
      color: #23a55a;
    }
    
    .copy-button svg {
      width: 18px;
      height: 18px;
    }
    
    .content-copy-button {
      position: absolute;
      top: 0;
      right: 0;
    }
    
    .discord-field {
      margin-bottom: 6px;
    }
    
    .discord-field.no-gap {
      margin-bottom: 2px;
    }
    
    .discord-field-label {
      font-weight: 600;
      color: #f2f3f5;
    }
    
    .discord-field-value {
      color: #b5bac1;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    
    .discord-like-count {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-top: 8px;
      padding: 4px 8px;
      background: #404249;
      border-radius: 12px;
      font-size: 13px;
      color: #dbdee1;
    }
    
    .preview-placeholder {
      color: #6d6f78;
      font-style: italic;
      font-size: 13px;
    }
    
    .discord-images {
      margin-top: 12px;
      display: grid;
      gap: 4px;
      max-width: 400px;
    }
    
    /* 根据图片数量动态调整布局 */
    .discord-images.count-1 {
      grid-template-columns: 1fr;
    }
    
    .discord-images.count-1 .discord-image {
      aspect-ratio: auto;
      max-height: 400px;
    }
    
    .discord-images.count-1 .discord-image img {
      object-fit: contain;
    }

    .discord-images.count-2 {
      grid-template-columns: repeat(2, 1fr);
    }
    
    .discord-images.count-3 {
      display: grid;
      grid-template-columns: 2fr 1fr;
      grid-template-rows: repeat(2, 1fr);
    }
    .discord-images.count-3 .discord-image:nth-child(1) {
      grid-row: span 2;
    }
    
    .discord-images.count-4 {
      grid-template-columns: repeat(2, 1fr);
    }

    .discord-images.count-4 .discord-image {
      aspect-ratio: 1.5 / 1;
    }
    .discord-images.count-5 {
      grid-template-columns: repeat(6, 1fr);
    }

    .discord-images.count-5 .discord-image:nth-child(-n+2) { /* 前2个 */
      grid-column: span 3;
    }

    .discord-images.count-5 .discord-image:nth-child(n+3) { /* 第3个开始 */
      grid-column: span 2;
    }

    .discord-images.count-6 {
      grid-template-columns: repeat(3, 1fr);
    }

    .discord-images.count-7 {
      grid-template-columns: repeat(12, 1fr);
    }
    
    .discord-images.count-7 .discord-image:nth-child(1) {
      grid-column: span 12;
      aspect-ratio: 1.5 / 1;
    }
    
    .discord-images.count-7 .discord-image:nth-child(n+2) {
      grid-column: span 4;
      aspect-ratio: 1 / 1;
    }

    .discord-images.count-8 {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
    }

    .discord-images.count-8 .discord-image:nth-child(-n+2) {
      grid-column: span 6;
    }

    .discord-images.count-8 .discord-image:nth-child(n+3) {
      grid-column: span 4;
    }

    .discord-images.count-9 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
    }

    .discord-images.count-9 .discord-image {
      aspect-ratio: 1 / 1;
    }

    .discord-images.count-10 {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      /* gap: 4px; */
    }

    .discord-images.count-10 .discord-image:nth-child(1) {
      grid-column: span 12;
      aspect-ratio: 1.5 / 1;
    }

    .discord-images.count-10 .discord-image:nth-child(n+2) {
      grid-column: span 4;
      aspect-ratio: 1 / 1;
    }

    /* 默认：多张图片时使用正方形 */
    .discord-image {
      border-radius: 4px;
      overflow: hidden;
      aspect-ratio: 1;
      background: #1e1f22;
      position: relative;
    }
    
    .discord-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    
    .discord-image.more {
      display: flex;
      align-items: center;
      justify-content: center;
      background: #2b2d31;
      color: #b5bac1;
      font-size: 14px;
      font-weight: 500;
    }

    /* 角色名胶囊（复用 tag pill 样式，可编辑可删除） */
    .chip-list { 
      display: flex; 
      flex-wrap: wrap; 
      gap: 10px; 
    }
    .chip-row { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    .character-chip {
      position: relative;
      display: inline-flex;
      align-items: center;
      height: 36px;
      min-width: 100px;
      border-radius: 999px;
      border: 1px solid var(--muted);
      background: linear-gradient(0deg, var(--pill-bg), var(--pill-bg)) padding-box, transparent border-box; /* 固定一致背景 */
      overflow: hidden;
    }
    .character-chip input {
      border: none;
      background: transparent;
      outline: none;
      color: var(--text);
      padding: 0 12px; /* 左右对称，显出开头文字 */
      margin-right: 28px; /* 给删除按钮留出空间 */
      height: 100%;
      min-width: 80px; /* 默认更窄的最小宽 */
      width: 80px; /* 初始宽度，后续用 JS 精确设置 */
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      box-shadow: none; /* 避免全局 input:focus 阴影在胶囊内形成浅棕分割 */
    }
    .character-chip input:focus { background: transparent; box-shadow: none !important; }
    /* 去掉浅棕色分割效果，改为外圈边框高亮 */
    .character-chip:focus-within { box-shadow: 0 0 0 0 rgba(0,0,0,0); border-color: var(--accent); }
    .character-chip .delete-btn {
      position: absolute;
      right: 6px;
      top: 50%;
      transform: translateY(-50%);
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: var(--accent);
      color: #fff;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      line-height: 1;
      opacity: 0.8;
      transition: opacity 0.15s ease;
      padding: 0;
    }
    .character-chip .delete-btn:hover { opacity: 1; background: var(--accent-2); }

    .add-chip-btn {
      width: 36px; height: 36px; border-radius: 50%; border: none; cursor: pointer; color: #fff;
      background: var(--accent); display: inline-flex; align-items: center; justify-content: center;
      font-size: 20px; line-height: 1; box-shadow: 0 2px 8px rgba(139,94,60,0.25);
    }
    .add-chip-btn:active { background: var(--accent-2); }

    /* 文件投递区域 */
    .upload-zone {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: flex-start;
    }
    .upload-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      height: 36px;
      padding: 0 14px;
      border-radius: 18px;
      border: none;
      background: var(--accent);
      color: #fff;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.15s ease;
    }
    .upload-btn:hover { background: var(--accent-2); }
    .upload-thumbnail {
      position: relative;
      width: 140px;
      height: 140px;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid var(--muted);
    }
    .upload-thumbnail img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .upload-thumbnail .remove {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--accent);
      color: #fff;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      opacity: 0.9;
    }
    .upload-thumbnail .remove:hover { opacity: 1; background: var(--accent-2); }
    input[type="file"] { display: none; }

    /* 预览区域使用 Grid，优先横排，空间不足再换行 */
    .preview-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 16px;
      align-items: start;
      width: 100%;
    }

    /* Tags 分类和搜索 */
    .tags-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: nowrap; gap: 12px; }
    .tags-header .group-label { white-space: nowrap; margin: 0; }
    .tags-search-wrapper {
      position: relative;
      width: 160px;
      margin-left: auto;
    }
    .tags-search-icon {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: #9A8274;
      font-size: 18px;
      pointer-events: none;
    }
    .tags-search { 
      width: 100%;
      padding: 8px 12px 8px 40px; 
      border: 1px solid var(--muted); 
      border-radius: 20px; 
      outline: none;
      font-size: 13px;
      background: #fff;
      transition: all 0.2s ease;
    }
    .tags-search:focus { 
      border-color: var(--accent); 
      box-shadow: 0 0 0 3px rgba(139,94,60,0.12); 
    }
    .tag-category { margin-bottom: 14px; }
    .tag-category-title { 
      font-size: 13px; 
      color: #876; 
      margin-bottom: 6px; 
      font-weight: 500;
    }
    .tag-category .pill-group { margin-left: 8px; }
    .tag-category.hidden { display: none; }

    /* 锁定样式 */
    .locked { 
      background: #F0EAE3 !important; 
      cursor: not-allowed !important;
    }

    /* 隐藏的 authorId 字段 */
    #authorId { display: none; }
  </style>
</head>
<body>

  <header class="app-header">
    <div class="brand">堆堆demo</div>
    <nav class="nav-actions">
      <a class="link" href="#upload" id="navUpload">角色卡投递</a>
    </nav>
  </header>

  <!-- 步骤指示器 -->
  <div class="steps">
    <div class="step active" data-step="1" id="step1">
      <div class="step-circle">1</div>
      <div class="step-label">基础信息</div>
    </div>
    <div class="step" data-step="2" id="step2">
      <div class="step-circle">2</div>
      <div class="step-label">分类标签</div>
    </div>
    <div class="step" data-step="3" id="step3">
      <div class="step-circle">3</div>
      <div class="step-label">文件投递</div>
    </div>
  </div>

  <h1 id="upload">投递角色卡</h1>
  
  <form id="uploadForm">

    <div id="section-base" class="field">
      <div class="inline-field" style="margin-top:0;">
        <label class="group-label" for="category">分区:</label>
        <input type="text" id="category" name="category" class="short-input" />
      </div>
      <div class="inline-field" style="margin-top:10px; align-items:center; gap:16px; flex-wrap:nowrap;">
        <label class="group-label">作者:</label>
        <div class="inline-options" style="flex-wrap:nowrap;">
          <label><input type="radio" name="authorType" value="real" checked class="mui-radio"> 实名</label>
          <label><input type="radio" name="authorType" value="anonymous" class="mui-radio"> 匿名</label>
        </div>
        <input type="text" id="authorName" name="authorName" class="short-input" />
        <input type="hidden" id="authorId" name="authorId" />
      </div>
      <div class="inline-field" style="margin-top:10px; justify-content:space-between;">
        <div style="display:flex; align-items:center; gap:10px;">
          <label class="group-label">类型*:</label>
          <div class="inline-options">
            <label><input type="radio" name="cardType" value="single" checked class="mui-radio"> 单人卡</label>
            <label><input type="radio" name="cardType" value="multi" class="mui-radio"> 多人卡</label>
          </div>
        </div>
        <div id="nameRelationGroup" class="inline-options">
          <span class="group-label" style="margin:0;">角色与卡</span>
          <label><input type="radio" name="nameRelation" value="same" checked class="mui-radio"> 同名</label>
          <label><input type="radio" name="nameRelation" value="different" class="mui-radio"> 不同名</label>
        </div>
      </div>
      <div class="inline-field" style="margin-top:10px;">
        <label class="group-label" for="cardName">卡名:</label>
        <input type="text" id="cardName" name="cardName" class="short-input" required />
      </div>
      <div class="inline-field" style="margin-top:10px;">
        <label class="group-label" for="threadTitle">帖子标题:</label>
        <input type="text" id="threadTitle" name="threadTitle" class="short-input"/>
      </div>
    </div>

    <div id="singleCharacterContainer" class="field hidden">
      <div class="inline-field" style="margin-top:0;">
        <label class="group-label" for="singleCharacterName">角色名:</label>
        <input type="text" id="singleCharacterName" name="characters" class="short-input" placeholder="角色名" />
      </div>
    </div>
    
    <div id="multiCharactersContainer" class="field hidden">
      <label class="group-label">角色名:</label>
      <div class="chip-row" style="margin-top:6px;">
        <div id="characterList" class="chip-list"><!-- 动态生成胶囊输入 --></div>
        <button type="button" id="addCharacterBtn" class="add-chip-btn" title="增加角色">+</button>
      </div>
    </div>
    
    <!-- 作者类型已合并到作者行 -->

    <div id="section-tags">
      <div id="customSectionsHost">
        <!-- 自定义板块将通过 JavaScript 动态添加 -->
      </div>
    </div>

    <div class="field">
      <div class="tags-header">
        <label class="group-label">Tags<span style="color: #8B5E3C;">*</span></label>
        <div class="tags-search-wrapper">
          <span class="tags-search-icon material-icons">search</span>
          <input type="text" class="tags-search" id="tagsSearch" placeholder="搜索...">
        </div>
      </div>
      <div id="tagsOptions">
        <!-- 动态从配置加载分类 -->
    </div>
    </div>

    <div class="field">
      <label class="group-label" for="warnings">排雷<span style="color: #8B5E3C;">*</span>:</label>
      <textarea id="warnings" name="warnings" required placeholder="请务必详细填写所有可能的雷点，此板块将会在主楼展示。
如有违反底线的【涉毒/涉政/同妻/代孕/幼童】要素，请勿投递。（如果认为自己的卡只是有相关要素，但不违背主流价值观，比如凌虐毒枭等，可以与管理组沟通再发卡）
含有char/user霸凌要素，请投递深渊区。
含有背德/sm等边缘限制级要素，请投递边限。
非边限=清水区。"></textarea>
    </div>

    <div class="field">
      <label class="group-label" for="description">简介<span style="color: #8B5E3C;">*</span>:</label>
      <textarea id="description" name="description" required placeholder="请在此处填写简介，非边限/边限会在主楼展示。深渊区只有交互才能查看简介。"></textarea>
    </div>

    <div class="field">
      <label class="group-label" for="otherInfo">其她:</label>
      <textarea id="otherInfo" name="otherInfo" placeholder="可在此处填写致谢或其她你想要显示在主楼的文字"></textarea>
    </div>

    <div class="field">
      <label class="group-label">下载前二次排雷:</label>
      <div class="inline-options">
        <label><input type="radio" name="secondaryWarningToggle" value="no" checked class="mui-radio"> 否</label>
        <label><input type="radio" name="secondaryWarningToggle" value="yes" class="mui-radio"> 是</label>
      </div>
    </div>
    <div id="secondaryWarningContainer" class="field hidden">
      <label class="group-label" for="secondaryWarning">二次排雷内容<span style="color: #8B5E3C;">*</span>:</label>
      <textarea id="secondaryWarning" name="secondaryWarning"></textarea>
    </div>

    <div id="section-files" class="field">
      <label class="group-label">头像 (选填，不填则使用角色卡PNG或默认图标):</label>
      <input type="file" id="avatarImage" name="avatarImage" accept="image/*" />
      <div class="upload-zone">
        <button type="button" class="upload-btn" onclick="document.getElementById('avatarImage').click()">+ 选择头像</button>
        <div id="avatarPreviews" class="preview-grid"></div>
      </div>
    </div>

    <div class="field">
      <label class="group-label">主楼图片 (可多图，最多10张):</label>
      <input type="file" id="galleryImages" name="galleryImages" multiple accept="image/*" />
      <div class="upload-zone">
        <button type="button" class="upload-btn" onclick="document.getElementById('galleryImages').click()">+ 添加图片</button>
        <div id="galleryPreviews" class="preview-grid"></div>
      </div>
    </div>

    <div class="field">
      <label class="group-label">角色卡 PNG<span style="color: #8B5E3C;">*</span> (.png，二选一必填):</label>
      <input type="file" id="cardPngFile" name="cardPngFile" accept=".png" />
      <div class="upload-zone">
        <button type="button" class="upload-btn" onclick="document.getElementById('cardPngFile').click()">+ 选择PNG文件</button>
        <div id="cardPngPreviews" class="preview-grid"></div>
      </div>
    </div>

    <div class="field">
      <label class="group-label">角色卡 JSON<span style="color: #8B5E3C;">*</span> (.json，二选一必填):</label>
      <input type="file" id="cardJsonFile" name="cardJsonFile" accept=".json" />
      <div class="upload-zone">
        <button type="button" class="upload-btn" onclick="document.getElementById('cardJsonFile').click()">+ 选择JSON文件</button>
        <div id="cardJsonPreviews" class="preview-grid"></div>
      </div>
    </div>

    <div class="field">
      <label class="group-label">其它附件 (可多图):</label>
      <input type="file" id="attachments" name="attachments" multiple />
      <div class="upload-zone">
        <button type="button" class="upload-btn" onclick="document.getElementById('attachments').click()">+ 添加附件</button>
        <div id="attachmentPreviews" class="preview-grid"></div>
      </div>
    </div>

    <div style="display: flex; gap: 12px; margin-top: 20px;">
    <button type="submit" id="submitButton" class="btn-primary ripple">投递</button>
    </div>
  </form>

  <div id="uploadStatus"></div>

  <!-- Discord 预览 -->
  <div class="discord-preview">
    <h3>Discord 发帖预览</h3>
    <div class="discord-thread">
      <div class="discord-thread-title">
        <span id="previewThreadTitle"><span class="preview-placeholder">未填写帖子标题</span></span>
        <button class="copy-button" id="copyTitleButton" title="复制标题">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
          </svg>
        </button>
      </div>
      <div class="discord-message">
          <div class="discord-author">
            <div class="discord-avatar" id="previewAvatar">
              <img src="默认头像.png" alt="默认头像">
            </div>
            <div>
              <span class="discord-username" id="previewUsername">匿名</span>
              <span class="discord-timestamp">今天</span>
            </div>
          </div>
        <div class="discord-content">
          <!-- 复制内容按钮 -->
          <button class="copy-button content-copy-button" id="copyContentButton" title="复制主楼内容">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
              <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
          </button>
          
          <!-- 赞数（仅深渊） -->
          <div class="discord-field" id="previewLikeSection" style="display: none;">
            <span class="discord-like-count">
              <span>❤️</span>
              <span>赞数：<span id="previewLikes">0</span></span>
            </span>
          </div>
          
          <!-- 作者 -->
          <div class="discord-field">
            <span class="discord-field-label">作者：</span>
            <span class="discord-field-value" id="previewVest">匿名</span>
          </div>
          
          <!-- 卡名 -->
          <div class="discord-field no-gap">
            <span class="discord-field-label">卡名：</span>
            <span class="discord-field-value" id="previewCardName">
              <span class="preview-placeholder">未填写</span>
            </span>
          </div>
          
          <!-- 角色（仅不同名或多人卡显示） -->
          <div class="discord-field no-gap" id="previewCharactersField" style="display: none;">
            <span class="discord-field-label">角色：</span>
            <span class="discord-field-value" id="previewCharacters">
              <span class="preview-placeholder">未填写</span>
            </span>
          </div>
          
          <!-- 性向 -->
          <div class="discord-field" id="previewOrientationField" style="display: none;">
            <span class="discord-field-label">性向：</span>
            <span class="discord-field-value" id="previewOrientation">
              <span class="preview-placeholder">未选择</span>
            </span>
          </div>
          
          <!-- Tags -->
          <div class="discord-field" id="previewTagsField" style="display: none;">
            <span class="discord-field-label">Tags：</span>
            <span class="discord-field-value" id="previewTags">
              <span class="preview-placeholder">未选择</span>
            </span>
          </div>
          
          <!-- 自定义板块 -->
          <div id="previewCustomSections"></div>
          
          <!-- 空行 + 排雷 -->
          <div class="discord-field" style="margin-top: 12px;">
            <span class="discord-field-label">排雷：</span>
            <div class="discord-field-value" id="previewWarnings">
              <span class="preview-placeholder">未填写</span>
            </div>
          </div>
          
          <!-- 简介（非深渊分区显示） -->
          <div class="discord-field" id="previewDescriptionField" style="display: none; margin-top: 12px;">
            <span class="discord-field-label">简介：</span>
            <div class="discord-field-value" id="previewDescription">
              <span class="preview-placeholder">未填写</span>
            </div>
          </div>
          
          <!-- 空行 + 其她 -->
          <div class="discord-field" id="previewOtherInfoField" style="display: none; margin-top: 12px;">
            <div class="discord-field-value" id="previewOtherInfo"></div>
          </div>
          
          <!-- 主楼图片 -->
          <div id="previewImagesContainer" style="display: none;">
            <div class="discord-images" id="previewImages"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer class="app-footer">
    © 2025 堆堆Demo
  </footer>

<!-- Material UI JS (使用 CDN) -->
<script src="https://unpkg.com/@mui/material@5.15.0/umd/material-ui.production.min.js"></script>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

<script>
  // --- 全局配置（从服务端加载） ---
  let CONFIG = {};
  let TOKEN_DATA = null; // 存储Token验证后的用户数据

  // 生成帖子标题
  function generateThreadTitle(formDataObj) {
    // 如果提供了 formData 对象，从中读取；否则从表单读取
    let threadTitle;
    if (formDataObj) {
      threadTitle = formDataObj.get('threadTitle');
    } else {
      threadTitle = document.getElementById('threadTitle')?.value.trim();
    }
    return threadTitle || '';
  }
  
  // 生成纯文本预览内容（主楼内容）
  function generatePreviewText(formDataObj) {
    let text = '';
    
    // 如果提供了 formData 对象，使用它；否则从 DOM 读取
    const getValue = (id) => {
      if (formDataObj) {
        return formDataObj.get(id) || '';
      }
      return document.getElementById(id)?.value.trim() || '';
    };
    
    const getCheckedValue = (name) => {
      if (formDataObj) {
        return formDataObj.get(name) || '';
      }
      return document.querySelector(`input[name="${name}"]:checked`)?.value || '';
    };
    
    // 作者
    const authorName = getValue('authorName') || '未填写';
    text += `**作者：**${authorName}\n`;
    
    // 卡名
    const cardName = getValue('cardName') || '未填写';
    text += `**卡名：**${cardName}\n`;
    
    // 角色名（仅不同名或多人卡显示）
    const cardType = getCheckedValue('cardType');
    const nameRelation = getCheckedValue('nameRelation');
    const characters = [];
    
    if (cardType === 'multi') {
      if (formDataObj) {
        // 从 FormData 获取
        const charValues = formDataObj.getAll('characters');
        charValues.forEach(val => {
          if (val && val.trim()) characters.push(val.trim());
        });
      } else {
        // 从 DOM 获取
        document.querySelectorAll('input[name="characters"]').forEach(input => {
          const val = input.value.trim();
          if (val) characters.push(val);
        });
      }
    } else if (cardType === 'single' && nameRelation === 'different') {
      const singleChar = getValue('singleCharacterName');
      if (singleChar) characters.push(singleChar);
    }
    
    if (characters.length > 0) {
      text += `**角色：**${characters.join(' / ')}\n`;
    }
    
    // 性向
    const orientations = [];
    if (formDataObj) {
      const orientValues = formDataObj.getAll('custom_性向') || formDataObj.getAll('custom_性向[]') || [];
      orientValues.forEach(val => {
        if (val) orientations.push(val);
      });
    } else {
      document.querySelectorAll('input[name="custom_性向"]:checked, input[name="custom_性向[]"]:checked').forEach(cb => {
        orientations.push(cb.value);
      });
    }
    if (orientations.length > 0) {
      text += `**性向：**${orientations.join(' / ')}\n`;
    }
    
    // Tags
    const selectedTags = [];
    if (formDataObj) {
      const tagValues = formDataObj.getAll('tags') || [];
      selectedTags.push(...tagValues);
    } else {
      document.querySelectorAll('input[type="checkbox"].pill-input:checked').forEach(cb => {
        const label = document.querySelector(`label[for="${cb.id}"]`);
        if (label && cb.name === 'tags') {
          selectedTags.push(label.textContent.trim());
        }
      });
    }
    if (selectedTags.length > 0) {
      text += `**Tags：**${selectedTags.join(' / ')}\n`;
    }
    
    // 自定义板块（除了性向）
    if (formDataObj) {
      // 从 otherInfo 解析自定义板块
      const otherInfo = getValue('otherInfo');
      if (otherInfo) {
        const lines = otherInfo.split('\n');
        for (const line of lines) {
          const trimmed = line.trim();
          if (!trimmed) continue;
          // 匹配格式："{title}: {value1}, {value2}"
          const match = trimmed.match(/^([^：:]+)[：:]\s*(.+)$/);
          if (match) {
            let title = match[1].trim().replace(/\*/g, '').trim();
            const values = match[2].trim();
            // 跳过已单独显示的字段
            if (title !== '下载要求' && title !== '性向' && title !== '背景') {
              // 将逗号分隔的值转换为 " / " 分隔
              const valueList = values.split(/[,，、]/).map(v => v.trim()).filter(v => v);
              if (valueList.length > 0) {
                text += `**${title}：**${valueList.join(' / ')}\n`;
              }
            }
          }
        }
      }
    } else {
      // 从 DOM 读取自定义板块
      document.querySelectorAll('[id^="section_"]').forEach(section => {
        const labelEl = section.querySelector('.group-label');
        if (!labelEl) return;
        // 从 label 提取纯标题（移除 HTML 中的 * 和 : 标记）
        let sectionTitle = labelEl.textContent.replace(/\*/g, '').replace(':', '').trim();
        
        // 跳过性向和下载要求（已单独显示或不需要显示）
        if (sectionTitle === '性向' || sectionTitle === '下载要求') return;
        
        const sectionValues = [];
        section.querySelectorAll('input:checked').forEach(input => {
          sectionValues.push(input.value);
        });
        
        if (sectionValues.length > 0) {
          text += `**${sectionTitle}：**${sectionValues.join(' / ')}\n`;
        }
      });
    }
    
    // 排雷
    const warnings = getValue('warnings');
    if (warnings) {
      text += `\n**排雷：**\n${warnings}\n`;
    }
    
    // 简介（检查是否为深渊分区）
    const category = getValue('category');
    const isAbyss = category === '深渊';
    const description = getValue('description');
    
    if (!isAbyss && description) {
      text += `\n**简介：**\n${description}\n`;
    }
    
    // 其她
    const otherInfo = getValue('otherInfo');
    if (otherInfo) {
      text += `\n**其她：**\n${otherInfo}\n`;
    }
    
    return text;
  }

  // 验证Token并获取用户信息
  async function verifyToken(token) {
    try {
      const response = await fetch(`/api/token?token=${token}`);
      const data = await response.json();
      
      if (data.success) {
        TOKEN_DATA = data.data;
        console.log('Token验证成功:', TOKEN_DATA);
        return { valid: true, used: false };
      } else {
        console.error('Token验证失败:', data.message);
        // 检查是否为"Token已使用"的情况
        if (data.message && data.message.includes('已被使用')) {
          // Token已使用，返回特殊状态
          return { valid: false, used: true, message: data.message };
        } else {
          // 其他错误（无效、过期等）
          alert(`Token验证失败: ${data.message}\n请联系管理员获取新的发卡链接。`);
          return { valid: false, used: false, message: data.message };
        }
      }
    } catch (error) {
      console.error('Token验证错误:', error);
      alert('Token验证失败，请检查网络连接或联系管理员。');
      return { valid: false, used: false, message: error.message };
    }
  }

  // 标记Token为已使用
  async function markTokenAsUsed(token) {
    try {
      await fetch('/api/token', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token })
      });
    } catch (error) {
      console.error('标记Token失败:', error);
    }
  }

  // 尝试从服务端加载配置
  async function loadConfig() {
    try {
      const response = await fetch('/api/config');
      const data = await response.json();
      if (data.success) {
        CONFIG = data.config;
      }
    } catch (error) {
      console.error('配置加载失败', error);
    }
    renderOptions();
  }

  // 渲染选项（使用简单的 checkbox，Material UI 样式会自动应用）
  function renderOptions() {
    // 兜底：确保 CONFIG 有必要的数组
    if (!CONFIG.tagCategories) CONFIG.tagCategories = [];
    
    // 自定义板块（按 sections 顺序渲染）
    const secHost = document.getElementById('customSectionsHost');
    if (secHost) {
      const sections = Array.isArray(CONFIG.customSections) ? CONFIG.customSections : [];
      const order = Array.isArray(CONFIG.sections) ? CONFIG.sections : [];
      const htmls = [];
      order.forEach(key => {
        if (key === 'partition') return; // partition 不在这里显示
        if (key.startsWith('custom:')) {
          const title = key.slice(7);
          const sec = sections.find(s => s && s.title === title);
          if (!sec) return;
          const inputType = sec.multiple === false ? 'radio' : 'checkbox';
          const items = (sec.items || []).map((it, i) => {
            const name = sec.multiple === false ? `custom_${title}` : `custom_${title}[]`;
            const showIf = it.enableIf ? `data-showif="${it.enableIf}"` : '';
            const mutex = it.mutexWith && it.mutexWith.length ? `data-mutex="${it.mutexWith.join(',')}"` : '';
            return `<label class="option-item" ${showIf}><input type="${inputType}" name="${name}" value="${it.value}" ${mutex}> ${it.label}</label>`;
          }).join('');
          const fieldId = `section_${title.replace(/\s/g,'_')}`;
          const showIf = sec.showIf ? `data-showif="${sec.showIf}"` : '';
          const requiredMark = sec.required !== false ? '<span style="color: #8B5E3C;">*</span>' : '';
          htmls.push(`<div class="field" id="${fieldId}" ${showIf} data-required="${sec.required !== false}"><label class="group-label">${sec.title}${requiredMark}:</label><div class="inline-options">${items}</div></div>`);
        }
      });
      secHost.innerHTML = htmls.join('');
      
      // 绑定依赖与互斥逻辑
      bindConditionalLogic();
    }

    // Tags 初次渲染
    renderTagsByPartition();

    // 监听分区变化，实时切换标签集合
    const categoryInput = document.getElementById('category');
    if (categoryInput) {
      categoryInput.addEventListener('input', () => {
        // 防抖：避免第三方脚本触发频繁渲染导致卡顿
        clearTimeout(window.__renderTagsDebounce);
        window.__renderTagsDebounce = setTimeout(() => {
          renderTagsByPartition();
        }, 120);
      }, { passive: true });
    }
  }

  function renderTagsByPartition() {
    const tagsOptions = document.getElementById('tagsOptions');
    if (!tagsOptions) return;
    let tagIndex = 0;

    const categories = getEffectiveCategories();
    console.log('准备渲染 tags 分类数量:', categories.length, categories);
    tagsOptions.innerHTML = categories.map((cat) => {
      const catShowIf = cat.showIf ? `data-showif="${cat.showIf}"` : '';
      const catMutex = cat.mutexWith && cat.mutexWith.length ? `data-mutex="${cat.mutexWith.join(',')}"` : '';
      
      // 子标签
      const subPills = (cat.tags || []).map(opt => {
        const id = `tag${tagIndex++}`;
        const val = (opt.value || opt.label);
        const showIf = opt.showIf ? `data-showif="${opt.showIf}"` : '';
        const mutex = opt.mutexWith && opt.mutexWith.length ? `data-mutex="${opt.mutexWith.join(',')}"` : '';
        return `<input class="pill-input" type="checkbox" id="${id}" name="tags" value="${val}" ${mutex}>
        <label class="pill ripple option-item" for="${id}" ${showIf}>${opt.label}</label>`;
      });

      let headerHtml;
      if (cat.asPill && cat.category) {
        // 类可选：标题渲染为更大的胶囊，并在同一行加一个连字符，再接小类
        const id = `tag${tagIndex++}`;
        const label = cat.pillLabel || cat.category;
        const value = cat.pillValue || cat.category;
        const catPill = `<input class="pill-input" type="checkbox" id="${id}" name="tags" value="${value}" ${catMutex}>
          <label class="pill pill-lg ripple option-item" for="${id}" ${catShowIf}>${label}</label>`;
        headerHtml = `<div class="category-line">${catPill}<span class="category-sep">-</span>${subPills.join('')}</div>`;
      } else {
        // 普通：显示文字标题，下面一行显示小类
        headerHtml = `<div class="tag-category-title">${cat.category}</div><div class="pill-group">${subPills.join('')}</div>`;
      }

      return `<div class="tag-category" data-category="${cat.category}" ${catShowIf}>${headerHtml}</div>`;
    }).join('');

    // Tags 搜索功能（仅绑定一次）
    const tagsSearch = document.getElementById('tagsSearch');
    if (tagsSearch && !tagsSearch.dataset.bound) {
      tagsSearch.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase().trim();
        
        // 获取当前选中的值，用于条件检查
        const formData = new FormData(document.getElementById('uploadForm'));
        const selected = {};
        for (const [k, v] of formData.entries()) {
          if (!selected[k]) selected[k] = [];
          selected[k].push(v);
        }
        
        document.querySelectorAll('.tag-category').forEach(cat => {
          const pills = cat.querySelectorAll('.pill');
          let hasVisible = false;
          pills.forEach(pill => {
            const label = pill.querySelector('.option-item');
            if (!label) return;
            
            // 检查启用条件
            const showIf = label.getAttribute('data-showif');
            const conditionMet = !showIf || checkCondition(showIf, selected);
            
            // 检查搜索匹配
            const textMatch = pill.textContent.toLowerCase().includes(query);
            
            // 同时满足条件和搜索才显示
            const shouldShow = conditionMet && (textMatch || !query);
            pill.style.display = shouldShow ? '' : 'none';
            if (shouldShow) hasVisible = true;
          });
          cat.classList.toggle('hidden', !hasVisible);
        });
      });
      tagsSearch.dataset.bound = '1';
    }
    
    // 绑定 tags 的条件逻辑
    bindConditionalLogic();
  }

  function getEffectiveCategories() {
    const partitions = (CONFIG.tagPartitions || {});
    const cateInput = document.getElementById('category');
    const raw = (cateInput && cateInput.value || '').trim();
    const map = { '非边限': 'feibianxian', '边限': 'bianxian', '深渊': 'shenyuan' };
    const key = map[raw] || null;
    
    // 公共分类来自 tagPartitions.common
    const common = Array.isArray(partitions.common) ? partitions.common : [];
    
    // 根据分区决定显示哪些分类
    let extra = [];
    if (raw === '深渊') {
      // 深渊区：显示公共 + 边限 + 深渊
      const bianxian = Array.isArray(partitions.bianxian) ? partitions.bianxian : [];
      const shenyuan = Array.isArray(partitions.shenyuan) ? partitions.shenyuan : [];
      extra = [...bianxian, ...shenyuan];
      console.log('公共分类:', common.length, '边限分类:', bianxian.length, '深渊分类:', shenyuan.length);
    } else {
      // 其他分区：只显示公共 + 专属
      extra = key && Array.isArray(partitions[key]) ? partitions[key] : [];
    console.log('公共分类:', common.length, '专属分类:', extra.length);
    }
    
    return mergeCategoriesByName(common, extra);
  }

  function mergeCategoriesByName(base, extra) {
    const byName = new Map();
    const add = (arr) => {
      (arr || []).forEach(cat => {
        if (!cat || !cat.category) return;
        if (!byName.has(cat.category)) {
          byName.set(cat.category, {
            category: cat.category,
            asPill: !!cat.asPill,
            pillLabel: cat.pillLabel,
            pillValue: cat.pillValue,
            showIf: cat.showIf,            // 保留分类显示条件
            mutexWith: cat.mutexWith,      // 保留分类互斥
            tags: []
          });
        }
        const entry = byName.get(cat.category);
        // 合并分类级属性（后者覆盖）
        if (cat.asPill) entry.asPill = true;
        if (cat.pillLabel) entry.pillLabel = cat.pillLabel;
        if (cat.pillValue) entry.pillValue = cat.pillValue;
        if (cat.showIf) entry.showIf = cat.showIf;
        if (Array.isArray(cat.mutexWith) && cat.mutexWith.length) entry.mutexWith = cat.mutexWith;

        // 合并并去重子标签（按 value 优先，其次 label）
        const seen = new Set(entry.tags.map(t => t.value || t.label));
        (cat.tags || []).forEach(t => {
          const val = (t && (t.value || t.label));
          if (!val || seen.has(val)) return;
          entry.tags.push({
            value: t.value || t.label,
            label: t.label || t.value,
            showIf: t.showIf,
            mutexWith: Array.isArray(t.mutexWith) ? t.mutexWith : undefined
          });
          seen.add(val);
        });
      });
    };
    add(base);
    add(extra);
    return Array.from(byName.values());
  }

  function bindConditionalLogic() {
    // 监听所有 checkbox/radio 变化，动态显示/禁用板块和选项
    document.querySelectorAll('input[type="checkbox"], input[type="radio"]').forEach(input => {
      input.addEventListener('change', updateConditionalUI);
    });
    updateConditionalUI();
  }

  function updateConditionalUI() {
    const formData = new FormData(document.getElementById('uploadForm'));
    const selected = {};
    for (const [k, v] of formData.entries()) {
      if (!selected[k]) selected[k] = [];
      selected[k].push(v);
    }

    // 板块显示条件（只处理有 data-showif 的）
    document.querySelectorAll('.field[data-showif], .tag-category[data-showif]').forEach(field => {
      const cond = field.getAttribute('data-showif');
      if (!cond) return; // 无条件的不处理
      field.style.display = checkCondition(cond, selected) ? '' : 'none';
    });

    // 选项显示条件（隐藏整个 label，而不是 disabled）
    document.querySelectorAll('.option-item[data-showif]').forEach(label => {
      const cond = label.getAttribute('data-showif');
      label.style.display = checkCondition(cond, selected) ? '' : 'none';
    });

    // 互斥逻辑（tags 用 name="tags"，自定义板块用各自 name）
    document.querySelectorAll('input[data-mutex]').forEach(input => {
      if (!input.checked) return;
      const mutexValues = (input.getAttribute('data-mutex') || '').split(',').map(x => x.trim()).filter(Boolean);
      const name = input.name;
      document.querySelectorAll(`input[name="${name}"]`).forEach(other => {
        if (other === input) return;
        if (mutexValues.includes(other.value)) {
          other.checked = false;
        }
      });
    });
  }

  function checkCondition(cond, selected) {
    if (!cond) return true;
    
    // 支持 | 分隔的或关系
    const conditions = cond.split('|').map(c => c.trim()).filter(Boolean);
    
    // 任一条件满足即返回 true
    return conditions.some(singleCond => {
      // 检查是否为"非"条件（以 ! 开头）
      const isNegated = singleCond.startsWith('!');
      const actualCond = isNegated ? singleCond.slice(1).trim() : singleCond;
      
      const parts = actualCond.split(':');
      if (parts.length !== 2) return true;
      const [field, value] = parts.map(x => x.trim());
      
      // 智能匹配：尝试多种字段名变体
      const variants = [
        field,                    // 原样 如 性向
        `custom_${field}`,        // 单选 如 custom_性向
        `custom_${field}[]`       // 多选 如 custom_性向[]
      ];
      
      let matched = false;
      for (const v of variants) {
        const vals = selected[v] || [];
        if (vals.includes(value)) {
          matched = true;
          break;
        }
      }
      
      // 如果是"非"条件，返回相反的结果
      return isNegated ? !matched : matched;
    });
  }


  // --- 角色名胶囊管理 ---
  const characterList = document.getElementById('characterList');

  function createCharacterChip(placeholder) {
    const chip = document.createElement('div');
    chip.className = 'character-chip';
    
    const input = document.createElement('input');
    input.type = 'text';
    input.name = 'characters';
    input.placeholder = placeholder;
    
    const deleteBtn = document.createElement('button');
    deleteBtn.type = 'button';
    deleteBtn.className = 'delete-btn';
    deleteBtn.textContent = '×';
    deleteBtn.title = '删除';
    
    chip.appendChild(input);
    chip.appendChild(deleteBtn);
    
    // 自适应宽度（像素测量，避免中文等宽不准）
    const measure = document.createElement('span');
    measure.style.position = 'absolute';
    measure.style.visibility = 'hidden';
    measure.style.whiteSpace = 'pre';
    measure.style.fontSize = getComputedStyle(input).fontSize;
    measure.style.fontFamily = getComputedStyle(input).fontFamily;
    chip.appendChild(measure);

    const autoSize = () => {
      const text = input.value || input.placeholder || '';
      measure.textContent = text;
      const textWidth = measure.getBoundingClientRect().width;
      const minWidth = 80; // 与 CSS 对齐的最小宽
      const maxWidth = 280; // 上限，避免过长
      const styles = getComputedStyle(input);
      const padLeft = parseFloat(styles.paddingLeft) || 0;
      const padRight = parseFloat(styles.paddingRight) || 0;
      const currentWidth = parseFloat(styles.width) || minWidth;
      const currentContentCap = currentWidth - padLeft - padRight;
      // 只有当文本真正填满当前宽度时才增长
      if (textWidth <= currentContentCap - 1) return;
      const target = Math.max(minWidth, Math.min(textWidth + padLeft + padRight, maxWidth));
      input.style.width = target + 'px';
    };
    autoSize();
    input.addEventListener('input', () => {
      autoSize();
      // 更新Discord预览
      if (window.updateDiscordPreview) {
        window.updateDiscordPreview();
      }
    });
    
    // 删除按钮
    deleteBtn.addEventListener('click', () => {
      const allChips = characterList.querySelectorAll('.character-chip');
      if (allChips.length > 1) {
        chip.remove();
      } else {
        input.value = '';
        autoSize();
      }
      // 更新Discord预览
      if (window.updateDiscordPreview) {
        window.updateDiscordPreview();
      }
    });
    
    return chip;
  }

  function initCharacterList(count = 1) {
    characterList.innerHTML = '';
    const n = Math.max(1, count|0);
    for (let i = 1; i <= n; i++) {
      characterList.appendChild(createCharacterChip(`角色${i}`));
    }
  }

  document.getElementById('addCharacterBtn').addEventListener('click', () => {
    const count = characterList.querySelectorAll('.character-chip').length + 1;
    characterList.appendChild(createCharacterChip(`角色${count}`));
  });

  // --- 动态表单逻辑 ---

  // 1. 单人/多人卡逻辑（单人=文本框，多人=胶囊+加号）
  const nameRelationGroup = document.getElementById('nameRelationGroup');
  const singleCharacterContainer = document.getElementById('singleCharacterContainer');
  const multiCharactersContainer = document.getElementById('multiCharactersContainer');

  function updateCharacterUI() {
    const type = (document.querySelector('input[name="cardType"]:checked') || {}).value;
    const relation = (document.querySelector('input[name="nameRelation"]:checked') || {}).value || 'same';
    
    if (type === 'multi') {
      // 多人卡：隐藏同名/不同名，显示胶囊+加号，隐藏单人文本框
      nameRelationGroup.classList.add('hidden');
      nameRelationGroup.style.display = 'none';
      singleCharacterContainer.classList.add('hidden');
      multiCharactersContainer.classList.remove('hidden');
      initCharacterList(2);
    } else {
      // 单人卡：显示同名/不同名选项
      nameRelationGroup.classList.remove('hidden');
      nameRelationGroup.style.display = '';
      multiCharactersContainer.classList.add('hidden');
      
      if (relation === 'different') {
        // 单人不同名：显示文本框
        singleCharacterContainer.classList.remove('hidden');
      } else {
        // 单人同名：隐藏文本框
        singleCharacterContainer.classList.add('hidden');
      }
    }
    
    // 更新Discord预览
    if (window.updateDiscordPreview) {
      window.updateDiscordPreview();
    }
  }

  document.querySelectorAll('input[name="cardType"]').forEach(radio => {
    radio.addEventListener('change', updateCharacterUI);
  });
  document.querySelectorAll('input[name="nameRelation"]').forEach(radio => {
    radio.addEventListener('change', updateCharacterUI);
  });
  updateCharacterUI();

  // 2. 作者 逻辑 + 深渊区强制匿名
  const authorNameInput = document.getElementById('authorName');
  const realRadio = document.querySelector('input[name="authorType"][value="real"]');
  const anonymousRadio = document.querySelector('input[name="authorType"][value="anonymous"]');
  
  // 监听作者类型变化，更新placeholder
  document.querySelectorAll('input[name="authorType"]').forEach(radio => {
    radio.addEventListener('change', (e) => {
      if (e.target.value === 'anonymous') {
        authorNameInput.placeholder = '马甲 (不填默认匿名)';
      } else {
        authorNameInput.placeholder = '实名';
      }
    });
  });
  
  // 监听分区变化，深渊区强制匿名
  function updateAuthorTypeByCategory() {
    const category = document.getElementById('category')?.value.trim();
    const isAbyss = category === '深渊';
    
    if (isAbyss) {
      // 深渊区：强制匿名，禁用实名
      anonymousRadio.checked = true;
      anonymousRadio.dispatchEvent(new Event('change')); // 触发placeholder更新
      realRadio.disabled = true;
      realRadio.parentElement.style.opacity = '0.5';
      realRadio.parentElement.style.cursor = 'not-allowed';
      realRadio.parentElement.title = '深渊区禁止实名投递';
    } else {
      // 非深渊区：允许选择
      realRadio.disabled = false;
      realRadio.parentElement.style.opacity = '1';
      realRadio.parentElement.style.cursor = '';
      realRadio.parentElement.title = '';
    }
  }
  
  // 绑定分区输入监听
  document.getElementById('category')?.addEventListener('input', updateAuthorTypeByCategory);
  
  // 初始化检查
  updateAuthorTypeByCategory();

  // 3. 二次排雷 逻辑
  const secondaryWarningContainer = document.getElementById('secondaryWarningContainer');
  document.querySelectorAll('input[name="secondaryWarningToggle"]').forEach(radio => {
    radio.addEventListener('change', (e) => {
      if (e.target.value === 'yes') {
        secondaryWarningContainer.classList.remove('hidden');
      } else {
        secondaryWarningContainer.classList.add('hidden');
        document.getElementById('secondaryWarning').value = '';
      }
    });
  });

  // --- 表单提交逻辑 ---
  const uploadForm = document.getElementById("uploadForm");
  const submitButton = document.getElementById("submitButton");
  const uploadStatus = document.getElementById("uploadStatus");

  uploadForm.addEventListener("submit", async function (event) {
    event.preventDefault();
    
    // 强制检查token
    const params = new URLSearchParams(location.search);
    const token = params.get('token');
    if (!token) {
        uploadStatus.innerHTML = `
          <div style="padding: 12px; background: #ffebee; border: 1px solid #f44336; border-radius: 8px; color: #c62828;">
            <strong>❌ 禁止投递</strong><br>
            您必须在Discord中与bot交互获得链接，从专属链接进入才能投递角色卡。
          </div>
        `;
        return;
    }
    
    // 验证必填字段：Tags
    const selectedTags = document.querySelectorAll('input[name="tags"]:checked');
    if (selectedTags.length === 0) {
        uploadStatus.innerHTML = `
          <div style="padding: 12px; background: #ffebee; border: 1px solid #f44336; border-radius: 8px; color: #c62828;">
            ❌ 请至少选择一个Tag
          </div>
        `;
        document.getElementById('tagsOptions').scrollIntoView({ behavior: 'smooth', block: 'center' });
        return;
    }
    
    // 验证必填字段：排雷
    const warnings = document.getElementById('warnings').value.trim();
    if (!warnings) {
        uploadStatus.innerHTML = `
          <div style="padding: 12px; background: #ffebee; border: 1px solid #f44336; border-radius: 8px; color: #c62828;">
            ❌ 请填写排雷内容
          </div>
        `;
        document.getElementById('warnings').focus();
        return;
    }
    
    // 验证必填字段：简介
    const description = document.getElementById('description').value.trim();
    if (!description) {
        uploadStatus.innerHTML = `
          <div style="padding: 12px; background: #ffebee; border: 1px solid #f44336; border-radius: 8px; color: #c62828;">
            ❌ 请填写简介内容
          </div>
        `;
        document.getElementById('description').focus();
        return;
    }
    
    // 验证必填字段：二次排雷（如果选择了"是"）
    const secondaryWarningToggle = document.querySelector('input[name="secondaryWarningToggle"]:checked')?.value;
    if (secondaryWarningToggle === 'yes') {
        const secondaryWarning = document.getElementById('secondaryWarning').value.trim();
        if (!secondaryWarning) {
            uploadStatus.innerHTML = `
              <div style="padding: 12px; background: #ffebee; border: 1px solid #f44336; border-radius: 8px; color: #c62828;">
                ❌ 请填写二次排雷内容
              </div>
            `;
            document.getElementById('secondaryWarning').focus();
            return;
        }
    }
    
    // 验证必填字段：角色卡（二选一）
    const cardPngFile = document.getElementById('cardPngFile').files[0];
    const cardJsonFile = document.getElementById('cardJsonFile').files[0];
    if (!cardPngFile && !cardJsonFile) {
        uploadStatus.innerHTML = `
          <div style="padding: 12px; background: #ffebee; border: 1px solid #f44336; border-radius: 8px; color: #c62828;">
            ❌ 请至少上传角色卡PNG或JSON文件其中一个
          </div>
        `;
        return;
    }
    
    // 验证自定义必填板块
    const requiredSections = document.querySelectorAll('[id^="section_"][data-required="true"]');
    for (const section of requiredSections) {
        // 跳过隐藏的板块（showIf条件不满足）
        if (section.classList.contains('hidden') || section.style.display === 'none') continue;
        
        const label = section.querySelector('.group-label')?.textContent.replace('*', '').replace(':', '').trim();
        const checkedInputs = section.querySelectorAll('input:checked');
        
        if (checkedInputs.length === 0) {
            uploadStatus.innerHTML = `
              <div style="padding: 12px; background: #ffebee; border: 1px solid #f44336; border-radius: 8px; color: #c62828;">
                ❌ 请选择${label}
              </div>
            `;
            section.scrollIntoView({ behavior: 'smooth', block: 'center' });
            return;
        }
    }

    submitButton.disabled = true;
    submitButton.textContent = "投递中...";
    uploadStatus.textContent = "正在投递，请稍候... (大文件可能需要一些时间)";

    try {
      const formData = new FormData(uploadForm);

      // 处理角色卡文件字段名统一（PNG或JSON -> cardFile）
      const cardPngFile = formData.get('cardPngFile');
      const cardJsonFile = formData.get('cardJsonFile');
      
      // 删除原字段名
      formData.delete('cardPngFile');
      formData.delete('cardJsonFile');
      
      // 添加统一的字段名（优先PNG，其次JSON）
      if (cardPngFile && cardPngFile.size > 0) {
        formData.append('cardFile', cardPngFile);
      } else if (cardJsonFile && cardJsonFile.size > 0) {
        formData.append('cardFile', cardJsonFile);
      }

      if (formData.get('cardType') === 'single') {
        const relation = formData.get('nameRelation') || 'same';
        if (relation === 'same') {
          formData.delete('characters');
        }
      }
      
      if (formData.get('secondaryWarningToggle') === 'no') {
        formData.delete('secondaryWarning');
      }
      formData.delete('secondaryWarningToggle');
      
      // 添加用户信息（从TOKEN_DATA）
      if (TOKEN_DATA) {
        formData.append('submitterUserId', TOKEN_DATA.user_id || '');
        formData.append('submitterUsername', TOKEN_DATA.username || '');
        formData.append('submitterDisplayName', TOKEN_DATA.display_name || '');
      }

      const response = await fetch("/api/upload", {
        method: "POST",
        body: formData,
      });

      const result = await response.json();

      if (result.success) {
        // 如果使用了token，标记为已使用
        const params = new URLSearchParams(location.search);
        const token = params.get('token');
        if (token) {
          await markTokenAsUsed(token);
          
          // 检查是否为实名投递
          const authorType = formData.get('authorType');
          const category = formData.get('category');
          
          if (authorType === 'real') {
            // 实名投递：显示卡名和使用说明
            const cardName = formData.get('cardName') || '未命名';
            uploadStatus.innerHTML = `
              <div style="padding: 16px; background: #FFF3E0; border: 1px solid #FF9800; border-radius: 8px; margin-top: 16px;">
                <strong>✅ 角色卡已保存成功！</strong><br><br>
                <div style="background: #fff; padding: 10px; border-radius: 4px; margin: 8px 0; font-family: monospace; color: #8B5E3C;">
                  卡名: ${cardName}
                </div>
                <strong>📝 下一步操作：</strong><br>
                1️⃣ 请您自己前往 <strong>${category}</strong> 分区发帖<br>
                <div style="display: flex; gap: 10px; margin: 12px 0;">
                  <button id="copyTitleBtn" style="flex: 1; padding: 10px; border: 1px solid #8B5E3C; border-radius: 8px; background: #fff; color: #8B5E3C; cursor: pointer; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='#8B5E3C'; this.style.color='#fff';" onmouseout="if(!this.textContent.includes('✅')) { this.style.background='#fff'; this.style.color='#8B5E3C'; }">📋 复制标题</button>
                  <button id="copyContentBtn" style="flex: 1; padding: 10px; border: 1px solid #8B5E3C; border-radius: 8px; background: #fff; color: #8B5E3C; cursor: pointer; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='#8B5E3C'; this.style.color='#fff';" onmouseout="if(!this.textContent.includes('✅')) { this.style.background='#fff'; this.style.color='#8B5E3C'; }">📋 复制主楼内容</button>
                </div>
                2️⃣ 在您的帖子中使用命令：<code style="background: #f5f5f5; padding: 2px 6px; border-radius: 3px;">/发卡 卡名:${cardName}</code><br>
                3️⃣ Bot会在您的帖子中发送角色卡按钮<br><br>
                <small style="color: #666;">此Token已使用，链接已失效。您可以关闭此页面。</small>
              </div>
            `;
            
            // 绑定复制按钮事件
            setTimeout(() => {
              const titleBtn = document.getElementById('copyTitleBtn');
              const contentBtn = document.getElementById('copyContentBtn');
              
              if (titleBtn) {
                titleBtn.onclick = async () => {
                  const title = generateThreadTitle(formData);
                  try {
                    await navigator.clipboard.writeText(title);
                    titleBtn.textContent = '✅ 已复制';
                    setTimeout(() => { titleBtn.textContent = '📋 复制标题'; }, 2000);
                  } catch (err) {
                    alert('复制失败：' + err.message);
                  }
                };
              }
              
              if (contentBtn) {
                contentBtn.onclick = async () => {
                  const content = generatePreviewText(formData);
                  try {
                    await navigator.clipboard.writeText(content);
                    contentBtn.textContent = '✅ 已复制';
                    setTimeout(() => { contentBtn.textContent = '📋 复制主楼内容'; }, 2000);
                  } catch (err) {
                    alert('复制失败：' + err.message);
                  }
                };
              }
            }, 100);
          } else {
            // 匿名投递：显示成功信息
          uploadStatus.innerHTML = `
            <div style="padding: 12px; background: #E8F5E9; border: 1px solid #4CAF50; border-radius: 8px; margin-top: 16px;">
              <strong>✅ ${result.message}</strong><br>
                <small style="color: #666;">Bot已自动发帖，此Token已使用，链接已失效。您可以关闭此页面。</small>
            </div>
          `;
          }
          
          // 禁用表单防止重复提交
          submitButton.disabled = true;
          submitButton.textContent = "已提交";
          // 清除表单缓存
          clearFormCache();
          return;
        }
        
        uploadForm.reset();
        // 手动重置所有动态表单
        document.querySelector('input[name="cardType"][value="single"]').dispatchEvent(new Event('change'));
        document.querySelector('input[name="authorType"][value="real"]').dispatchEvent(new Event('change'));
        document.querySelector('input[name="secondaryWarningToggle"][value="no"]').dispatchEvent(new Event('change'));
        document.querySelector('input[name="nameRelation"][value="same"]').checked = true;
        updateCharacterUI();
        initCharacterList();
        
        // 清空文件存储和预览
        fileStorage['avatarImage'] = [];
        fileStorage['galleryImages'] = [];
        fileStorage['cardPngFile'] = [];
        fileStorage['cardJsonFile'] = [];
        fileStorage['attachments'] = [];
        document.getElementById('avatarPreviews').innerHTML = '';
        document.getElementById('galleryPreviews').innerHTML = '';
        document.getElementById('cardPngPreviews').innerHTML = '';
        document.getElementById('cardJsonPreviews').innerHTML = '';
        document.getElementById('attachmentPreviews').innerHTML = '';
        
        // 清除表单缓存
        clearFormCache();
        
        // 投递成功 
      } else {
        uploadStatus.textContent = "失败: " + result.message;
      }
    } catch (error) {
      console.error("提交出错:", error);
      uploadStatus.textContent = "投递失败，请检查网络连接或控制台报错。";
    } finally {
      submitButton.disabled = false;
      submitButton.textContent = "投递";
    }
  });

  // --- 自动缓存功能 ---
  const CACHE_KEY = 'duidui_card_form_cache';
  
  // 保存表单数据到 localStorage
  function saveFormCache() {
    try {
      const formData = {
        // 基础信息
        cardType: document.querySelector('input[name="cardType"]:checked')?.value,
        nameRelation: document.querySelector('input[name="nameRelation"]:checked')?.value,
        cardName: document.getElementById('cardName')?.value,
        threadTitle: document.getElementById('threadTitle')?.value,
        singleCharacterName: document.getElementById('singleCharacterName')?.value,
        characters: Array.from(document.querySelectorAll('input[name="characters"]')).map(i => i.value),
        authorType: document.querySelector('input[name="authorType"]:checked')?.value,
        authorName: document.getElementById('authorName')?.value,
        category: document.getElementById('category')?.value,
        
        // Tags
        tags: Array.from(document.querySelectorAll('input[name="tags"]:checked')).map(i => i.id),
        
        // 自定义板块
        customSections: {},
        
        // 文本域
        warnings: document.getElementById('warnings')?.value,
        description: document.getElementById('description')?.value,
        otherInfo: document.getElementById('otherInfo')?.value,
        secondaryWarningToggle: document.querySelector('input[name="secondaryWarningToggle"]:checked')?.value,
        secondaryWarning: document.getElementById('secondaryWarning')?.value
      };
      
      // 收集所有自定义板块的选中状态
      document.querySelectorAll('[id^="section_"]').forEach(section => {
        const sectionId = section.id;
        const checkboxes = section.querySelectorAll('input[type="checkbox"]:checked');
        const radios = section.querySelectorAll('input[type="radio"]:checked');
        
        if (checkboxes.length > 0) {
          formData.customSections[sectionId] = Array.from(checkboxes).map(cb => ({
            name: cb.name,
            value: cb.value
          }));
        }
        if (radios.length > 0) {
          formData.customSections[sectionId] = Array.from(radios).map(r => ({
            name: r.name,
            value: r.value
          }));
        }
      });
      
      localStorage.setItem(CACHE_KEY, JSON.stringify(formData));
    } catch (e) {
      console.warn('保存表单缓存失败:', e);
    }
  }
  
  // 从 localStorage 恢复表单数据
  function restoreFormCache() {
    try {
      const cached = localStorage.getItem(CACHE_KEY);
      if (!cached) return false;
      
      const formData = JSON.parse(cached);
      
      // 恢复基础信息
      if (formData.cardType) {
        const radio = document.querySelector(`input[name="cardType"][value="${formData.cardType}"]`);
        if (radio) radio.checked = true;
      }
      if (formData.nameRelation) {
        const radio = document.querySelector(`input[name="nameRelation"][value="${formData.nameRelation}"]`);
        if (radio) radio.checked = true;
      }
      if (formData.cardName) document.getElementById('cardName').value = formData.cardName;
      if (formData.threadTitle) document.getElementById('threadTitle').value = formData.threadTitle;
      if (formData.singleCharacterName) document.getElementById('singleCharacterName').value = formData.singleCharacterName;
      
      // 恢复多人卡角色名
      if (formData.characters && formData.characters.length > 0) {
        const characterList = document.getElementById('characterList');
        if (characterList) {
          characterList.innerHTML = '';
          formData.characters.forEach((name, idx) => {
            const chip = createCharacterChip(`角色${idx + 1}`);
            const input = chip.querySelector('input');
            if (input) input.value = name;
            characterList.appendChild(chip);
          });
        }
      }
      
      if (formData.authorType) {
        const radio = document.querySelector(`input[name="authorType"][value="${formData.authorType}"]`);
        if (radio) radio.checked = true;
      }
      // 只在没有被token锁定时恢复作者名和分区
      const authorNameInput = document.getElementById('authorName');
      const categoryInput = document.getElementById('category');
      
      if (formData.authorName && authorNameInput && !authorNameInput.readOnly && !authorNameInput.dataset.tokenLocked) {
        authorNameInput.value = formData.authorName;
      }
      if (formData.category && categoryInput && !categoryInput.readOnly && !categoryInput.classList.contains('locked')) {
        categoryInput.value = formData.category;
      }
      
      // 立即恢复文本域
      if (formData.warnings) document.getElementById('warnings').value = formData.warnings;
      if (formData.description) document.getElementById('description').value = formData.description;
      if (formData.otherInfo) document.getElementById('otherInfo').value = formData.otherInfo;
      if (formData.secondaryWarningToggle) {
        const radio = document.querySelector(`input[name="secondaryWarningToggle"][value="${formData.secondaryWarningToggle}"]`);
        if (radio) {
          radio.checked = true;
          radio.dispatchEvent(new Event('change'));
        }
      }
      if (formData.secondaryWarning) document.getElementById('secondaryWarning').value = formData.secondaryWarning;
      
      // 恢复 Tags（现在tags已经渲染完成，只需要短暂延迟确保DOM稳定）
      setTimeout(() => {
        if (formData.tags) {
          formData.tags.forEach(tagId => {
            const checkbox = document.getElementById(tagId);
            if (checkbox) checkbox.checked = true;
          });
        }
        
        // 恢复自定义板块
        if (formData.customSections) {
          Object.keys(formData.customSections).forEach(sectionId => {
            const values = formData.customSections[sectionId];
            values.forEach(item => {
              const input = document.querySelector(`input[name="${item.name}"][value="${item.value}"]`);
              if (input) input.checked = true;
            });
          });
        }
        
        // 触发UI更新
        updateCharacterUI();
        if (window.updateDiscordPreview) {
          window.updateDiscordPreview();
        }
      }, 50); // 缩短延迟时间，因为tags已经渲染完成
      
      console.log('✅ 已恢复表单缓存');
      
      // 显示恢复提示（灰色半透明胶囊）
      // 注意：如果 uploadStatus 已经有内容（比如 Token 已使用的提示和复制按钮），则不覆盖
      const statusDiv = document.getElementById('uploadStatus');
      if (statusDiv && !statusDiv.innerHTML.trim()) {
        statusDiv.innerHTML = `
          <div style="display: inline-block; padding: 8px 16px; background: rgba(128, 128, 128, 0.15); border-radius: 20px; margin-bottom: 16px; color: #666; font-size: 14px;">
            已恢复上次未提交的表单内容
          </div>
        `;
      }
      
      return true;
    } catch (e) {
      console.warn('恢复表单缓存失败:', e);
      return false;
    }
  }
  
  // 清除缓存
  function clearFormCache() {
    try {
      localStorage.removeItem(CACHE_KEY);
      console.log('✅ 已清除表单缓存');
    } catch (e) {
      console.warn('清除表单缓存失败:', e);
    }
  }

  // 将Markdown格式转换为HTML（**粗体, *斜体）
  function markdownToHtml(text) {
    if (!text) return text;
    // 先处理 ** （粗体），再处理 * （斜体）
    // 使用非贪婪匹配，避免跨行匹配
    let html = text
      .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>') // **粗体**
      .replace(/\*(.+?)\*/g, '<em>$1</em>'); // *斜体*
    return html;
  }
  
  // --- Discord预览更新函数（全局） ---
  window.updateDiscordPreview = function() {
    // 更新帖子标题
    const threadTitle = document.getElementById('threadTitle')?.value.trim();
    const previewThreadTitle = document.getElementById('previewThreadTitle');
    if (previewThreadTitle) {
      if (threadTitle) {
        previewThreadTitle.innerHTML = threadTitle;
      } else {
        previewThreadTitle.innerHTML = '<span class="preview-placeholder">未填写帖子标题</span>';
      }
    }
    
    // 更新马甲名
    const authorType = document.querySelector('input[name="authorType"]:checked')?.value;
    const authorName = document.getElementById('authorName')?.value.trim();
    let vestName = '匿名';
    
    if (authorType === 'real' && authorName) {
      vestName = authorName;
    } else if (authorType === 'anonymous' && authorName) {
      vestName = authorName;
    }
    
    const usernameEl = document.getElementById('previewUsername');
    const vestEl = document.getElementById('previewVest');
    if (usernameEl) usernameEl.textContent = vestName;
    if (vestEl) vestEl.textContent = vestName;
    
    // 更新头像（优先级：投递的头像 > PNG角色卡 > Discord默认图标）
    const avatarElement = document.getElementById('previewAvatar');
    if (!avatarElement) return;
    
    const avatarFiles = fileStorage['avatarImage'] || [];
    const cardPngFiles = fileStorage['cardPngFile'] || [];
    
    if (avatarFiles.length > 0 && avatarFiles[0].type.startsWith('image/')) {
      // 使用投递的头像
      const reader = new FileReader();
      reader.onload = (e) => {
        avatarElement.innerHTML = `<img src="${e.target.result}" alt="头像">`;
      };
      reader.readAsDataURL(avatarFiles[0]);
    } else if (cardPngFiles.length > 0 && cardPngFiles[0].type === 'image/png') {
      // 使用PNG角色卡作为头像
      const reader = new FileReader();
      reader.onload = (e) => {
        avatarElement.innerHTML = `<img src="${e.target.result}" alt="角色卡">`;
      };
      reader.readAsDataURL(cardPngFiles[0]);
    } else {
      // 使用Discord默认图标
      avatarElement.innerHTML = `<img src="默认头像.png" alt="默认头像">`;
    }
    
    // 更新卡名
    const cardName = document.getElementById('cardName')?.value.trim();
    const previewCardName = document.getElementById('previewCardName');
    if (previewCardName) {
      if (cardName) {
        previewCardName.innerHTML = cardName;
      } else {
        previewCardName.innerHTML = '<span class="preview-placeholder">未填写</span>';
      }
    }
    
    // 更新角色名（仅不同名或多人卡显示）
    const cardType = document.querySelector('input[name="cardType"]:checked')?.value;
    const nameRelation = document.querySelector('input[name="nameRelation"]:checked')?.value;
    const previewCharactersField = document.getElementById('previewCharactersField');
    const previewCharacters = document.getElementById('previewCharacters');
    
    if (previewCharactersField && previewCharacters) {
      let shouldShowCharacters = false;
      const characters = [];
      
      if (cardType === 'multi') {
        // 多人卡：收集所有角色名
        document.querySelectorAll('input[name="characters"]').forEach(input => {
          const val = input.value.trim();
          if (val) characters.push(val);
        });
        shouldShowCharacters = characters.length > 0;
      } else if (cardType === 'single' && nameRelation === 'different') {
        // 单人卡不同名：显示单个角色名
        const singleChar = document.getElementById('singleCharacterName')?.value.trim();
        if (singleChar) {
          characters.push(singleChar);
          shouldShowCharacters = true;
        }
      }
      
      if (shouldShowCharacters) {
        previewCharactersField.style.display = '';
        previewCharacters.textContent = characters.join(' / ');
      } else {
        previewCharactersField.style.display = 'none';
      }
    }
    
    // 更新性向（从自定义板块获取，支持单选和多选）
    const orientations = [];
    document.querySelectorAll('input[name="custom_性向"]:checked, input[name="custom_性向[]"]:checked').forEach(cb => {
      orientations.push(cb.value);
    });
    
    const previewOrientationField = document.getElementById('previewOrientationField');
    const previewOrientation = document.getElementById('previewOrientation');
    if (previewOrientationField && previewOrientation) {
      if (orientations.length > 0) {
        previewOrientationField.style.display = '';
        previewOrientation.textContent = orientations.join(' / ');
      } else {
        previewOrientationField.style.display = 'none';
      }
    }
    
    // 更新 Tags（文字格式：xx/xx/xx）
    const selectedTags = [];
    document.querySelectorAll('input[type="checkbox"].pill-input:checked').forEach(cb => {
      const label = document.querySelector(`label[for="${cb.id}"]`);
      if (label && cb.name === 'tags') {
        selectedTags.push(label.textContent.trim());
      }
    });
    
    const previewTagsField = document.getElementById('previewTagsField');
    const previewTags = document.getElementById('previewTags');
    if (previewTagsField && previewTags) {
      if (selectedTags.length > 0) {
        previewTagsField.style.display = '';
        previewTags.textContent = selectedTags.join(' / ');
      } else {
        previewTagsField.style.display = 'none';
      }
    }
    
    // 更新自定义板块（除了性向）
    const customSectionsContainer = document.getElementById('previewCustomSections');
    if (customSectionsContainer) {
      customSectionsContainer.innerHTML = '';
      
      // 遍历所有自定义板块
      document.querySelectorAll('[id^="section_"]').forEach(section => {
        const sectionId = section.id;
        if (!sectionId.startsWith('section_')) return;
        
        // 提取板块标题（移除 * 和 : 标记）
        const labelEl = section.querySelector('.group-label');
        if (!labelEl) return;
        const sectionTitle = labelEl.textContent.replace(/\*/g, '').replace(':', '').trim();
        
        // 跳过性向和下载要求（已单独显示或不需要显示）
        if (sectionTitle === '性向' || sectionTitle === '下载要求') return;
        
        // 收集该板块的选中项
        const sectionValues = [];
        section.querySelectorAll('input:checked').forEach(input => {
          sectionValues.push(input.value);
        });
        
        // 如果有选中项，显示该板块（应用Markdown渲染）
        if (sectionValues.length > 0) {
          const fieldDiv = document.createElement('div');
          fieldDiv.className = 'discord-field';
          const valuesText = sectionValues.join(' / ');
          const valuesHtml = markdownToHtml(valuesText);
          fieldDiv.innerHTML = `
            <span class="discord-field-label">${sectionTitle}：</span>
            <span class="discord-field-value">${valuesHtml}</span>
          `;
          customSectionsContainer.appendChild(fieldDiv);
      }
      });
    }
    
    // 检查是否为深渊分区
    const category = document.getElementById('category')?.value.trim();
    const isAbyss = category === '深渊';
    
    // 更新简介（仅非深渊分区显示，应用Markdown渲染）
    const description = document.getElementById('description')?.value || '';
    const previewDescriptionField = document.getElementById('previewDescriptionField');
    const previewDescription = document.getElementById('previewDescription');
    if (previewDescriptionField && previewDescription) {
      if (!isAbyss && description.trim()) {
        previewDescriptionField.style.display = '';
        // 将换行转换为<br>，应用Markdown渲染
        const descriptionHtml = markdownToHtml(description).replace(/\n/g, '<br>');
        previewDescription.innerHTML = descriptionHtml;
      } else {
        previewDescriptionField.style.display = 'none';
      }
    }
    
    // 更新排雷（保留换行，应用Markdown渲染）
    const warnings = document.getElementById('warnings')?.value || '';
    const previewWarnings = document.getElementById('previewWarnings');
    if (previewWarnings) {
      if (warnings.trim()) {
        // 将换行转换为<br>，应用Markdown渲染
        const warningsHtml = markdownToHtml(warnings).replace(/\n/g, '<br>');
        previewWarnings.innerHTML = warningsHtml;
      } else {
        previewWarnings.innerHTML = '<span class="preview-placeholder">未填写</span>';
      }
    }
    
    // 更新其她（解析 otherInfo，过滤已单独显示的字段，移除 * 标记）
    const otherInfo = document.getElementById('otherInfo')?.value || '';
    const previewOtherInfoField = document.getElementById('previewOtherInfoField');
    const previewOtherInfo = document.getElementById('previewOtherInfo');
    if (previewOtherInfoField && previewOtherInfo) {
      if (otherInfo.trim()) {
        // 解析 otherInfo，过滤掉已单独显示的字段
        const lines = otherInfo.split('\n');
        const filteredLines = [];
        
        for (const line of lines) {
          const trimmed = line.trim();
          if (!trimmed) continue;
          
          // 匹配格式："{title}: {value1}, {value2}" 或 "{title}*: {value}"
          const match = trimmed.match(/^([^：:]+)[：:]\s*(.+)$/);
          if (match) {
            let title = match[1].trim().replace(/\*/g, '').trim();
            // 跳过已单独显示的字段
            if (title === '下载要求' || title === '性向' || title === '背景') {
              continue;
            }
            // 移除 * 标记后保留
            const cleanLine = trimmed.replace(/\*/g, '');
            filteredLines.push(cleanLine);
          } else {
            // 不是键值对格式的行，直接保留
            filteredLines.push(trimmed);
          }
        }
        
        if (filteredLines.length > 0) {
          previewOtherInfoField.style.display = '';
          // 应用Markdown渲染，将换行转换为<br>
          const otherInfoHtml = markdownToHtml(filteredLines.join('\n')).replace(/\n/g, '<br>');
          previewOtherInfo.innerHTML = otherInfoHtml;
        } else {
          previewOtherInfoField.style.display = 'none';
        }
      } else {
        previewOtherInfoField.style.display = 'none';
      }
    }
    
    // 赞数预览已取消（所有分区都不显示）
    const previewLikeSection = document.getElementById('previewLikeSection');
    if (previewLikeSection) {
      previewLikeSection.style.display = 'none';
    }
    
    // 更新主楼图片（Discord动态布局样式）
    const galleryFiles = fileStorage['galleryImages'] || [];
    const previewImagesContainer = document.getElementById('previewImagesContainer');
    const previewImages = document.getElementById('previewImages');
    
    if (previewImagesContainer && previewImages) {
      if (galleryFiles.length > 0) {
        previewImagesContainer.style.display = '';
        previewImages.innerHTML = '';
        
        // 根据图片数量应用对应的CSS类
        const imageCount = galleryFiles.length;
        previewImages.className = 'discord-images';
        
        // 限制显示数量，超过10张时只显示前10张（Discord通常也会限制显示数量）
        const displayCount = Math.min(imageCount, 10);
        
        // 根据数量应用对应类名
        if (imageCount <= 10) {
          previewImages.classList.add(`count-${imageCount}`);
        } else {
          previewImages.classList.add('count-10');
        }
        
        for (let index = 0; index < displayCount; index++) {
          const file = galleryFiles[index];
          const reader = new FileReader();
          reader.onload = (e) => {
            const imgDiv = document.createElement('div');
            imgDiv.className = 'discord-image';
            imgDiv.innerHTML = `<img src="${e.target.result}" alt="图片${index + 1}">`;
            previewImages.appendChild(imgDiv);
            
            // 如果有超过10张图片，在第10张上显示 +N 覆盖
            if (index === 9 && galleryFiles.length > 10) {
              const overlay = document.createElement('div');
              overlay.style.position = 'absolute';
              overlay.style.top = '0';
              overlay.style.left = '0';
              overlay.style.right = '0';
              overlay.style.bottom = '0';
              overlay.style.background = 'rgba(0, 0, 0, 0.6)';
              overlay.style.display = 'flex';
              overlay.style.alignItems = 'center';
              overlay.style.justifyContent = 'center';
              overlay.style.color = 'white';
              overlay.style.fontSize = '20px';
              overlay.style.fontWeight = 'bold';
              overlay.style.borderRadius = '4px';
              overlay.textContent = `+${galleryFiles.length - 10}`;
              imgDiv.style.position = 'relative';
              imgDiv.appendChild(overlay);
            }
          };
          reader.readAsDataURL(file);
        }
      } else {
        previewImagesContainer.style.display = 'none';
      }
    }
  };
  
  // --- 文件上传预览功能 ---
  const fileStorage = {}; // 存储每个input的文件列表

  function setupFilePreview(inputId, previewId, isImage = false, multiple = false) {
    const input = document.getElementById(inputId);
    const preview = document.getElementById(previewId);
    
    // 初始化存储
    if (!fileStorage[inputId]) {
      fileStorage[inputId] = [];
    }
    
    input.addEventListener('change', (e) => {
      const newFiles = Array.from(e.target.files || []);
      
      if (multiple) {
        // 多文件模式：累积文件
        const currentFiles = fileStorage[inputId] || [];
        let filesToAdd = newFiles;
        
        // 特殊处理主楼图片的10张限制
        if (inputId === 'galleryImages') {
          const maxImages = 10;
          const availableSlots = maxImages - currentFiles.length;
          
          if (availableSlots <= 0) {
            // 已达到上限，显示提示
            const uploadStatus = document.getElementById('uploadStatus');
            if (uploadStatus) {
              uploadStatus.innerHTML = `
                <div style="padding: 8px 16px; background: rgba(255, 193, 7, 0.15); border-radius: 20px; margin-bottom: 16px; color: #856404; font-size: 14px;">
                  ⚠️ 主楼图片已达到最大数量限制（10张）
                </div>
              `;
              // 3秒后清除提示
              setTimeout(() => {
                if (uploadStatus.innerHTML.includes('主楼图片已达到最大数量限制')) {
                  uploadStatus.innerHTML = '';
                }
              }, 3000);
            }
            return; // 不添加任何文件
          } else if (filesToAdd.length > availableSlots) {
            // 超出剩余槽位，只添加部分文件
            filesToAdd = filesToAdd.slice(0, availableSlots);
            const uploadStatus = document.getElementById('uploadStatus');
            if (uploadStatus) {
              uploadStatus.innerHTML = `
                <div style="padding: 8px 16px; background: rgba(255, 193, 7, 0.15); border-radius: 20px; margin-bottom: 16px; color: #856404; font-size: 14px;">
                  ⚠️ 主楼图片最多只能上传10张，已自动选择前${availableSlots}张图片
                </div>
              `;
              // 3秒后清除提示
              setTimeout(() => {
                if (uploadStatus.innerHTML.includes('主楼图片最多只能上传10张')) {
                  uploadStatus.innerHTML = '';
                }
              }, 3000);
            }
          }
        }
        
        fileStorage[inputId] = [...currentFiles, ...filesToAdd];
      } else {
        // 单文件模式：替换
        fileStorage[inputId] = newFiles;
      }
      
      // 更新 input.files
      const dt = new DataTransfer();
      fileStorage[inputId].forEach(f => dt.items.add(f));
      input.files = dt.files;
      
      // 重新渲染预览
      renderPreviews(inputId, previewId, isImage);
      
      // 如果是头像、主楼图片或PNG角色卡，延迟更新Discord预览（确保文件读取完成）
      if (inputId === 'avatarImage' || inputId === 'galleryImages' || inputId === 'cardPngFile') {
        setTimeout(() => {
          if (window.updateDiscordPreview) {
            window.updateDiscordPreview();
          }
        }, 100);
      }
    });
  }

  function renderPreviews(inputId, previewId, isImage) {
    const preview = document.getElementById(previewId);
    preview.innerHTML = '';
    const files = fileStorage[inputId] || [];
    
    files.forEach((file, idx) => {
      if ((isImage && file.type.startsWith('image/')) || (inputId === 'cardPngFile' && file.type === 'image/png')) {
        const reader = new FileReader();
        reader.onload = (ev) => {
          const div = document.createElement('div');
          div.className = 'upload-thumbnail';
          div.innerHTML = `
            <img src="${ev.target.result}" alt="${file.name}">
            <button class="remove" type="button" onclick="removeFile('${inputId}', ${idx})">×</button>
          `;
          preview.appendChild(div);
        };
        reader.readAsDataURL(file);
      } else {
        const div = document.createElement('div');
        div.className = 'upload-thumbnail';
        div.innerHTML = `
          <div style="display:flex;align-items:center;justify-content:center;height:100%;background:#f5f5f5;font-size:12px;text-align:center;padding:4px;">${file.name}</div>
          <button class="remove" type="button" onclick="removeFile('${inputId}', ${idx})">×</button>
        `;
        preview.appendChild(div);
      }
    });
  }

  window.removeFile = function(inputId, index) {
    // 从存储中删除
    fileStorage[inputId].splice(index, 1);
    
    // 更新 input.files
    const input = document.getElementById(inputId);
    const dt = new DataTransfer();
    fileStorage[inputId].forEach(f => dt.items.add(f));
    input.files = dt.files;
    
    // 确定预览容器和是否为图片
    const previewMapping = {
      'avatarImage': { previewId: 'avatarPreviews', isImage: true },
      'galleryImages': { previewId: 'galleryPreviews', isImage: true },
      'cardPngFile': { previewId: 'cardPngPreviews', isImage: true },
      'cardJsonFile': { previewId: 'cardJsonPreviews', isImage: false },
      'attachments': { previewId: 'attachmentPreviews', isImage: false }
    };
    
    const mapping = previewMapping[inputId] || { previewId: inputId + 'Previews', isImage: false };
    renderPreviews(inputId, mapping.previewId, mapping.isImage);
    
    // 如果删除的是头像、主楼图片或PNG角色卡，延迟更新Discord预览
    if (inputId === 'avatarImage' || inputId === 'galleryImages' || inputId === 'cardPngFile') {
      setTimeout(() => {
        if (window.updateDiscordPreview) {
          window.updateDiscordPreview();
        }
      }, 100);
    }
  };

  // 页面加载时初始化
  document.addEventListener('DOMContentLoaded', async () => {
    // URL 参数处理
    const params = new URLSearchParams(location.search);
    const token = params.get('token');
    
    // 如果有token，先验证
    if (token) {
      const verifyResult = await verifyToken(token);
      
      if (!verifyResult.valid && !verifyResult.used) {
        // Token验证失败（无效或过期），禁用表单
        document.getElementById('uploadForm').style.display = 'none';
        document.getElementById('uploadStatus').textContent = '⚠️ Token验证失败，无法使用此链接投递卡片。请联系管理员获取新的发卡链接。';
        document.getElementById('uploadStatus').style.color = '#B5534E';
        return;
      }
      
      if (verifyResult.used) {
        // Token已使用，显示提示，恢复缓存，禁用投递按钮
        const uploadStatus = document.getElementById('uploadStatus');
        uploadStatus.innerHTML = `
          <div style="padding: 16px; background: #FFF3E0; border: 1px solid #FF9800; border-radius: 8px; margin-bottom: 16px;">
            ⚠️ <strong>此Token已使用</strong><br>
            <small>表单内容已从缓存恢复，您可以查看之前填写的内容并复制文本，但无法再次投递。</small>
          </div>
        `;
        
        // 禁用投递按钮
        const submitButton = document.getElementById('submitButton');
        if (submitButton) {
          submitButton.disabled = true;
          submitButton.textContent = 'Token已使用';
          submitButton.style.background = '#ccc';
          submitButton.style.cursor = 'not-allowed';
        }
        
        // 恢复缓存
        await loadConfig();
        restoreFormCache();
        
        // 添加复制按钮（如果缓存中有数据）
        const cachedData = localStorage.getItem('cardFormCache');
        if (cachedData) {
          try {
            const formData = JSON.parse(cachedData);
            const copyButtonsHtml = `
              <div style="display: flex; gap: 10px; margin-top: 12px;">
                <button id="cachedCopyTitleBtn" style="flex: 1; padding: 10px; border: 1px solid #8B5E3C; border-radius: 8px; background: #fff; color: #8B5E3C; cursor: pointer; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='#8B5E3C'; this.style.color='#fff';" onmouseout="if(!this.textContent.includes('✅')) { this.style.background='#fff'; this.style.color='#8B5E3C'; }">📋 复制标题</button>
                <button id="cachedCopyContentBtn" style="flex: 1; padding: 10px; border: 1px solid #8B5E3C; border-radius: 8px; background: #fff; color: #8B5E3C; cursor: pointer; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='#8B5E3C'; this.style.color='#fff';" onmouseout="if(!this.textContent.includes('✅')) { this.style.background='#fff'; this.style.color='#8B5E3C'; }">📋 复制主楼内容</button>
              </div>
            `;
            uploadStatus.innerHTML += copyButtonsHtml;
            
            // 绑定复制按钮事件
            setTimeout(() => {
              const titleBtn = document.getElementById('cachedCopyTitleBtn');
              const contentBtn = document.getElementById('cachedCopyContentBtn');
              
              if (titleBtn) {
                titleBtn.onclick = async () => {
                  const title = generateThreadTitle();
                  try {
                    await navigator.clipboard.writeText(title);
                    titleBtn.textContent = '✅ 已复制';
                    setTimeout(() => { titleBtn.textContent = '📋 复制标题'; }, 2000);
                  } catch (err) {
                    alert('复制失败：' + err.message);
                  }
                };
              }
              
              if (contentBtn) {
                contentBtn.onclick = async () => {
                  const content = generatePreviewText();
                  try {
                    await navigator.clipboard.writeText(content);
                    contentBtn.textContent = '✅ 已复制';
                    setTimeout(() => { contentBtn.textContent = '📋 复制主楼内容'; }, 2000);
                  } catch (err) {
                    alert('复制失败：' + err.message);
                  }
                };
              }
            }, 100);
          } catch (e) {
            console.error('解析缓存失败:', e);
          }
        }
        
        // 不return，继续执行，让表单正常显示
      }
      
      // Token验证成功且未使用，预填信息
      if (verifyResult.valid && TOKEN_DATA) {
        // 预填分区
        const categoryInput = document.getElementById('category');
        categoryInput.value = TOKEN_DATA.category;
        categoryInput.readOnly = true;
        categoryInput.classList.add('locked');
        
        // 预填作者名（使用display_name或username）
        const authorNameInput = document.getElementById('authorName');
        
        // 预填authorId（隐藏字段）
        const authorIdInput = document.getElementById('authorId');
        authorIdInput.value = TOKEN_DATA.user_id;
        
        // 根据分区决定默认作者类型
        const isAbyss = TOKEN_DATA.category === '深渊';
        const realRadio = document.querySelector('input[name="authorType"][value="real"]');
        const anonymousRadio = document.querySelector('input[name="authorType"][value="anonymous"]');
        
        if (isAbyss) {
          // 深渊区：默认匿名，禁用实名选项
          anonymousRadio.checked = true;
          realRadio.disabled = true;
          realRadio.parentElement.style.opacity = '0.5';
          realRadio.parentElement.style.cursor = 'not-allowed';
          realRadio.parentElement.title = '深渊区禁止实名投递';
          
          authorNameInput.value = ''; // 清空，让用户填写马甲
          authorNameInput.readOnly = false;
          authorNameInput.placeholder = '马甲 (不填默认匿名)';
          authorNameInput.dataset.tokenLocked = 'false';
        } else {
          // 非深渊区：默认实名并锁定
          realRadio.checked = true;
          realRadio.disabled = false;
          realRadio.parentElement.style.opacity = '1';
          realRadio.parentElement.style.cursor = '';
          realRadio.parentElement.title = '';
          
          authorNameInput.value = TOKEN_DATA.display_name || TOKEN_DATA.username;
          authorNameInput.readOnly = true;
          authorNameInput.classList.add('locked');
          authorNameInput.dataset.tokenLocked = 'true';
          
          // 监听作者类型切换（仅非深渊区）
        document.querySelectorAll('input[name="authorType"]').forEach(radio => {
          radio.addEventListener('change', (e) => {
            if (authorNameInput.dataset.tokenLocked === 'true') {
              if (e.target.value === 'anonymous') {
                // 切换到匿名：解锁，允许修改为马甲名
                authorNameInput.readOnly = false;
                authorNameInput.classList.remove('locked');
                authorNameInput.placeholder = '马甲 (不填默认匿名)';
                authorNameInput.value = ''; // 清空，让用户填写马甲
              } else {
                // 切换到实名：锁定，恢复Discord名字
                authorNameInput.readOnly = true;
                authorNameInput.classList.add('locked');
                authorNameInput.placeholder = '实名';
                authorNameInput.value = TOKEN_DATA.display_name || TOKEN_DATA.username;
              }
            }
          });
        });
        }
        
        // 显示提示信息（移除深渊区警告提示）
        const statusDiv = document.getElementById('uploadStatus');
        statusDiv.innerHTML = `
          <div style="padding: 12px; background: #E8F5E9; border: 1px solid #4CAF50; border-radius: 8px; margin-bottom: 16px;">
            <strong>✅ 已通过Discord验证</strong><br>
            用户: ${TOKEN_DATA.display_name || TOKEN_DATA.username}<br>
            分区: ${TOKEN_DATA.category}<br>
            <small style="color: #666;">您的信息已自动填写${isAbyss ? '' : '并锁定'}，请继续填写其他信息。</small>
          </div>
        `;
      }
    }
    
    await loadConfig();
    initCharacterList();
    
    // 在tags渲染完成后恢复缓存
    // 即使有token，也恢复其他字段（分区和作者名会被restoreFormCache内部判断跳过）
      restoreFormCache();

    // 文件预览（第4个参数表示是否支持多文件累积）
    setupFilePreview('avatarImage', 'avatarPreviews', true, false);     // 头像，单文件
    setupFilePreview('galleryImages', 'galleryPreviews', true, true);   // 图片，多选累积
    setupFilePreview('cardPngFile', 'cardPngPreviews', true, false);    // PNG卡，单文件
    setupFilePreview('cardJsonFile', 'cardJsonPreviews', false, false); // JSON卡，单文件
    setupFilePreview('attachments', 'attachmentPreviews', false, true); // 附件，多选累积

    // 文本域自动高度
    document.querySelectorAll('textarea').forEach(t => {
      const resize = () => { 
        t.style.height = 'auto'; 
        t.style.height = (t.scrollHeight) + 'px'; 
      };
      t.addEventListener('input', resize);
      resize();
    });

    // 兼容旧的URL参数预填与锁定（如果没有token的话）
    if (!token) {
    const category = params.get('category');
    if (category) { 
      const cat = document.getElementById('category'); 
      cat.value = decodeURIComponent(category); 
    }
    
    const authorName = params.get('authorName');
    if (authorName) { 
      const au = document.getElementById('authorName'); 
      au.value = decodeURIComponent(authorName); 
    }
    
    const authorId = params.get('authorId');
    if (authorId) { 
      const aid = document.getElementById('authorId'); 
      aid.value = decodeURIComponent(authorId); 
    }
    
    if (params.get('lockCategory') === '1') { 
      const cat = document.getElementById('category'); 
      cat.readOnly = true; 
      cat.classList.add('locked'); 
    }
    
    if (params.get('lockAuthor') === '1') { 
      const au = document.getElementById('authorName'); 
      au.readOnly = true; 
      au.classList.add('locked'); 
      }
    }

    // 顶部导航的平滑滚动
    const navUpload = document.getElementById('navUpload');
    if (navUpload) navUpload.addEventListener('click', (e) => {
      e.preventDefault();
      document.getElementById('upload').scrollIntoView({ behavior: 'smooth', block: 'start' });
    });

    // 步骤点击跳转
    const stepMap = {
      step1: document.getElementById('section-base'),
      step2: document.getElementById('section-tags'),
      step3: document.getElementById('section-files')
    };
    Object.keys(stepMap).forEach(id => {
      const el = document.getElementById(id);
      el.style.cursor = 'pointer';
      el.addEventListener('click', () => {
        stepMap[id].scrollIntoView({ behavior: 'smooth', block: 'start' });
      });
    });

    // 根据填写进度更新步骤状态
    const steps = [
      { id: 'step1', check: () => {
          const nameFilled = (document.getElementById('cardName').value || '').trim().length > 0;
          return nameFilled;
        }
      },
      { id: 'step2', check: () => {
          return true; // tags 变为可选
        }
      },
      { id: 'step3', check: () => {
          const hasPng = document.getElementById('cardPngFile').files.length > 0;
          const hasJson = document.getElementById('cardJsonFile').files.length > 0;
          return hasPng || hasJson;
        }
      }
    ];

    const updateSteps = () => {
      let reachedIncomplete = false;
      steps.forEach((s, idx) => {
        const el = document.getElementById(s.id);
        const ok = s.check();
        el.classList.toggle('completed', ok);
        el.classList.toggle('active', !reachedIncomplete);
        if (!ok) reachedIncomplete = true; else if (idx < steps.length - 1) el.classList.remove('active');
      });
    };

    document.getElementById('cardName').addEventListener('input', updateSteps);
    document.getElementById('cardPngFile').addEventListener('change', updateSteps);
    document.getElementById('cardJsonFile').addEventListener('change', updateSteps);
    updateSteps();

    // === 绑定Discord预览监听器 ===
    // 监听所有相关字段的变化
    const fieldsToWatch = [
      'authorName',
      'cardName',
      'threadTitle',  // 帖子标题
      'category',
      'warnings',
      'description',
      'otherInfo',
      'singleCharacterName'  // 单人角色名
    ];
    
    fieldsToWatch.forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener('input', window.updateDiscordPreview);
      }
    });
    
    // 监听作者类型变化（更新预览）
    document.querySelectorAll('input[name="authorType"]').forEach(radio => {
      radio.addEventListener('change', () => {
        window.updateDiscordPreview();
    });
    });
    
    // 监听 Tags 变化（需要通过 MutationObserver 或委托事件）
    document.addEventListener('change', (e) => {
      if (e.target.classList.contains('pill-input') || 
          e.target.name?.startsWith('custom_') ||
          e.target.type === 'checkbox') {
        window.updateDiscordPreview();
      }
    });
    
    // 初始化预览
    window.updateDiscordPreview();
    
    // === 自动保存表单缓存 ===
    // 防抖函数，避免频繁保存
    let saveTimeout;
    function debouncedSaveCache() {
      clearTimeout(saveTimeout);
      saveTimeout = setTimeout(() => {
        saveFormCache();
      }, 1000); // 1秒后保存
    }
    
    // 监听所有表单输入变化
    const formEl = document.getElementById('uploadForm');
    if (formEl) {
      // 监听 input 和 change 事件
      formEl.addEventListener('input', debouncedSaveCache);
      formEl.addEventListener('change', debouncedSaveCache);
    }
    
    // 监听多人卡角色名的动态添加/删除
    const characterList = document.getElementById('characterList');
    if (characterList) {
      const observer = new MutationObserver(debouncedSaveCache);
      observer.observe(characterList, { childList: true, subtree: true });
    }
    
    // 页面离开前保存（防止意外关闭）
    window.addEventListener('beforeunload', (e) => {
      saveFormCache();
    });
    
    // === 刷新后恢复复制按钮 ===
    // 在页面加载完成后，检查是否有缓存数据，如果有则显示复制按钮
    function showCopyButtonsFromCache() {
      const cachedData = localStorage.getItem('cardFormCache');
      const uploadStatus = document.getElementById('uploadStatus');
      
      // 有缓存数据就显示复制按钮（无论 Token 状态如何）
      if (cachedData && uploadStatus && !uploadStatus.querySelector('#cachedCopyTitleBtn')) {
        try {
          const formData = JSON.parse(cachedData);
          const copyButtonsHtml = `
            <div id="cachedCopyButtonsContainer" style="display: flex; gap: 10px; margin-top: 12px; padding: 12px; background: #FFF3E0; border: 1px solid #FF9800; border-radius: 8px;">
              <button id="cachedCopyTitleBtn" style="flex: 1; padding: 10px; border: 1px solid #8B5E3C; border-radius: 8px; background: #fff; color: #8B5E3C; cursor: pointer; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='#8B5E3C'; this.style.color='#fff';" onmouseout="if(!this.textContent.includes('✅')) { this.style.background='#fff'; this.style.color='#8B5E3C'; }">📋 复制标题</button>
              <button id="cachedCopyContentBtn" style="flex: 1; padding: 10px; border: 1px solid #8B5E3C; border-radius: 8px; background: #fff; color: #8B5E3C; cursor: pointer; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='#8B5E3C'; this.style.color='#fff';" onmouseout="if(!this.textContent.includes('✅')) { this.style.background='#fff'; this.style.color='#8B5E3C'; }">📋 复制主楼内容</button>
            </div>
          `;
          uploadStatus.innerHTML = `<div style="color: #666; font-size: 14px;">💾 已从缓存恢复表单数据</div>` + copyButtonsHtml;
          
          // 绑定复制按钮事件
          setTimeout(() => {
            const titleBtn = document.getElementById('cachedCopyTitleBtn');
            const contentBtn = document.getElementById('cachedCopyContentBtn');
            
            if (titleBtn) {
              titleBtn.onclick = async () => {
                const title = generateThreadTitle();
                try {
                  await navigator.clipboard.writeText(title);
                  titleBtn.textContent = '✅ 已复制';
                  setTimeout(() => { titleBtn.textContent = '📋 复制标题'; }, 2000);
                } catch (err) {
                  alert('复制失败：' + err.message);
                }
              };
            }
            
            if (contentBtn) {
              contentBtn.onclick = async () => {
                const content = generatePreviewText();
                try {
                  await navigator.clipboard.writeText(content);
                  contentBtn.textContent = '✅ 已复制';
                  setTimeout(() => { contentBtn.textContent = '📋 复制主楼内容'; }, 2000);
                } catch (err) {
                  alert('复制失败：' + err.message);
                }
              };
            }
          }, 100);
        } catch (e) {
          console.error('显示缓存复制按钮失败:', e);
        }
      }
    }
    
    // 延迟执行，确保页面完全加载
    setTimeout(showCopyButtonsFromCache, 500);
    
    // === 预览中的复制按钮 ===
    // 复制标题按钮
    const copyTitleBtn = document.getElementById('copyTitleButton');
    if (copyTitleBtn) {
      copyTitleBtn.addEventListener('click', async () => {
        const title = generateThreadTitle();
        if (!title) {
          alert('请先填写帖子标题');
          return;
        }
        
        try {
          await navigator.clipboard.writeText(title);
          // 更换图标为对勾
          copyTitleBtn.classList.add('copied');
          copyTitleBtn.innerHTML = `
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
          `;
          
          // 2秒后恢复
          setTimeout(() => {
            copyTitleBtn.classList.remove('copied');
            copyTitleBtn.innerHTML = `
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
              </svg>
            `;
          }, 2000);
        } catch (err) {
          alert('复制失败：' + err.message);
        }
      });
    }
    
    // 复制内容按钮
    const copyContentBtn = document.getElementById('copyContentButton');
    if (copyContentBtn) {
      copyContentBtn.addEventListener('click', async () => {
        const content = generatePreviewText();
        if (!content) {
          alert('请先填写表单内容');
          return;
        }
        
        try {
          await navigator.clipboard.writeText(content);
          // 更换图标为对勾
          copyContentBtn.classList.add('copied');
          copyContentBtn.innerHTML = `
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
          `;
          
          // 2秒后恢复
          setTimeout(() => {
            copyContentBtn.classList.remove('copied');
            copyContentBtn.innerHTML = `
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
              </svg>
            `;
          }, 2000);
        } catch (err) {
          alert('复制失败：' + err.message);
        }
      });
    }
  });
</script>

</body>
</html>
