<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>角色卡上传</title>
  <style>
    body { font-family: sans-serif; margin: 20px; max-width: 800px; margin-left: auto; margin-right: auto; }
    .hidden { display: none; }
    form div {
      margin-bottom: 15px;
      padding: 10px;
      border-bottom: 1px solid #eee;
    }
    form label {
      display: block;
      font-weight: bold;
      margin-bottom: 5px;
    }
    input[type="text"], textarea, select {
      width: 100%;
      padding: 8px;
      box-sizing: border-box;
    }
    button {
      padding: 10px 15px;
      font-size: 16px;
      cursor: pointer;
    }
    #uploadStatus {
      font-weight: bold;
      margin-top: 15px;
      padding: 10px;
    }
  </style>
</head>
<body>

  <h1>上传你的角色卡</h1>
  <form id="uploadForm">

    <div>
      <label>卡片类型*:</label>
      <input type="radio" id="cardTypeSingle" name="cardType" value="single" checked>
      <label for="cardTypeSingle">单人卡</label>
      <input type="radio" id="cardTypeMulti" name="cardType" value="multi">
      <label for="cardTypeMulti">多人卡</label>
    </div>

    <div>
      <label for="cardName">卡名*:</label>
      <input type="text" id="cardName" name="cardName" required />
    </div>
    
    <div id="characterContainer" class="hidden">
      <label>角色名 (多人卡):</label>
      <div id="characterList">
        <input type="text" name="characters" placeholder="角色1" />
      </div>
      <button type="button" id="addCharacterBtn" style="margin-top:5px;">+ 增加角色</button>
    </div>

    <div>
      <label for="category">分区:</label>
      <input type="text" id="category" name="category" />
    </div>

    <div>
      <label>作者*:</label>
      <input type="radio" id="authorTypeReal" name="authorType" value="real" checked>
      <label for="authorTypeReal">实名</label>
      <input type="radio" id="authorTypeAnonymous" name="authorType" value="anonymous">
      <label for="authorTypeAnonymous">匿名</label>
    </div>
    <div id="authorNameContainer">
      <label for="authorName" id="authorNameLabel">作者名:</label>
      <input type="text" id="authorName" name="authorName" />
    </div>

    <div>
      <label>性向* (可多选, 至少选一):</label>
      <input type="checkbox" name="orientation" value="GB"><label>GB</label>
      <input type="checkbox" name="orientation" value="BG"><label>BG</label>
      <input type="checkbox" name="orientation" value="GL"><label>GL</label>
      <input type="checkbox" name="orientation" value="BL"><label>BL</label>
      <input type="checkbox" name="orientation" value="none"><label>无CP</label>
    </div>

    <div>
      <label for="background">背景:</label>
      <select id="background" name="background">
        <option value="modern">现代</option>
        <option value="ancient">古代</option>
        <option value="future">未来</option>
        <option value="fantasy">幻想</option>
      </select>
    </div>
    
    <div>
      <label>Tags (可多选):</label>
      <input type="checkbox" name="tags" value="campus"><label>校园</label>
      <input type="checkbox" name="tags" value="city"><label>都市</label>
      <input type="checkbox" name="tags" value="older"><label>年上</label>
      <input type="checkbox" name="tags" value="younger"><label>年下</label>
    </div>

    <div>
      <label>限制:</label>
      <input type="radio" name="userLimit" value="none" checked><label>无</label>
      <input type="radio" name="userLimit" value="female"><label>限女User</label>
      <input type="radio" name="userLimit" value="male"><label>限男User</label>
    </div>

    <div>
      <label for="warnings">排雷:</label>
      <textarea id="warnings" name="warnings"></textarea>
    </div>

    <div>
      <label for="description">简介:</label>
      <textarea id="description" name="description"></textarea>
    </div>

    <div>
      <label>下载前二次排雷:</label>
      <input type="radio" id="secWarnNo" name="secondaryWarningToggle" value="no" checked>
      <label for="secWarnNo">否</label>
      <input type="radio" id="secWarnYes" name="secondaryWarningToggle" value="yes">
      <label for="secWarnYes">是</label>
    </div>
    <div id="secondaryWarningContainer" class="hidden">
      <label for="secondaryWarning">二次排雷内容:</label>
      <textarea id="secondaryWarning" name="secondaryWarning"></textarea>
    </div>

    <div>
      <label for="galleryImages">主楼图片 (可多图):</label>
      <input type="file" id="galleryImages" name="galleryImages" multiple accept="image/*" />
    </div>

    <div>
      <label for="cardFile">角色卡* (.png / .json):</label>
      <input type="file" id="cardFile" name="cardFile" required accept=".png,.json" />
    </div>

    <div>
      <label for="attachments">其它附件 (可多图):</label>
      <input type="file" id="attachments" name="attachments" multiple />
    </div>

    <button type="submit" id="submitButton">上传</button>
  </form>

  <div id="uploadStatus"></div>

  <hr>
  <h2>已上传的卡片</h2>
  <div id="cardList">正在加载...</div>

<script>
  // --- 动态表单逻辑 ---

  // 1. 单人/多人卡 逻辑
  const characterContainer = document.getElementById('characterContainer');
  document.querySelectorAll('input[name="cardType"]').forEach(radio => {
    radio.addEventListener('change', (e) => {
      if (e.target.value === 'multi') {
        characterContainer.classList.remove('hidden');
      } else {
        characterContainer.classList.add('hidden');
      }
    });
  });

  // 2. 增加角色 按钮
  const characterList = document.getElementById('characterList');
  document.getElementById('addCharacterBtn').addEventListener('click', () => {
    const newInput = document.createElement('input');
    newInput.type = 'text';
    newInput.name = 'characters'; // 后端用 getAll("characters") 来接收
    newInput.placeholder = `角色${characterList.children.length + 1}`;
    characterList.appendChild(newInput);
  });

  // 3. 作者 逻辑
  const authorNameLabel = document.getElementById('authorNameLabel');
  const authorNameInput = document.getElementById('authorName');
  document.querySelectorAll('input[name="authorType"]').forEach(radio => {
    radio.addEventListener('change', (e) => {
      if (e.target.value === 'anonymous') {
        authorNameLabel.textContent = '马甲 (不填则默认为"匿名"):';
        authorNameInput.placeholder = '你的马甲';
      } else {
        authorNameLabel.textContent = '作者名:';
        authorNameInput.placeholder = '你的实名';
      }
    });
  });

  // 4. 二次排雷 逻辑
  const secondaryWarningContainer = document.getElementById('secondaryWarningContainer');
  document.querySelectorAll('input[name="secondaryWarningToggle"]').forEach(radio => {
    radio.addEventListener('change', (e) => {
      if (e.target.value === 'yes') {
        secondaryWarningContainer.classList.remove('hidden');
      } else {
        secondaryWarningContainer.classList.add('hidden');
        document.getElementById('secondaryWarning').value = ''; // 隐藏时清空
      }
    });
  });

  // --- 表单提交逻辑 ---
  const uploadForm = document.getElementById("uploadForm");
  const submitButton = document.getElementById("submitButton");
  const uploadStatus = document.getElementById("uploadStatus");

  uploadForm.addEventListener("submit", async function (event) {
    event.preventDefault(); // 阻止默认提交

    // 验证性向
    const orientationChecked = document.querySelector('input[name="orientation"]:checked');
    if (!orientationChecked) {
      uploadStatus.textContent = "请至少选择一个性向";
      return;
    }
    
    const cardFile = document.getElementById('cardFile').files[0];
    if (!cardFile) {
        uploadStatus.textContent = "请必须上传角色卡文件";
        return;
    }

    submitButton.disabled = true;
    submitButton.textContent = "上传中...";
    uploadStatus.textContent = "正在上传，请稍候... (大文件可能需要一些时间)";

    try {
      const formData = new FormData(uploadForm);

      if (formData.get('cardType') === 'single') {
        formData.delete('characters');
      }
      
      if (formData.get('secondaryWarningToggle') === 'no') {
        formData.delete('secondaryWarning');
      }
      formData.delete('secondaryWarningToggle');

      const response = await fetch("/api/upload", {
        method: "POST",
        body: formData,
      });

      const result = await response.json();

      if (result.success) {
        uploadStatus.textContent = result.message;
        uploadForm.reset();
        // 手动重置所有动态表单
        document.getElementById('cardTypeSingle').dispatchEvent(new Event('change'));
        document.getElementById('authorTypeReal').dispatchEvent(new Event('change'));
        document.getElementById('secWarnNo').dispatchEvent(new Event('change'));
        characterList.innerHTML = '<input type="text" name="characters" placeholder="角色1" />';
        
        // 上传成功后，重新加载列表
        loadCards(); 
      } else {
        uploadStatus.textContent = "失败: " + result.message;
      }
    } catch (error) {
      console.error("提交出错:", error);
      uploadStatus.textContent = "上传失败，请检查网络连接或控制台报错。";
    } finally {
      submitButton.disabled = false;
      submitButton.textContent = "上传";
    }
  });

  // --- 加载卡片列表逻辑 ---
  const cardListContainer = document.getElementById("cardList");

  async function loadCards() {
    try {
      const response = await fetch("/api/cards");
      const data = await response.json();

      if (data.success && data.cards.length > 0) {
        cardListContainer.innerHTML = ""; // 清空
        data.cards.forEach(card => {
          const cardElement = document.createElement("div");
          cardElement.style = "border: 1px solid #ccc; padding: 10px; margin-bottom: 10px;";
          cardElement.innerHTML = `
            <h3>${card.cardName}</h3>
            <p><strong>作者:</strong> ${card.authorName}</p>
            <p><strong>简介:</strong> ${card.description || '无'}</p>
            <p><strong>Tags:</strong> ${JSON.parse(card.tags).join(', ') || '无'}</p>
          `;
          cardListContainer.appendChild(cardElement);
        });
      } else {
        cardListContainer.textContent = "还没有人上传卡片。";
      }
    } catch (error) {
      cardListContainer.textContent = "加载卡片列表失败。";
    }
  }
  
  // 页面加载时自动运行
  document.addEventListener('DOMContentLoaded', loadCards);
</script>

</body>
</html>